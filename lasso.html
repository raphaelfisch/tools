<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAS-Beobachtungssystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a9d5b;
            --primary-dark: #3a7d4b;
            --primary-light: #e8f5e9;
            --secondary: #f5b041;
            --secondary-light: #fef3e2;
            --danger: #e74c3c;
            --danger-light: #fdeaea;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --bg: #f8f9fa;
            --white: #ffffff;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --radius: 8px;
            --radius-lg: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height für mobile Safari */
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .sidebar-header h1 {
            font-family: 'Merriweather', serif;
            font-size: 1.4rem;
            margin: 0 0 4px 0;
        }

        .sidebar-header p {
            font-size: 0.7rem;
            opacity: 0.9;
            margin: 0;
            line-height: 1.3;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 0;
            overflow-y: auto;
            min-height: 0; /* Wichtig für Flex-Overflow */
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--primary-light);
        }

        .nav-item.active {
            background: var(--primary-light);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0.7;
        }

        .nav-item.active svg {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--text-light);
            flex-shrink: 0;
            background: var(--white);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            margin-right: 24px;
            padding: 24px;
            overflow-x: hidden;
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
            color: var(--text);
        }

        /* Alert / Notification Banner */
        .alert-banner {
            background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-lg);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.01); }
        }

        .alert-banner-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .alert-banner h3 {
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .alert-banner p {
            font-size: 0.9rem;
            opacity: 0.95;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn-lg {
            padding: 14px 28px;
            font-size: 1.05rem;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Rating Buttons */
        .rating-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .rating-btn {
            flex: 1;
            min-width: 140px;
            padding: 16px 12px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            text-align: center;
        }

        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .rating-btn.rating-1 {
            background: #ffebee;
            color: #c62828;
            border-color: #ef9a9a;
        }

        .rating-btn.rating-1:hover {
            background: #ffcdd2;
        }

        .rating-btn.rating-2 {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffcc80;
        }

        .rating-btn.rating-2:hover {
            background: #ffe0b2;
        }

        .rating-btn.rating-3 {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }

        .rating-btn.rating-3:hover {
            background: #c8e6c9;
        }

        .rating-btn.rating-4 {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #90caf9;
        }

        .rating-btn.rating-4:hover {
            background: #bbdefb;
        }

        .rating-btn.rating-skip {
            background: var(--bg);
            color: var(--text-light);
            border-color: var(--border);
        }

        .rating-key {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-right: 6px;
        }

        .rating-btn.rating-skip .rating-key {
            background: rgba(0,0,0,0.08);
        }

        /* Progress */
        .progress-container {
            margin-bottom: 24px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Question Card */
        .question-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: 32px;
            margin-bottom: 20px;
        }

        .question-meta {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .question-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .question-tag.fach {
            background: var(--secondary-light);
            color: #b7791f;
        }

        .student-name {
            font-family: 'Merriweather', serif;
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin-bottom: 16px;
        }

        .indicator-text {
            font-size: 1.15rem;
            color: var(--text);
            line-height: 1.7;
            padding: 16px;
            background: var(--bg);
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Select */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }

        .form-select, .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            font-family: inherit;
            background: var(--white);
            transition: border-color 0.2s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            font-weight: 600;
            background: var(--bg);
        }

        tr:hover {
            background: var(--primary-light);
        }

        /* Stundenplan Tabelle */
        .stundenplan-table {
            width: 100%;
            table-layout: fixed;
            min-width: 400px;
        }

        .stundenplan-table th,
        .stundenplan-table td {
            text-align: center;
            padding: 14px 8px;
            font-size: 0.95rem;
        }

        .stundenplan-table th:first-child,
        .stundenplan-table td:first-child {
            text-align: center;
            width: 80px;
            font-weight: 600;
        }

        .stundenplan-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        .stundenplan-table tbody tr:hover {
            background: var(--primary-light);
        }

        /* Dashboard - Volle Breite */
        .dashboard-content {
            width: 100%;
        }

        /* Dashboard Charts Grid - 2 Spalten auf grossen Bildschirmen */
        .dashboard-charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dashboard-charts-grid .card {
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .dashboard-charts-grid {
                grid-template-columns: 1fr;
            }
            .dashboard-charts-grid .card {
                margin-bottom: 20px;
            }
        }

        /* Boxplot Container */
        .boxplot-container {
            padding: 16px 0;
            margin: 16px 0;
            overflow-x: auto;
        }

        .boxplot-row {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            gap: 12px;
            min-width: 650px;
        }

        .boxplot-row:last-of-type {
            border-bottom: none;
        }

        .boxplot-label {
            width: 240px;
            font-size: 0.95rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .boxplot-info {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-light);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .boxplot-info:hover {
            background: #0891b2;
            color: white;
        }

        .boxplot-divider {
            color: var(--text-light);
            font-size: 1.2rem;
        }

        .boxplot-chart {
            flex: 1;
            height: 32px;
            background: white;
            border-radius: 4px;
            position: relative;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .boxplot-chart:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(8, 145, 178, 0.1);
        }

        .boxplot-scale {
            flex: 1;
            display: flex;
            position: relative;
            font-size: 0.75rem;
            color: var(--text-light);
            height: 20px;
        }

        .boxplot-scale span {
            position: absolute;
            transform: translateX(-50%);
        }

        .boxplot-scale span:nth-child(1) { left: 2%; }
        .boxplot-scale span:nth-child(2) { left: 34%; }
        .boxplot-scale span:nth-child(3) { left: 66%; }
        .boxplot-scale span:nth-child(4) { left: 98%; }

        .boxplot-box {
            position: absolute;
            height: 100%;
            background: rgba(8, 145, 178, 0.15);
            border: 2px solid #0891b2;
            border-radius: 4px;
            z-index: 1;
        }

        .boxplot-median {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #0891b2;
            z-index: 2;
        }

        .boxplot-whisker {
            position: absolute;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
            background: #0891b2;
        }

        .boxplot-whisker-end {
            position: absolute;
            width: 2px;
            height: 50%;
            top: 25%;
            background: #0891b2;
            z-index: 3;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: var(--radius-lg);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        .toggle input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Screen visibility */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Responsive */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 101;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius);
            cursor: pointer;
        }

        /* Tablet Optimierung (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .sidebar {
                width: 220px;
            }

            .main-content {
                margin-left: 220px;
                margin-right: 16px;
                padding: 16px;
            }

            .sidebar-header {
                padding: 14px 16px;
            }

            .sidebar-header h1 {
                font-size: 1.1rem;
            }

            .sidebar-header p {
                font-size: 0.75rem;
            }

            .nav-item {
                padding: 10px 14px;
                font-size: 0.85rem;
            }

            .nav-item svg {
                width: 18px;
                height: 18px;
                margin-right: 10px;
            }

            .sidebar-footer {
                padding: 10px 14px;
                font-size: 0.7rem;
            }

            #pending-observations-card {
                padding: 8px !important;
            }

            #pending-observations-card div {
                font-size: 0.75rem !important;
            }

            .boxplot-label {
                width: 160px;
                font-size: 0.85rem;
            }

            .boxplot-row {
                gap: 8px;
                min-width: 550px;
            }

            .zeugnis-btn {
                padding: 3px 0;
                min-width: 32px;
                font-size: 0.8rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .card {
                padding: 16px;
            }

            .stundenplan-table th,
            .stundenplan-table td {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            .stundenplan-table th:first-child,
            .stundenplan-table td:first-child {
                width: 70px;
            }

            .dashboard-content {
                max-width: 100% !important;
            }
        }

        /* Smartphone Optimierung */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                margin-right: 0;
                padding: 16px;
                padding-top: 70px;
            }

            .mobile-menu-btn {
                display: block;
            }

            .rating-buttons {
                flex-direction: column;
            }

            .rating-btn {
                min-width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .boxplot-container {
                overflow-x: auto;
            }

            .boxplot-row {
                flex-wrap: wrap;
                gap: 8px;
                min-width: 0;
                padding: 12px;
            }

            .boxplot-label {
                width: 100%;
                font-size: 0.9rem;
                font-weight: 500;
                margin-bottom: 4px;
            }

            .boxplot-divider {
                display: none;
            }

            .boxplot-chart {
                flex: 1;
                min-width: 120px;
                order: 1;
            }

            .vorschlag-badge {
                order: 2;
            }

            .zeugnis-select {
                width: 100%;
                order: 3;
                margin-left: 0 !important;
                margin-top: 4px;
                justify-content: space-between;
            }

            .zeugnis-btn {
                flex: 1;
                min-width: 0;
            }

            .boxplot-scale {
                display: none;
            }

            .stundenplan-table th,
            .stundenplan-table td {
                padding: 8px 4px;
                font-size: 0.75rem;
            }

            .stundenplan-table th:first-child,
            .stundenplan-table td:first-child {
                width: 55px;
                font-size: 0.7rem;
            }

            .dashboard-content {
                max-width: 100% !important;
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
        }

        .toast {
            background: var(--text);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius);
            margin-top: 12px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--primary);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: var(--danger);
            color: white;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Zeugnisnote Selection */
        .zeugnis-select {
            display: flex;
            gap: 4px;
        }

        .zeugnis-btn {
            padding: 4px 0;
            min-width: 36px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: white;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: center;
        }

        .zeugnis-btn:hover {
            border-color: #0891b2;
        }

        .zeugnis-btn.selected {
            background: #0891b2;
            color: white;
            border-color: #0891b2;
        }

        /* Stundenplan Highlighting */
        .current-lesson-cell {
            background: var(--primary) !important;
            color: white !important;
            font-weight: 600;
            border-radius: var(--radius);
            animation: pulse-cell 2s infinite;
        }

        @keyframes pulse-cell {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74, 157, 91, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(74, 157, 91, 0); }
        }

        .current-day-column {
            background: var(--primary-light);
        }

        /* Test Mode */
        .test-mode-banner {
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Chip / Tag list */
        .chip-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background: var(--bg);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .chip.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>LASSO</h1>
                <p><strong>L</strong>ern-, <strong>A</strong>rbeits- und <strong>S</strong>ozialverhalten<br><strong>S</strong>ystematisch <strong>O</strong>rganisiert</p>
                <span id="demo-badge" style="display: none; background: var(--secondary); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; margin-top: 8px;">DEMO</span>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item active" data-screen="dashboard" onclick="showScreen('dashboard')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" data-screen="masterdata" onclick="showScreen('masterdata')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    Stammdaten
                </div>
                <div class="nav-item" data-screen="observe" onclick="showScreen('observe')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Beobachten
                </div>
                <div class="nav-item" data-screen="evaluation" onclick="showScreen('evaluation')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Auswertung
                </div>
                <div class="nav-item" data-screen="config" onclick="showScreen('config')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Konfiguration
                </div>
                <div class="nav-item" data-screen="demo" onclick="showScreen('demo')">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                        <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Demo
                </div>
            </nav>
            
            <!-- Noch zu erledigen in Sidebar -->
            <div id="pending-observations-card" style="display:none; padding: 12px; border-top: 1px solid var(--border); flex-shrink: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="openPendingModal()">
                    <div style="font-weight: 600; font-size: 0.85rem; color: var(--secondary);">
                        Noch zu erledigen
                    </div>
                    <div id="pending-count-badge" style="background: var(--secondary); color: white; font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 10px;">0</div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div id="test-mode-sidebar" style="display:none; background: var(--secondary); color: white; padding: 8px; border-radius: var(--radius); margin-bottom: 8px; font-weight: 600; font-size: 0.85rem;">
                    ▶ Test-Modus aktiv
                    <div id="test-time-display" style="font-weight: 400;"></div>
                </div>
                <div id="semester-info">Semester: Laden...</div>
                <div id="current-time"></div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Screen -->
            <div class="screen active" id="screen-dashboard">
                <div class="dashboard-content">
                    <!-- Semester-Info -->
                    <div id="dashboard-semester-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px 16px; background: var(--primary); color: white; border-radius: var(--radius);">
                        <div>
                            <strong id="dashboard-semester-name" style="font-size: 1.1rem;">Aktuelles Semester</strong>
                            <span id="dashboard-semester-dates" style="margin-left: 12px; opacity: 0.85; font-size: 0.9rem;"></span>
                        </div>
                        <a href="#" onclick="showScreen('config'); return false;" style="color: white; opacity: 0.85; font-size: 0.85rem; text-decoration: none;">
                            Bearbeiten →
                        </a>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Stundenplan</h2>
                        </div>
                        <div class="table-container" style="overflow-x: auto;">
                            <table id="dashboard-stundenplan" class="stundenplan-table">
                                <thead>
                                    <tr>
                                        <th>Zeit</th>
                                        <th>Mo</th>
                                        <th>Di</th>
                                        <th>Mi</th>
                                        <th>Do</th>
                                        <th>Fr</th>
                                    </tr>
                                </thead>
                                <tbody id="dashboard-stundenplan-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Fortschritt und Zeitverlauf nebeneinander -->
                    <div class="dashboard-charts-grid">
                        <!-- Fortschritt pro Fach -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Fortschritt pro Fach</h2>
                            </div>
                            <div id="fortschritt-faecher"></div>
                        </div>

                        <!-- Zeitverlauf -->
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Zeitverlauf</h2>
                            </div>
                            <div style="position: relative; height: 220px;">
                                <canvas id="zeitverlauf-chart"></canvas>
                            </div>
                            <div id="zeitverlauf-legend" style="display: flex; gap: 24px; justify-content: center; margin-top: 12px; font-size: 0.85rem; color: var(--text-light);">
                                <span><span style="display: inline-block; width: 12px; height: 12px; background: #0891b2; border-radius: 2px; margin-right: 6px;"></span>Beobachtungen</span>
                                <span><span style="display: inline-block; width: 12px; height: 12px; background: #e5e7eb; border-radius: 2px; margin-right: 6px;"></span>Ziel</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stammdaten Screen -->
            <div class="screen" id="screen-masterdata">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Stammdaten</h2>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-bottom: 16px;">
                        <div class="tab active" onclick="showMasterdataTab('faecher')">Fächer / Klassen</div>
                        <div class="tab" onclick="showMasterdataTab('schueler')">Schüler</div>
                        <div class="tab" onclick="showMasterdataTab('stundenplan')">Stundenplan</div>
                    </div>

                    <!-- Fächer Tab -->
                    <div id="masterdata-tab-faecher">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Verwalte hier deine Fächer und Klassen. Ein Fach ist die Kombination aus Unterrichtsfach und Klasse (z.B. "Mathematik 5a").
                        </p>
                        
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                            <input type="text" class="form-input" id="new-fach-name" placeholder="Fachname (z.B. Mathematik)" style="flex: 1; min-width: 120px;">
                            <input type="text" class="form-input" id="new-fach-klasse" placeholder="Klasse (z.B. 5a)" style="flex: 1; min-width: 120px;">
                            <button class="btn btn-primary" onclick="addFach()">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 4v16m8-8H4"/>
                                </svg>
                                Hinzufügen
                            </button>
                        </div>
                        
                        <div id="faecher-liste"></div>
                    </div>

                    <!-- Schüler Tab -->
                    <div id="masterdata-tab-schueler" style="display: none;">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Wähle ein Fach und verwalte die zugehörigen Schüler.
                        </p>
                        
                        <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
                            <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
                                <label class="form-label">Fach / Klasse</label>
                                <select class="form-select" id="masterdata-schueler-fach" onchange="updateSchuelerListe()">
                                    <option value="">-- Fach wählen --</option>
                                </select>
                            </div>
                            
                            <div style="border: 2px dashed var(--border); border-radius: 8px; padding: 8px 16px; display: flex; gap: 12px; align-items: center; background: var(--background);">
                                <span style="font-size: 0.85rem; color: var(--text-light);">Spalte A = Nachname, B = Vorname</span>
                                <input type="file" id="schueler-import-file" accept=".xlsx,.xls" style="display: none;" onchange="importSchuelerExcel(event)">
                                <button class="btn btn-secondary" onclick="document.getElementById('schueler-import-file').click()">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                    </svg>
                                    Excel importieren
                                </button>
                            </div>
                        </div>
                        
                        <div id="schueler-edit-container" style="display: none;">
                            <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                                <input type="text" class="form-input" id="new-schueler-vorname" placeholder="Vorname" style="flex: 1; min-width: 120px;">
                                <input type="text" class="form-input" id="new-schueler-nachname" placeholder="Nachname" style="flex: 1; min-width: 120px;">
                                <button class="btn btn-primary" onclick="addSchueler()">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M12 4v16m8-8H4"/>
                                    </svg>
                                    Hinzufügen
                                </button>
                            </div>
                            
                            <div id="schueler-liste"></div>
                        </div>
                    </div>

                    <!-- Stundenplan Tab -->
                    <div id="masterdata-tab-stundenplan" style="display: none;">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Definiere deinen Stundenplan. Klicke auf eine Zelle um ein Fach zuzuweisen.
                        </p>
                        
                        <div class="table-container" style="overflow-x: auto;">
                            <table class="stundenplan-table" id="stundenplan-edit-table">
                                <thead>
                                    <tr>
                                        <th>Zeit</th>
                                        <th>Mo</th>
                                        <th>Di</th>
                                        <th>Mi</th>
                                        <th>Do</th>
                                        <th>Fr</th>
                                        <th style="width: 40px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="stundenplan-edit-body"></tbody>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="addStundenplanZeile()">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 4v16m8-8H4"/>
                                </svg>
                                Zeile hinzufügen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Observe Screen -->
            <div class="screen" id="screen-observe">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Fach / Klasse wählen</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Für Beobachtungen zwischendurch – unabhängig vom Stundenplan. 
                        Wähle ein Fach und das System generiert automatisch Fragen zu Schülern und Kriterien, 
                        bei denen noch Beobachtungen fehlen.
                    </p>
                    <div class="form-group">
                        <label class="form-label">Fach</label>
                        <select class="form-select" id="select-fach-klasse" onchange="startObservation()">
                            <option value="">-- Bitte wählen --</option>
                        </select>
                    </div>
                </div>

                <div id="observation-container" style="display:none;">
                    <div class="progress-container">
                        <div class="progress-header">
                            <span>Frage <span id="question-number">1</span> von <span id="question-total">5</span></span>
                            <span id="session-progress">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="session-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="question-card">
                        <div class="question-meta">
                            <span class="question-tag" id="q-kriterium">L01 Lernverhalten</span>
                            <span class="question-tag fach" id="q-fach">Mathematik</span>
                        </div>
                        <div class="student-name" id="q-student">Max Mustermann</div>
                        <div class="indicator-text" id="q-indicator">
                            Bringt eigene Interessen, Ideen und Vorschläge ein
                        </div>
                        <div class="rating-buttons">
                            <button class="rating-btn rating-1" onclick="submitRating(1)">
                                1 - nicht genügend
                            </button>
                            <button class="rating-btn rating-2" onclick="submitRating(2)">
                                2 - genügend
                            </button>
                            <button class="rating-btn rating-3" onclick="submitRating(3)">
                                3 - gut
                            </button>
                            <button class="rating-btn rating-4" onclick="submitRating(4)">
                                4 - sehr gut
                            </button>
                            <button class="rating-btn rating-skip" onclick="submitRating(0)">
                                Überspringen
                            </button>
                        </div>
                    </div>
                </div>

                <div id="observation-complete" style="display:none;">
                    <div class="card" style="text-align:center; padding: 60px;">
                        <svg width="80" height="80" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin: 0 auto 20px;">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h2 style="margin-bottom: 12px;">Runde abgeschlossen!</h2>
                        <p style="color: var(--text-light); margin-bottom: 24px;">
                            Du hast <span id="completed-count">5</span> Beobachtungen erfasst.
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn btn-primary" onclick="startNewRound()">
                                Weitere Runde
                            </button>
                            <button class="btn btn-secondary" onclick="showScreen('dashboard')">
                                Zum Stundenplan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evaluation Screen -->
            <div class="screen" id="screen-evaluation">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Auswertung</h2>
                    </div>
                    
                    <!-- Tabs -->
                    <div class="tabs" style="margin-bottom: 16px;">
                        <div class="tab active" onclick="showEvalTab('einzelschueler')">Einzelschüler</div>
                        <div class="tab" onclick="showEvalTab('zeugnis')">Zeugnis-Übersicht</div>
                        <div class="tab" onclick="showEvalTab('heatmap')">Lücken</div>
                        <div class="tab" onclick="showEvalTab('archiv')">Archiv</div>
                    </div>

                    <!-- Einzelschüler Tab -->
                    <div id="eval-tab-einzelschueler">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Übersicht aller Beobachtungen pro Schüler. Die Boxplots zeigen die Verteilung der Bewertungen 
                            pro Kriterium. Hier legst du auch die definitive LAS-Beurteilung pro Fach (nicht genügend, genügend, gut, sehr gut) fest.
                        </p>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label class="form-label">Fach / Klasse</label>
                                <select class="form-select" id="eval-fach-klasse" onchange="updateEvaluation()">
                                    <option value="">-- Fach wählen --</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label class="form-label">Schüler/in</label>
                                <select class="form-select" id="eval-student" onchange="updateEvaluation()">
                                    <option value="">-- Schüler wählen --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Zeugnis-Übersicht Tab (NEU) -->
                    <div id="eval-tab-zeugnis" style="display: none;">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Alle Schüler und Kriterien auf einen Blick – perfekt für die Zeugniszeit. Zeigt den Median aller Beobachtungen pro Kriterium.
                        </p>
                        <div class="form-group" style="max-width: 300px;">
                            <label class="form-label">Fach / Klasse</label>
                            <select class="form-select" id="zeugnis-fach" onchange="updateZeugnisMatrix()">
                                <option value="">-- Fach wählen --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Heatmap/Lücken Tab -->
                    <div id="eval-tab-heatmap" style="display: none;">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Heatmap zeigt auf einen Blick, wo noch Beobachtungen fehlen. Klicke auf Spaltenköpfe zum Sortieren.
                        </p>
                        <div class="form-group" style="max-width: 300px;">
                            <label class="form-label">Fach / Klasse</label>
                            <select class="form-select" id="heatmap-fach" onchange="updateHeatmap()">
                                <option value="">-- Fach wählen --</option>
                            </select>
                        </div>
                        <!-- Hidden select für Sortier-Logik -->
                        <select id="heatmap-sort" style="display: none;">
                            <option value="nachname">Nach Nachname</option>
                            <option value="vorname">Nach Vorname</option>
                            <option value="beobachtungen">Nach Anzahl Beobachtungen</option>
                            <option value="luecken">Nach Lücken (meiste zuerst)</option>
                        </select>
                    </div>

                    <!-- Archiv Tab -->
                    <div id="eval-tab-archiv" style="display: none;">
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Hier findest du abgeschlossene Semester. Die Daten sind schreibgeschützt archiviert.
                        </p>
                        
                        <!-- Aktuelles Semester abschliessen -->
                        <div style="background: var(--bg); border-radius: var(--radius); padding: 16px; margin-bottom: 20px; border: 1px solid var(--border);">
                            <h4 style="margin-bottom: 8px;">Aktuelles Semester abschliessen</h4>
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 12px;">
                                Archiviert alle Beobachtungen und Zeugnisnoten. Das aktuelle Semester wird zurückgesetzt für den neuen Start.
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: end;">
                                <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                    <label class="form-label">Bezeichnung</label>
                                    <input type="text" class="form-input" id="archive-name" placeholder="z.B. Herbstsemester 2024/25">
                                </div>
                                <button class="btn btn-primary" onclick="archiveSemester()">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-right: 6px;">
                                        <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                                    </svg>
                                    Archivieren
                                </button>
                            </div>
                        </div>
                        
                        <!-- Archiv-Liste -->
                        <div id="archive-list"></div>
                    </div>
                </div>

                <!-- Einzelschüler Content -->
                <div id="evaluation-content">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        <h3>Noch keine Daten</h3>
                        <p>Erfasse zuerst einige Beobachtungen.</p>
                    </div>
                </div>

                <!-- Heatmap Content -->
                <div id="heatmap-content" style="display: none;">
                    <div class="card">
                        <div class="heatmap-container" style="overflow-x: auto;">
                            <div id="heatmap-grid"></div>
                        </div>
                        <div id="heatmap-legend" style="display: flex; gap: 16px; justify-content: center; margin-top: 16px; font-size: 0.85rem; flex-wrap: wrap;">
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>0 Beob.</span>
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #fef3c7; border: 1px solid #fde68a; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>1-2 Beob.</span>
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #d1fae5; border: 1px solid #a7f3d0; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>3+ Beob.</span>
                        </div>
                    </div>
                </div>

                <!-- Zeugnis-Matrix Content -->
                <div id="zeugnis-content" style="display: none;">
                    <div class="card">
                        <div class="table-container" style="overflow-x: auto;">
                            <div id="zeugnis-matrix"></div>
                        </div>
                        <div id="zeugnis-legend" style="display: flex; gap: 16px; justify-content: center; margin-top: 16px; font-size: 0.85rem; flex-wrap: wrap;">
                            <span><span style="display: inline-block; width: 24px; height: 16px; background: #16a34a; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>sehr gut</span>
                            <span><span style="display: inline-block; width: 24px; height: 16px; background: #84cc16; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>gut</span>
                            <span><span style="display: inline-block; width: 24px; height: 16px; background: #f59e0b; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>genügend</span>
                            <span><span style="display: inline-block; width: 24px; height: 16px; background: #ef4444; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>nicht genügend</span>
                            <span><span style="display: inline-block; width: 24px; height: 16px; background: #e5e7eb; border-radius: 3px; vertical-align: middle; margin-right: 6px;"></span>keine Daten</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Screen -->
            <div class="screen" id="screen-config">
                <div class="tabs">
                    <div class="tab active" onclick="showConfigTab('semester')">Semester</div>
                    <div class="tab" onclick="showConfigTab('kriterien')">LAS-Kriterien</div>
                    <div class="tab" onclick="showConfigTab('daten')">Daten-Backup</div>
                </div>

                <div id="config-semester" class="config-tab">
                    <!-- Zeitraum -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Aktuelles Semester</h2>
                        </div>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Definiere das aktuelle Semester. Die Bezeichnung wird im Dashboard angezeigt.
                        </p>
                        <div class="form-group" style="margin-bottom: 16px;">
                            <label class="form-label">Bezeichnung</label>
                            <input type="text" class="form-input" id="config-semester-name" placeholder="z.B. Frühlingssemester 2025" onchange="saveSemesterConfig()" style="max-width: 350px;">
                        </div>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label class="form-label">Semester-Start</label>
                                <input type="date" class="form-input" id="config-semester-start" onchange="saveSemesterConfig()">
                            </div>
                            <div class="form-group" style="flex: 1; min-width: 200px;">
                                <label class="form-label">Semester-Ende</label>
                                <input type="date" class="form-input" id="config-semester-end" onchange="saveSemesterConfig()">
                            </div>
                        </div>
                    </div>

                    <!-- Ferien -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Ferien</h2>
                        </div>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Während der Ferien werden keine Beobachtungs-Erinnerungen angezeigt.
                        </p>
                        <div id="ferien-list"></div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: end; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                                <label class="form-label">Bezeichnung</label>
                                <input type="text" class="form-input" id="ferien-name" placeholder="z.B. Herbstferien">
                            </div>
                            <div class="form-group" style="min-width: 140px; margin-bottom: 0;">
                                <label class="form-label">Von</label>
                                <input type="date" class="form-input" id="ferien-start">
                            </div>
                            <div class="form-group" style="min-width: 140px; margin-bottom: 0;">
                                <label class="form-label">Bis</label>
                                <input type="date" class="form-input" id="ferien-end">
                            </div>
                            <button class="btn btn-primary" onclick="addFerien()" style="margin-bottom: 0;">Hinzufügen</button>
                        </div>
                        
                        <!-- Import von Kanton -->
                        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: end;">
                                <div class="form-group" style="min-width: 200px; margin-bottom: 0;">
                                    <label class="form-label">Ferien importieren</label>
                                    <select class="form-select" id="import-kanton">
                                        <option value="">-- Kanton wählen --</option>
                                        <option value="CH-AG">Aargau</option>
                                        <option value="CH-AR">Appenzell Ausserrhoden</option>
                                        <option value="CH-AI">Appenzell Innerrhoden</option>
                                        <option value="CH-BL">Basel-Landschaft</option>
                                        <option value="CH-BS">Basel-Stadt</option>
                                        <option value="CH-BE">Bern</option>
                                        <option value="CH-FR">Freiburg</option>
                                        <option value="CH-GE">Genf</option>
                                        <option value="CH-GL">Glarus</option>
                                        <option value="CH-GR">Graubünden</option>
                                        <option value="CH-JU">Jura</option>
                                        <option value="CH-LU">Luzern</option>
                                        <option value="CH-NE">Neuenburg</option>
                                        <option value="CH-NW">Nidwalden</option>
                                        <option value="CH-OW">Obwalden</option>
                                        <option value="CH-SH">Schaffhausen</option>
                                        <option value="CH-SZ">Schwyz</option>
                                        <option value="CH-SO">Solothurn</option>
                                        <option value="CH-SG">St. Gallen</option>
                                        <option value="CH-TI">Tessin</option>
                                        <option value="CH-TG">Thurgau</option>
                                        <option value="CH-UR">Uri</option>
                                        <option value="CH-VD">Waadt</option>
                                        <option value="CH-VS">Wallis</option>
                                        <option value="CH-ZG">Zug</option>
                                        <option value="CH-ZH">Zürich</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="importFerienFromAPI()" style="margin-bottom: 0;">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-right: 6px;">
                                        <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/>
                                    </svg>
                                    Importieren
                                </button>
                            </div>
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 8px;">
                                Lädt Schulferien automatisch von <a href="https://www.openholidaysapi.org" target="_blank" style="color: var(--primary);">OpenHolidays API</a> (kostenlos, Open Data).
                            </p>
                        </div>
                    </div>

                    <!-- Erinnerung -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Erinnerungen</h2>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-light);">
                            Du entscheidest, wann und wie du an Beobachtungen erinnert wirst. Das System sammelt Vorschläge – du arbeitest sie ab, wann es für dich passt.
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Wann soll die Erinnerung erscheinen?</label>
                            <select class="form-select" id="config-reminder-timing" onchange="saveSemesterConfig()" style="max-width: 350px;">
                                <optgroup label="Während der Lektion">
                                    <option value="end-5">5 Minuten vor Lektionsende</option>
                                    <option value="end-10">10 Minuten vor Lektionsende</option>
                                    <option value="end-15">15 Minuten vor Lektionsende</option>
                                    <option value="start">Am Anfang der Lektion</option>
                                    <option value="middle">In der Mitte der Lektion</option>
                                </optgroup>
                                <optgroup label="In Pausen">
                                    <option value="pause-10">In der 10-Uhr-Pause</option>
                                    <option value="pause-lunch">In der Mittagspause</option>
                                </optgroup>
                                <optgroup label="Am Tagesende">
                                    <option value="day-end">Nach der letzten Lektion</option>
                                </optgroup>
                                <optgroup label="Manuell">
                                    <option value="manual">Nie automatisch (nur «Noch zu erledigen»)</option>
                                </optgroup>
                            </select>
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Bei "Manuell" sammelst du Beobachtungen über «Noch zu erledigen» und arbeitest sie ab, wann du Zeit hast.
                            </p>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Wie lange sollen offene Beobachtungen gespeichert bleiben?</label>
                            <select class="form-select" id="config-pending-retention" onchange="saveSemesterConfig()" style="max-width: 350px;">
                                <option value="next-lesson">Bis zur nächsten Lektion (dann neue Vorschläge)</option>
                                <option value="day-end">Bis Tagesende</option>
                                <option value="days-3">3 Tage</option>
                                <option value="days-7">1 Woche</option>
                                <option value="unlimited">Unbegrenzt (ich hake manuell ab)</option>
                            </select>
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Bei "Unbegrenzt" bleiben alle offenen Beobachtungen in der Liste, bis du sie erledigst oder manuell löschst.
                            </p>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--background); border-radius: var(--radius); border: 1px solid var(--border); max-width: 350px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0; flex: 1;">
                                    <input type="checkbox" id="config-reminder-sound" checked onchange="saveSemesterConfig()" style="width: 18px; height: 18px;">
                                    <span style="font-size: 1rem;">Ton abspielen bei Erinnerung</span>
                                </label>
                                <button type="button" class="btn btn-secondary" style="padding: 4px 10px; font-size: 0.85rem;" onclick="playTestSound()">Test</button>
                            </div>
                        </div>
                    </div>

                    <!-- Beobachtungs-Einstellungen -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Beobachtungen</h2>
                        </div>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Wie viele Beobachtungen sollen pro Semester erfasst werden?
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">Ziel-Beobachtungen pro Schüler und Kriterium</label>
                            <input type="number" class="form-input" id="config-target" value="3" min="1" max="10" style="width: 100px;" onchange="saveSemesterConfig()">
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Empfehlung: 2-3 Beobachtungen für eine fundierte Beurteilung
                            </p>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">Fragen pro Runde</label>
                            <input type="number" class="form-input" id="config-questions-per-round" value="13" min="1" max="50" style="width: 100px;" onchange="saveSemesterConfig()">
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Wie viele Fragen pro Beobachtungsrunde? Minimum für dieses Semester: <strong><span id="min-questions-display">-</span></strong>
                            </p>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">Max. Fragen pro Schüler pro Runde</label>
                            <input type="number" class="form-input" id="config-max-per-student" value="3" min="1" max="10" style="width: 100px;" onchange="saveSemesterConfig()">
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Verhindert, dass ein Schüler zu oft hintereinander beobachtet wird
                            </p>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">Priorisierung</label>
                            <div style="margin-top: 8px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="config-prioritize-gaps" checked onchange="saveSemesterConfig()">
                                    <span>Lücken zuerst füllen</span>
                                </label>
                                <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                    Wenn aktiviert, werden Schüler/Kriterien mit fehlenden Beobachtungen bevorzugt
                                </p>
                            </div>
                        </div>

                        <!-- Aufklappbare Erklärung -->
                        <details style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 16px;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4m0-4h.01"/>
                                </svg>
                                So funktioniert die Schülerauswahl
                            </summary>
                            <div style="margin-top: 16px; padding: 16px; background: var(--background); border-radius: var(--radius); font-size: 0.9rem; line-height: 1.6;">
                                <p style="margin: 0 0 12px 0;"><strong>Ziel:</strong> Jeder Schüler soll am Ende des Semesters für jedes Kriterium genügend Beobachtungen haben – für eine fundierte Zeugnis-Beurteilung.</p>
                                
                                <p style="margin: 0 0 8px 0;"><strong>Die Logik dahinter:</strong></p>
                                <ul style="margin: 0 0 12px 0; padding-left: 20px;">
                                    <li style="margin-bottom: 6px;"><strong>Lücken füllen:</strong> Schüler mit den wenigsten Beobachtungen kommen zuerst dran. So wird niemand vergessen.</li>
                                    <li style="margin-bottom: 6px;"><strong>Kriterien abwechseln:</strong> Für jeden Schüler wird ein Kriterium gewählt, bei dem noch Beobachtungen fehlen. Über Zeit werden alle 12 Kriterien abgedeckt.</li>
                                    <li style="margin-bottom: 6px;"><strong>Abwechslung:</strong> Ein Schüler kommt pro Runde maximal X-mal dran (einstellbar). So bleibt es natürlich und nicht repetitiv.</li>
                                </ul>
                                
                                <p style="margin: 0 0 8px 0;"><strong>Im Dashboard siehst du:</strong></p>
                                <ul style="margin: 0; padding-left: 20px;">
                                    <li style="margin-bottom: 6px;"><span style="color: var(--success); font-weight: 600;">Grüne Zahl:</span> Schüler mit genügend Beobachtungen</li>
                                    <li style="margin-bottom: 6px;"><span style="color: var(--danger); font-weight: 600;">Rote Zahl:</span> Schüler mit Lücken – diese werden priorisiert</li>
                                    <li><strong>Boxplots:</strong> Zeigen die Verteilung pro Kriterium auf einen Blick</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>

                <div id="config-kriterien" class="config-tab" style="display:none;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">LAS-Kriterien und Indikatoren</h2>
                        </div>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Aktiviere/deaktiviere Kriterien und passe die Indikatoren an. Klicke auf ein Kriterium um die Indikatoren zu sehen und anzupassen.
                        </p>
                        <div id="kriterien-list"></div>
                    </div>
                </div>

                <!-- Daten-Backup Tab -->
                <div id="config-daten" class="config-tab" style="display:none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <!-- Export -->
                        <div class="card" style="margin-bottom: 0;">
                            <div class="card-header">
                                <h2 class="card-title">Backup erstellen</h2>
                            </div>
                            <p style="margin-bottom: 16px; color: var(--text-light);">
                                Exportiere alle Daten als JSON-Datei. Enthält Schüler, Fächer, Stundenplan, Beobachtungen, Zeugnisnoten und Archiv.
                            </p>
                            <button class="btn btn-primary" onclick="exportData()">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Backup herunterladen
                            </button>
                        </div>

                        <!-- Import -->
                        <div class="card" style="margin-bottom: 0;">
                            <div class="card-header">
                                <h2 class="card-title">Backup wiederherstellen</h2>
                            </div>
                            <p style="margin-bottom: 16px; color: var(--text-light);">
                                Importiere eine zuvor exportierte JSON-Datei. <strong style="color: var(--danger);">Achtung:</strong> Dies überschreibt alle aktuellen Daten!
                            </p>
                            <input type="file" id="import-file-config" accept=".json" style="display:none;" onchange="importData(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('import-file-config').click()">
                                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                </svg>
                                Backup laden
                            </button>
                        </div>
                    </div>

                    <!-- Statistik -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <h2 class="card-title">Aktuelle Daten</h2>
                        </div>
                        <div id="backup-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px;"></div>
                    </div>

                    <!-- Zurücksetzen -->
                    <div class="card" style="margin-top: 20px; border-color: var(--danger);">
                        <div class="card-header">
                            <h2 class="card-title" style="color: var(--danger);">Alle Daten löschen</h2>
                        </div>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Löscht alle Daten unwiderruflich. Dies kann nicht rückgängig gemacht werden!
                        </p>
                        <button class="btn" style="background: var(--danger); color: white;" onclick="resetAllData()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Alle Daten löschen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Demo Screen -->
            <div class="screen" id="screen-demo">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Demo-Daten</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Lade Demo-Klassen und Schüler, um das System auszuprobieren.
                    </p>
                    <button class="btn btn-primary" onclick="loadDemoData()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Demo-Klassen und Schüler laden
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Demo-Beobachtungen</h2>
                    </div>
                    <p style="margin-bottom: 12px; color: var(--text-light);">
                        Generiere zufällige Beobachtungen, um die Auswertung zu testen.
                    </p>
                    <p style="margin-bottom: 16px; font-size: 0.95rem;">
                        <strong>Aktuelle Beobachtungen:</strong> <span id="demo-observation-count">0</span>
                    </p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="generateDemoData(100)">
                            +100 Beobachtungen
                        </button>
                        <button class="btn btn-secondary" onclick="generateDemoData(500)">
                            +500 Beobachtungen
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Test-Modus: Zeit simulieren</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Simuliere einen bestimmten Wochentag und Uhrzeit, um die Stundenplan-Erkennung zu testen.
                    </p>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Wochentag</label>
                            <select class="form-select" id="test-day" style="width: 150px;">
                                <option value="">-- Echtzeit --</option>
                                <option value="1">Montag</option>
                                <option value="2">Dienstag</option>
                                <option value="3">Mittwoch</option>
                                <option value="4">Donnerstag</option>
                                <option value="5">Freitag</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Startzeit</label>
                            <input type="time" class="form-input" id="test-time" style="width: 130px;">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Geschwindigkeit</label>
                            <select class="form-select" id="test-speed" style="width: 100px;">
                                <option value="1">1×</option>
                                <option value="2">2×</option>
                                <option value="5">5×</option>
                                <option value="10">10×</option>
                                <option value="30">30×</option>
                                <option value="60">60×</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="applyTestTime()">Starten</button>
                        <button class="btn btn-secondary" onclick="resetTestTime()">Zurücksetzen</button>
                    </div>
                    <div id="test-mode-status" style="margin-top: 12px;"></div>
                </div>

                <div class="card" style="border-color: var(--danger);">
                    <div class="card-header">
                        <h2 class="card-title" style="color: var(--danger);">Zurücksetzen</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Lösche alle Daten und starte neu. Diese Aktion kann nicht rückgängig gemacht werden!
                    </p>
                    <button class="btn" style="background: var(--danger); color: white;" onclick="resetAllData()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Alle Daten löschen und neu starten
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Onboarding Screen -->
    <div id="onboarding-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
        <div style="max-width: 600px; margin: 60px auto; padding: 24px;">
            <div style="background: #e8e8e8; border-radius: 16px; padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h1 style="font-size: 2.5rem; color: var(--primary); margin-bottom: 8px;">LASSO</h1>
                    <p style="font-size: 0.95rem; color: var(--text-light);"><strong>L</strong>ern-, <strong>A</strong>rbeits- und <strong>S</strong>ozialverhalten<br><strong>S</strong>ystematisch <strong>O</strong>rganisiert</p>
                </div>
                
                <div style="display: grid; gap: 16px;">
                    <div class="card" style="margin: 0;">
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="margin-bottom: 12px;">Willkommen!</h2>
                            <p style="color: var(--text-light); margin-bottom: 24px;">
                                Mit diesem Tool kannst du das Lern-, Arbeits- und Sozialverhalten deiner Schülerinnen und Schüler systematisch beobachten und auswerten.
                            </p>
                            <p style="color: var(--text-light); margin: 0;">
                                Wie möchtest du starten?
                            </p>
                        </div>
                    </div>
                    
                    <div class="card" style="margin: 0; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" onclick="startWithDemo()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="background: var(--primary-light); border-radius: 12px; padding: 16px; flex-shrink: 0;">
                                <svg width="32" height="32" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 4px;">Demo ausprobieren</h3>
                                <p style="color: var(--text-light); font-size: 0.9rem; margin: 0;">
                                    Starte mit Beispiel-Klassen und Schülern, um die Funktionen kennenzulernen.
                                </p>
                            </div>
                            <svg width="24" height="24" fill="none" stroke="var(--text-light)" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div class="card" style="margin: 0; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" onclick="startEmpty()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='transparent'">
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="background: var(--background); border-radius: 12px; padding: 16px; flex-shrink: 0; border: 1px solid var(--border);">
                                <svg width="32" height="32" fill="none" stroke="var(--text)" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 4v16m8-8H4"/>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin-bottom: 4px;">Eigene Klassen einrichten</h3>
                                <p style="color: var(--text-light); font-size: 0.9rem; margin: 0;">
                                    Richte deine eigenen Fächer und Schülerlisten ein.
                                </p>
                            </div>
                            <svg width="24" height="24" fill="none" stroke="var(--text-light)" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Detailansicht</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>

    <!-- Beobachtungs-Modal -->
    <div class="modal-overlay" id="observation-modal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span id="obs-modal-fach">Beobachtung</span>
                </h3>
                <button class="modal-close" onclick="closeObservationModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <div class="progress-container" style="padding: 16px 24px; background: var(--bg); margin: 0;">
                    <div class="progress-header">
                        <span>Frage <span id="obs-question-number">1</span> von <span id="obs-question-total">5</span></span>
                        <span id="obs-session-progress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="obs-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <div style="padding: 24px;">
                    <div class="question-meta" style="margin-bottom: 12px;">
                        <span class="question-tag" id="obs-kriterium">L01 Lernverhalten</span>
                    </div>
                    <div class="student-name" id="obs-student">Max Mustermann</div>
                    <div class="indicator-text" id="obs-indicator">
                        Bringt eigene Interessen, Ideen und Vorschläge ein
                    </div>
                    <div class="rating-buttons">
                        <button class="rating-btn rating-1" onclick="submitModalRating(1)">
                            <span class="rating-key">1</span> – nicht genügend
                        </button>
                        <button class="rating-btn rating-2" onclick="submitModalRating(2)">
                            <span class="rating-key">2</span> = genügend
                        </button>
                        <button class="rating-btn rating-3" onclick="submitModalRating(3)">
                            <span class="rating-key">3</span> + gut
                        </button>
                        <button class="rating-btn rating-4" onclick="submitModalRating(4)">
                            <span class="rating-key">4</span> ++ sehr gut
                        </button>
                        <button class="rating-btn rating-skip" onclick="submitModalRating(0)">
                            <span class="rating-key">0</span> Überspringen
                        </button>
                    </div>
                    <p style="text-align: center; font-size: 0.8rem; color: var(--text-light); margin-top: 12px;">
                        Tastatur: 1-4 für Bewertung, 0 = Überspringen, Esc = Schliessen
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Beobachtung-Abgeschlossen Modal -->
    <div class="modal-overlay" id="observation-complete-modal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-body" style="padding: 40px;">
                <svg width="60" height="60" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin-bottom: 16px;">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <h2 style="margin-bottom: 8px;">Runde abgeschlossen!</h2>
                <p style="color: var(--text-light); margin-bottom: 24px;">
                    Du hast <span id="obs-completed-count">5</span> Beobachtungen erfasst.
                </p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button class="btn btn-primary" onclick="startNewObservationRound()">
                        Weitere Runde
                    </button>
                    <button class="btn btn-secondary" onclick="closeObservationCompleteModal()">
                        Fertig
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending-Modal -->
    <div class="modal-overlay" id="pending-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Noch zu erledigen</h3>
                <button class="modal-close" onclick="closePendingModal()">&times;</button>
            </div>
            <div class="modal-body" id="pending-modal-body" style="max-height: 400px; overflow-y: auto;">
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn btn-secondary" style="color: var(--danger);" onclick="clearAllPending()">Alle löschen</button>
                <button class="btn btn-secondary" onclick="closePendingModal()">Schliessen</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- SheetJS für Excel-Import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ========================================
        // DATA STRUCTURES
        // ========================================
        
        const KRITERIEN = [
            { id: 'L01', bereich: 'Lernverhalten', name: 'beteiligt sich aktiv am Unterricht' },
            { id: 'L02', bereich: 'Lernverhalten', name: 'konzentriert sich auf eine Aufgabe' },
            { id: 'L03', bereich: 'Lernverhalten', name: 'entwickelt sinnvolle Lösungen' },
            { id: 'A04', bereich: 'Arbeitsverhalten', name: 'arbeitet ausdauernd' },
            { id: 'A05', bereich: 'Arbeitsverhalten', name: 'führt Arbeiten selbständig aus' },
            { id: 'A06', bereich: 'Arbeitsverhalten', name: 'gestaltet Arbeiten sorgfältig' },
            { id: 'A07', bereich: 'Arbeitsverhalten', name: 'führt Arbeiten zuverlässig aus' },
            { id: 'A08', bereich: 'Arbeitsverhalten', name: 'geht konstruktiv mit Rückmeldungen um' },
            { id: 'A09', bereich: 'Arbeitsverhalten', name: 'arbeitet in angemessenem Tempo' },
            { id: 'S10', bereich: 'Sozialverhalten', name: 'arbeitet mit andern konstruktiv zusammen' },
            { id: 'S11', bereich: 'Sozialverhalten', name: 'begegnet Mitmenschen respektvoll' },
            { id: 'S12', bereich: 'Sozialverhalten', name: 'hält sich an Abmachungen und Regeln' }
        ];

        const INDIKATOREN = {
            'L01': [
                'Bringt eigene Interessen, Ideen und Vorschläge ein',
                'Stellt Fragen, die Neugierde erkennen lassen',
                'Gestaltet Lernprozesse aktiv mit',
                'Traut sich etwas zu',
                'Nutzt die eigenen Fähigkeiten',
                'Arbeitet aus eigenem Antrieb'
            ],
            'L02': [
                'Erledigt eigenverantwortlich Hausaufgaben',
                'Bereitet sich auf Lernkontrollen vor',
                'Setzt Strategien ein, um eine Aufgabe auch bei Widerständen zu Ende zu führen',
                'Lässt sich kaum von Aufgaben ablenken',
                'Passt im Unterricht gut auf'
            ],
            'L03': [
                'Fragt nach Ursachen eines Problems, bevor Lösungen genannt werden',
                'Erkennt und nennt verschiedene Aspekte eines Problems',
                'Verschafft sich Informationen, schätzt sie ein und verarbeitet sie',
                'Bezieht Kenntnisse aus verschiedenen Fachbereichen ein',
                'Überträgt eigene Erfahrungen auf Problemstellungen im Unterricht',
                'Hat kreative Einfälle zum Thema',
                'Entwickelt realisierbare Lösungsvorschläge',
                'Berücksichtigt mögliche Konsequenzen und Folgen einer Entscheidung',
                'Erprobt neue Herangehensweisen und variiert Methoden'
            ],
            'A04': [
                'Kann sich über längere Zeit mit einem Lerngegenstand beschäftigen',
                'Beendet angefangene Arbeiten',
                'Gibt nicht auf, wenn sich nicht sofort Erfolg einstellt',
                'Lässt sich nicht ablenken',
                'Berücksichtigt in der Zeitplanung die Anforderungen der Aufgabe',
                'Arbeitet auch dann weiter, wenn eine Arbeit nicht so interessiert',
                'Ist erst zufrieden, wenn die Arbeit gut gemacht ist'
            ],
            'A05': [
                'Setzt sich realistische Ziele',
                'Schätzt eigene Leistungen realistisch ein',
                'Kann selbständig und strukturiert planen',
                'Kann Arbeitsschritte ohne ständige Bestätigung der Lehrperson umsetzen',
                'Kann der Situation entsprechend entscheiden und handeln',
                'Besorgt sich fehlende Informationen und benötigte Hilfsmittel',
                'Probiert aus, bevor um Hilfe gebeten wird',
                'Kontrolliert eigene Arbeiten und nimmt Verbesserungen vor',
                'Setzt sich mit dem eigenen Lernverhalten auseinander'
            ],
            'A06': [
                'Arbeitsblätter und Hefte sind übersichtlich und verständlich dargestellt',
                'Geht mit Materialien, Werkzeugen und Geräten sorgfältig um',
                'Arbeitet sauber'
            ],
            'A07': [
                'Orientiert sich am Ziel der Aufgabe',
                'Hält sich an vereinbarte Zeiten',
                'Hat die Schulmaterialien dabei',
                'Hat die Hausaufgaben erledigt',
                'Hält Termine bei Arbeitsaufträgen ein',
                'Andere können sich auf Zusagen verlassen',
                'Überprüft eigene Arbeitsergebnisse und optimiert sie'
            ],
            'A08': [
                'Kann Misserfolge verarbeiten',
                'Kann bei Kritik zuhören und mit Anregungen konstruktiv umgehen',
                'Ist in der Lage, Fehler zuzugeben',
                'Vermag Argumente für und gegen eine Sache einzubeziehen',
                'Kann Leistungen und eigenes Verhalten einschätzen',
                'Betrachtet kritische Rückmeldungen als Unterstützung zur Verbesserung'
            ],
            'A09': [
                'Richtet sich den Arbeitsplatz sinnvoll ein',
                'Beginnt sofort mit der Arbeit',
                'Arbeitet mit wenig Unterbrechung',
                'Passt das Arbeitstempo den eigenen Fähigkeiten an',
                'Erledigt die Arbeiten mit angemessenem Zeitaufwand',
                'Kommt bei der Arbeit zügig voran'
            ],
            'S10': [
                'Beteiligt sich aktiv an der Zusammenarbeit mit anderen',
                'Hört aufmerksam zu',
                'Nimmt Meldungen und Standpunkte von anderen wahr und bezieht sie ein',
                'Stellt eigene Interessen zugunsten der Gruppe zurück oder setzt sich durch',
                'Gibt sich bei der Planung von Gruppenarbeiten aktiv ein',
                'Trägt dazu bei, Arbeiten zusammen mit anderen gut zu lösen'
            ],
            'S11': [
                'Nimmt Menschen in ihren Gemeinsamkeiten und Differenzen wahr',
                'Geht taktvoll mit Menschen um',
                'Achtet auf einen wertschätzenden Sprachgebrauch',
                'Erkennt herabwürdigenden Sprachgebrauch und nimmt ihn nicht passiv hin',
                'Benimmt sich gegenüber Erwachsenen anständig',
                'Benimmt sich gegenüber anderen Schülern anständig',
                'Bleibt auch bei schlechter Laune anderen gegenüber anständig'
            ],
            'S12': [
                'Verhält sich regelkonform',
                'Hält sich an die Vereinbarungen der Gruppe, Klasse und Schule',
                'Kommt den persönlichen Pflichten nach',
                'Akzeptiert faire Lösungen und setzt diese um',
                'Stört den Unterricht nicht',
                'Hört zu, wenn andere sprechen',
                'Lässt andere ausreden',
                'Trägt zu einem friedlichen Zusammenleben bei'
            ]
        };

        const DEFAULT_FAECHER = [
            { id: 'erg-1d', name: 'ERG', klasse: '1d', schuelerIds: [] },
            { id: 'nt-1d', name: 'NT', klasse: '1d', schuelerIds: [] },
            { id: 'nt-1c', name: 'NT', klasse: '1c', schuelerIds: [] },
            { id: 'el-1cd', name: 'EL', klasse: '1c+1d', schuelerIds: [] },
            { id: 'mi-1cd', name: 'MI', klasse: '1c/1d', schuelerIds: [] },
            { id: 'mathe-1sek', name: 'Mathe', klasse: '1. Sek', schuelerIds: [] },
            { id: 'mathe-3sek', name: 'Mathe', klasse: '3. Sek', schuelerIds: [] },
            { id: 'icdl-3kl', name: 'ICDL', klasse: '3. Klasse', schuelerIds: [] }
        ];

        const DEFAULT_STUNDENPLAN = [
            { lektion: 1, zeit: '07:25-08:10', mo: 'erg-1d', di: null, mi: 'el-1cd', do: null, fr: 'mathe-1sek' },
            { lektion: 2, zeit: '08:15-09:00', mo: 'nt-1d', di: 'mathe-3sek', mi: 'el-1cd', do: null, fr: 'mathe-1sek' },
            { lektion: 3, zeit: '09:05-09:50', mo: 'el-1cd', di: 'nt-1d', mi: null, do: null, fr: null },
            { lektion: 4, zeit: '10:15-11:00', mo: 'el-1cd', di: 'mi-1cd', mi: 'mathe-1sek', do: null, fr: 'nt-1c' },
            { lektion: 5, zeit: '11:05-11:50', mo: 'mathe-3sek', di: 'mi-1cd', mi: 'mathe-3sek', do: 'mathe-3sek', fr: 'mathe-3sek' },
            { lektion: 6, zeit: '11:50-12:35', mo: null, di: null, mi: null, do: null, fr: null },
            { lektion: 7, zeit: '12:35-13:20', mo: null, di: null, mi: null, do: null, fr: null },
            { lektion: 8, zeit: '13:30-14:15', mo: null, di: 'mathe-1sek', mi: null, do: 'mathe-1sek', fr: null },
            { lektion: 9, zeit: '14:20-15:05', mo: null, di: 'nt-1c', mi: null, do: 'mathe-1sek', fr: null },
            { lektion: 10, zeit: '15:10-15:55', mo: null, di: null, mi: null, do: 'icdl-3kl', fr: null },
            { lektion: 11, zeit: '16:00-16:45', mo: null, di: null, mi: null, do: null, fr: null }
        ];

        // Fiktive Schülernamen mit Vielfalt
        const VORNAMEN_CH = ['Luca', 'Noah', 'Leon', 'Liam', 'Elias', 'Gabriel', 'Louis', 'David', 'Samuel', 'Julian', 'Mia', 'Emma', 'Sofia', 'Emilia', 'Lena', 'Anna', 'Laura', 'Lea', 'Elena', 'Nina'];
        const VORNAMEN_INTERNATIONAL = ['Aleksandar', 'Driton', 'Erion', 'Blerim', 'Fatmir', 'Arben', 'Besnik', 'Mehmet', 'Kemal', 'Yusuf', 'Ahmed', 'Omar', 'Amir', 'Hassan', 'Ali', 'Fatima', 'Amira', 'Leyla', 'Zeynep', 'Aylin', 'Sara', 'Mira', 'Dina', 'Selina', 'Alina', 'Liridona', 'Albina', 'Teuta', 'Vjosa', 'Ardiana', 'Diego', 'Marco', 'Alessandro', 'Matteo', 'Lorenzo', 'Giulia', 'Chiara', 'Valentina', 'Alessia', 'Francesca', 'Miguel', 'Carlos', 'João', 'Pedro', 'Ana', 'Maria', 'Beatriz', 'Inês', 'Wei', 'Chen', 'Li', 'Mei', 'Yuki', 'Hana', 'Priya', 'Ananya', 'Rohan', 'Arjun'];
        const NACHNAMEN_CH = ['Müller', 'Meier', 'Schmid', 'Keller', 'Weber', 'Huber', 'Schneider', 'Meyer', 'Steiner', 'Fischer', 'Gerber', 'Brunner', 'Baumann', 'Frei', 'Zimmermann', 'Moser', 'Widmer', 'Wyss', 'Graf', 'Roth'];
        const NACHNAMEN_INTERNATIONAL = ['Berisha', 'Krasniqi', 'Gashi', 'Hoxha', 'Shala', 'Rama', 'Bytyqi', 'Ymeri', 'Salihu', 'Hasani', 'Yilmaz', 'Demir', 'Kaya', 'Celik', 'Özdemir', 'Rossi', 'Russo', 'Ferrari', 'Esposito', 'Bianchi', 'Silva', 'Santos', 'Ferreira', 'Oliveira', 'Rodrigues', 'Garcia', 'Martinez', 'Lopez', 'Gonzalez', 'Rodriguez', 'Chen', 'Wang', 'Li', 'Zhang', 'Liu', 'Nguyen', 'Tran', 'Patel', 'Singh', 'Kumar', 'Jovanović', 'Petrović', 'Nikolić', 'Marković', 'Đorđević'];

        // ========================================
        // STATE
        // ========================================

        let state = {
            semester: {
                name: '',                      // z.B. "Frühlingssemester 2025"
                start: '2025-08-11',
                end: '2026-01-23',
                targetObservations: 3,
                questionsPerRound: 13,
                reminderTiming: 'end-5',      // end-5, end-10, end-15, start, middle, pause-10, pause-lunch, day-end, manual
                reminderSound: true,           // Benachrichtigungston
                pendingRetention: 'day-end',   // next-lesson, day-end, days-3, days-7, unlimited
                maxQuestionsPerStudent: 3,     // Max Fragen pro Schüler pro Runde
                prioritizeGaps: true           // Lücken zuerst füllen
            },
            isDemo: false,  // Demo-Modus aktiv?
            ferien: [],  // [{id: '...', name: 'Herbstferien', start: '2025-10-05', end: '2025-10-19'}, ...]
            faecher: [],
            schueler: [],
            stundenplan: [],
            kriterienEnabled: {},
            faecherEnabled: {},
            indikatorenEnabled: {},    // { 'L01': { 0: true, 1: false, ... } }
            customIndikatoren: {},     // { 'L01': ['Eigener Indikator 1', ...], ... }
            beobachtungen: [],
            zeugnisNoten: {},
            pendingLessons: [], // Verpasste Lektionen
            archive: []  // Archivierte Semester
        };

        // Current observation session
        let currentSession = {
            fachId: null,
            questions: [],
            currentIndex: 0,
            completed: 0
        };

        // Test mode for simulating date/time
        let testMode = {
            active: false,
            day: null,  // 1=Mo, 2=Di, etc.
            time: null,  // "HH:MM"
            speed: 1,
            startRealTime: null,
            startSimTime: null,
            intervalId: null
        };

        // ========================================
        // INITIALIZATION
        // ========================================

        function init() {
            loadState();
            
            // Prüfen ob Daten vorhanden - sonst Onboarding zeigen
            if (state.schueler.length === 0 && state.faecher.length === 0) {
                showOnboarding();
                return;
            }
            
            // Setze questionsPerRound auf Minimum falls nicht vorhanden
            if (!state.semester.questionsPerRound) {
                state.semester.questionsPerRound = calculateMinQuestionsPerLesson();
                saveState();
            }
            
            updateUI();
            updateDemoBadge();
            updateClock();
            setInterval(updateClock, 60000);
        }

        function showOnboarding() {
            document.getElementById('onboarding-overlay').style.display = 'block';
        }

        function hideOnboarding() {
            document.getElementById('onboarding-overlay').style.display = 'none';
        }

        function startWithDemo() {
            state.isDemo = true;
            generateInitialData();
            saveState();
            hideOnboarding();
            updateUI();
            updateDemoBadge();
            updateClock();
            setInterval(updateClock, 60000);
            showToast('Demo-Daten geladen', 'success');
        }

        function startEmpty() {
            state.isDemo = false;
            // Leere Struktur, aber Kriterien aktivieren
            KRITERIEN.forEach(k => {
                state.kriterienEnabled[k.id] = true;
            });
            saveState();
            hideOnboarding();
            updateUI();
            updateDemoBadge();
            updateClock();
            setInterval(updateClock, 60000);
            showScreen('masterdata');
            showToast('Richte jetzt deine Klassen ein', 'success');
        }

        function loadDemoData() {
            if (state.schueler.length > 0 || state.beobachtungen.length > 0) {
                if (!confirm('Achtung: Alle vorhandenen Daten werden überschrieben!\n\nFortfahren?')) {
                    return;
                }
            }
            
            // State zurücksetzen
            state.faecher = [];
            state.schueler = [];
            state.stundenplan = [];
            state.beobachtungen = [];
            state.zeugnisNoten = {};
            state.pendingLessons = [];
            state.faecherEnabled = {};
            state.isDemo = true;
            
            generateInitialData();
            saveState();
            updateUI();
            updateDemoBadge();
            showToast('Demo-Daten geladen', 'success');
        }

        function resetAllData() {
            if (!confirm('Achtung: ALLE Daten werden unwiderruflich gelöscht!\n\nDies umfasst:\n- Alle Fächer und Klassen\n- Alle Schüler\n- Alle Beobachtungen\n- Alle Einstellungen\n\nFortfahren?')) {
                return;
            }
            
            localStorage.removeItem('las-state');
            location.reload();
        }

        function updateDemoBadge() {
            const badge = document.getElementById('demo-badge');
            if (badge) {
                badge.style.display = state.isDemo ? 'inline-flex' : 'none';
            }
        }

        function loadState() {
            const saved = localStorage.getItem('las-state');
            if (saved) {
                const loaded = JSON.parse(saved);
                
                // Validierung: Prüfen ob die Datenstruktur existiert (kann leer sein)
                const isValid = loaded.schueler !== undefined && 
                                loaded.faecher !== undefined &&
                                loaded.semester !== undefined;
                
                if (isValid) {
                    state = loaded;
                    
                    // Fehlende Properties initialisieren (für ältere States)
                    if (!state.pendingLessons) state.pendingLessons = [];
                    if (!state.semester.questionsPerRound) state.semester.questionsPerRound = 13;
                    
                    // Neue Einstellungen mit Defaults initialisieren
                    if (state.semester.name === undefined) state.semester.name = '';
                    if (!state.semester.reminderTiming) state.semester.reminderTiming = 'end-5';
                    if (state.semester.reminderSound === undefined) state.semester.reminderSound = true;
                    if (!state.semester.pendingRetention) state.semester.pendingRetention = 'day-end';
                    if (!state.semester.maxQuestionsPerStudent) state.semester.maxQuestionsPerStudent = 3;
                    if (state.semester.prioritizeGaps === undefined) state.semester.prioritizeGaps = true;
                    
                    // Indikatoren-Verwaltung initialisieren
                    if (!state.indikatorenEnabled) state.indikatorenEnabled = {};
                    if (!state.customIndikatoren) state.customIndikatoren = {};
                    
                    // Ferien initialisieren
                    if (!state.ferien) state.ferien = [];
                    
                    // Archiv initialisieren
                    if (!state.archive) state.archive = [];
                    
                    // Demo-Flag initialisieren
                    if (state.isDemo === undefined) state.isDemo = false;
                    
                    console.log('State geladen:', state.schueler.length, 'Schüler,', state.faecher.length, 'Fächer', state.isDemo ? '(Demo)' : '');
                } else {
                    console.warn('Gespeicherte Daten ungültig, zeige Onboarding');
                    localStorage.removeItem('las-state');
                }
            }
        }

        function saveState() {
            localStorage.setItem('las-state', JSON.stringify(state));
        }

        function generateInitialData() {
            // Generate base class students
            const schueler1c = generateSchuelerList(17, '1c');
            const schueler1d = generateSchuelerList(18, '1d');
            const schueler3Sek = generateSchuelerList(19, '3sek');
            
            // Mathe 1. Sek: 4 aus 1c + 4 aus 1d + 7 neue aus 1a/1b
            const mathe1SekAus1c = schueler1c.slice(0, 4);
            const mathe1SekAus1d = schueler1d.slice(0, 4);
            const schueler1ab = generateSchuelerList(7, '1ab'); // Nur Mathe bei dir
            
            // ICDL: 3 aus 3. Sek + 3 neue
            const icdlAus3Sek = schueler3Sek.slice(0, 3);
            const schuelerICDLNeu = generateSchuelerList(3, 'icdl-other');

            // Alle Schüler sammeln (keine Duplikate, da IDs eindeutig)
            state.schueler = [
                ...schueler1c, 
                ...schueler1d, 
                ...schueler1ab,
                ...schueler3Sek, 
                ...schuelerICDLNeu
            ];

            // Setup Fächer with student IDs
            state.faecher = DEFAULT_FAECHER.map(f => {
                let schuelerIds = [];
                switch(f.id) {
                    case 'erg-1d': 
                    case 'nt-1d':
                        schuelerIds = schueler1d.map(s => s.id);
                        break;
                    case 'nt-1c':
                        schuelerIds = schueler1c.map(s => s.id);
                        break;
                    case 'el-1cd':
                        schuelerIds = [...schueler1c, ...schueler1d].map(s => s.id);
                        break;
                    case 'mi-1cd':
                        // MI alterniert zwischen 1c und 1d, aber beide Klassen werden separat beurteilt
                        schuelerIds = [...schueler1c, ...schueler1d].map(s => s.id);
                        break;
                    case 'mathe-1sek':
                        // 4 aus 1c + 4 aus 1d + 7 aus 1a/1b
                        schuelerIds = [
                            ...mathe1SekAus1c.map(s => s.id),
                            ...mathe1SekAus1d.map(s => s.id),
                            ...schueler1ab.map(s => s.id)
                        ];
                        break;
                    case 'mathe-3sek':
                        schuelerIds = schueler3Sek.map(s => s.id);
                        break;
                    case 'icdl-3kl':
                        // 3 aus 3. Sek + 3 neue
                        schuelerIds = [
                            ...icdlAus3Sek.map(s => s.id),
                            ...schuelerICDLNeu.map(s => s.id)
                        ];
                        break;
                }
                return { ...f, schuelerIds };
            });

            state.stundenplan = DEFAULT_STUNDENPLAN;

            // Enable all Kriterien
            KRITERIEN.forEach(k => {
                state.kriterienEnabled[k.id] = true;
            });

            // Enable all Fächer
            state.faecher.forEach(f => {
                state.faecherEnabled[f.id] = true;
            });

            saveState();
        }

        function generateSchuelerList(count, gruppe) {
            const schueler = [];
            const allVornamen = [...VORNAMEN_CH, ...VORNAMEN_INTERNATIONAL];
            const allNachnamen = [...NACHNAMEN_CH, ...NACHNAMEN_INTERNATIONAL];
            
            for (let i = 0; i < count; i++) {
                const vorname = allVornamen[Math.floor(Math.random() * allVornamen.length)];
                const nachname = allNachnamen[Math.floor(Math.random() * allNachnamen.length)];
                schueler.push({
                    id: `${gruppe}-${i}`,
                    vorname,
                    nachname,
                    gruppe
                });
            }
            return schueler;
        }

        // ========================================
        // UI UPDATES
        // ========================================

        function updateUI() {
            updateStats();
            updateFachSelects();
            updateDashboard();
            updateKriterienList();
            updateFaecherList();
            updateSemesterConfig();
            updateDemoObservationCount();
        }

        function updateDemoObservationCount() {
            const countElement = document.getElementById('demo-observation-count');
            if (countElement) {
                countElement.textContent = state.beobachtungen.length;
            }
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('de-CH', {
                weekday: 'long',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const semesterStart = new Date(state.semester.start);
            const semesterEnd = new Date(state.semester.end);
            document.getElementById('semester-info').textContent = 
                `Semester: ${semesterStart.toLocaleDateString('de-CH')} - ${semesterEnd.toLocaleDateString('de-CH')}`;

            checkCurrentLesson();
        }

        function updateStats() {
            // Wird aufgerufen nach Änderungen, aktualisiert Dashboard
            updateDashboard();
        }

        function calculateTargetObservations() {
            let total = 0;
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
            
            state.faecher.forEach(fach => {
                if (state.faecherEnabled[fach.id]) {
                    total += fach.schuelerIds.length * enabledKriterien.length * state.semester.targetObservations;
                }
            });
            return total;
        }

        function updateDashboard() {
            // Update Semester-Info
            const semesterName = state.semester.name || 'Aktuelles Semester';
            const startDate = state.semester.start ? new Date(state.semester.start).toLocaleDateString('de-CH') : '';
            const endDate = state.semester.end ? new Date(state.semester.end).toLocaleDateString('de-CH') : '';
            const datesStr = startDate && endDate ? `${startDate} – ${endDate}` : '';
            
            document.getElementById('dashboard-semester-name').textContent = semesterName;
            document.getElementById('dashboard-semester-dates').textContent = datesStr;
            
            // Verstecke Info-Box wenn kein Name gesetzt
            const infoBox = document.getElementById('dashboard-semester-info');
            if (infoBox) {
                infoBox.style.display = state.semester.name ? 'flex' : 'none';
            }
            
            // Update dashboard timetable
            updateDashboardStundenplan();
            
            // Update pending list
            updatePendingList();
            
            // Update Grafiken
            updateFortschrittFaecher();
            updateZeitverlauf();

            // Keine Erinnerungen während der Ferien
            if (isInFerien()) {
                alertFachId = null;
                return;
            }

            // Prüfe ob wir am Ende einer Lektion sind
            const lessonEndInfo = getLessonEndInfo();
            
            if (lessonEndInfo && state.faecherEnabled[lessonEndInfo.id]) {
                // Prüfe ob diese Lektion heute schon in pending ist
                const today = new Date().toDateString();
                const alreadyPending = state.pendingLessons.some(p => 
                    p.fachId === lessonEndInfo.id && 
                    p.date === today &&
                    p.lektionIndex === lessonEndInfo.lektionIndex
                );
                
                if (!alreadyPending && alertFachId !== lessonEndInfo.id) {
                    // Neue Lektion zu pending hinzufügen
                    alertFachId = lessonEndInfo.id; // Merken um Duplikate zu vermeiden
                    
                    // Benachrichtigungston abspielen
                    playNotificationSound();
                    
                    state.pendingLessons.push({
                        fachId: lessonEndInfo.id,
                        fachName: lessonEndInfo.name,
                        fachKlasse: lessonEndInfo.klasse,
                        lektionIndex: lessonEndInfo.lektionIndex,
                        date: today,
                        timestamp: Date.now()
                    });
                    saveState();
                    updatePendingList();
                }
            } else {
                // Nicht mehr am Lektionsende - Reset
                alertFachId = null;
            }
        }

        function moveAlertToPending(fachInfo) {
            // Nicht mehr benötigt, aber für Kompatibilität behalten
        }

        function updatePendingList() {
            const card = document.getElementById('pending-observations-card');
            const badge = document.getElementById('pending-count-badge');
            
            // Retention-Filter basierend auf Einstellung
            const retention = state.semester.pendingRetention || 'day-end';
            const now = new Date();
            
            if (retention !== 'unlimited') {
                state.pendingLessons = state.pendingLessons.filter(p => {
                    if (!p.timestamp) return true; // Alte Einträge ohne Timestamp behalten
                    
                    const pendingDate = new Date(p.timestamp);
                    const diffMs = now - pendingDate;
                    const diffHours = diffMs / (1000 * 60 * 60);
                    const diffDays = diffMs / (1000 * 60 * 60 * 24);
                    
                    switch (retention) {
                        case 'next-lesson':
                            // Wird in checkCurrentLesson gehandelt
                            return true;
                        case 'day-end':
                            // Behalte nur Einträge von heute
                            return pendingDate.toDateString() === now.toDateString();
                        case 'days-3':
                            return diffDays < 3;
                        case 'days-7':
                            return diffDays < 7;
                        default:
                            return true;
                    }
                });
                saveState();
            }
            
            if (state.pendingLessons.length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            badge.textContent = state.pendingLessons.length;
        }

        function openPendingModal() {
            const body = document.getElementById('pending-modal-body');
            
            if (state.pendingLessons.length === 0) {
                body.innerHTML = '<p style="color: var(--text-light);">Keine offenen Beobachtungen.</p>';
            } else {
                const today = new Date().toDateString();
                let html = '';
                state.pendingLessons.forEach((pending, index) => {
                    // Zeige Datum nur wenn nicht heute
                    const pendingDate = pending.timestamp ? new Date(pending.timestamp) : null;
                    const isToday = pendingDate && pendingDate.toDateString() === today;
                    const dateStr = pendingDate && !isToday 
                        ? `<span style="font-size: 0.75rem; color: var(--text-light); margin-left: 8px;">${pendingDate.toLocaleDateString('de-CH')}</span>` 
                        : '';
                    
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: var(--radius); margin-bottom: 8px;">
                            <div>
                                <strong>${pending.fachName} ${pending.fachKlasse}</strong>${dateStr}
                                <div style="font-size: 0.85rem; color: var(--text-light);">Lektion ${pending.lektionIndex}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-primary btn-sm" onclick="observePending(${index}); closePendingModal();">Jetzt</button>
                                <button class="btn btn-secondary btn-sm" onclick="dismissPending(${index})">×</button>
                            </div>
                        </div>
                    `;
                });
                body.innerHTML = html;
            }
            
            document.getElementById('pending-modal').classList.add('active');
        }

        function closePendingModal() {
            document.getElementById('pending-modal').classList.remove('active');
        }

        function observePending(index) {
            const pending = state.pendingLessons[index];
            if (!pending) return;
            
            const fach = state.faecher.find(f => f.id === pending.fachId);
            if (!fach) return;
            
            // Starte Beobachtung für dieses Fach
            const questionsCount = state.semester.questionsPerRound || calculateMinQuestionsPerLesson();
            currentSession.fachId = fach.id;
            currentSession.questions = generateQuestions(fach.id, questionsCount);
            currentSession.currentIndex = 0;
            currentSession.completed = 0;

            if (currentSession.questions.length === 0) {
                showToast('Keine Fragen verfügbar', 'error');
                return;
            }

            document.getElementById('obs-modal-fach').textContent = `${fach.name} ${fach.klasse}`;
            document.getElementById('obs-question-total').textContent = currentSession.questions.length;
            
            // Entferne aus pending
            state.pendingLessons.splice(index, 1);
            saveState();
            updatePendingList();
            
            showModalQuestion();
            document.getElementById('observation-modal').classList.add('active');
        }

        function dismissPending(index) {
            state.pendingLessons.splice(index, 1);
            saveState();
            updatePendingList();
            
            // Modal neu rendern falls offen
            if (document.getElementById('pending-modal').classList.contains('active')) {
                openPendingModal();
            }
            
            showToast('Verworfen', 'success');
        }

        function clearAllPending() {
            if (state.pendingLessons.length === 0) return;
            
            if (!confirm(`${state.pendingLessons.length} offene Beobachtungen löschen?`)) return;
            
            state.pendingLessons = [];
            saveState();
            updatePendingList();
            closePendingModal();
            showToast('Alle offenen Beobachtungen gelöscht', 'success');
        }

        function calculateGaps() {
            const gaps = [];
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);

            state.faecher.forEach(fach => {
                if (!state.faecherEnabled[fach.id]) return;

                fach.schuelerIds.forEach(schuelerId => {
                    enabledKriterien.forEach(krit => {
                        const count = state.beobachtungen.filter(b => 
                            b.schuelerId === schuelerId && 
                            b.fachId === fach.id && 
                            b.kriteriumId === krit.id
                        ).length;

                        if (count < state.semester.targetObservations) {
                            gaps.push({
                                schuelerId,
                                fachId: fach.id,
                                kriteriumId: krit.id,
                                count
                            });
                        }
                    });
                });
            });

            // Sort by count (ascending) - least observations first
            gaps.sort((a, b) => a.count - b.count);
            return gaps;
        }

        function getCurrentFach() {
            let day, currentTime;
            
            if (testMode.active) {
                day = testMode.day;
                const [h, m] = testMode.time.split(':').map(Number);
                currentTime = h * 60 + m;
            } else {
                const now = new Date();
                day = now.getDay(); // 0=Sun, 1=Mon, ...
                currentTime = now.getHours() * 60 + now.getMinutes();
            }
            
            const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
            const dayKey = dayMap[day];
            
            if (!dayKey) return null;

            for (const lektion of state.stundenplan) {
                const [start, end] = lektion.zeit.split('-');
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                const startTime = startH * 60 + startM;
                const endTime = endH * 60 + endM;

                if (currentTime >= startTime && currentTime <= endTime) {
                    const fachId = lektion[dayKey];
                    if (fachId) {
                        return { 
                            ...state.faecher.find(f => f.id === fachId),
                            lektionIndex: lektion.lektion,
                            dayKey: dayKey
                        };
                    }
                }
            }
            return null;
        }

        // Prüft ob wir im konfigurierten Zeitfenster für Beobachtungen sind
        function getLessonEndInfo() {
            const timing = state.semester.reminderTiming || 'end-5';
            
            // Bei "manual" keine automatischen Erinnerungen
            if (timing === 'manual') {
                return null;
            }
            
            let day, currentTime;
            
            if (testMode.active) {
                day = testMode.day;
                const [h, m] = testMode.time.split(':').map(Number);
                currentTime = h * 60 + m;
            } else {
                const now = new Date();
                day = now.getDay();
                currentTime = now.getHours() * 60 + now.getMinutes();
            }
            
            const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
            const dayKey = dayMap[day];
            
            if (!dayKey) return null;

            // Pausen- und Tagesend-Optionen
            if (timing === 'pause-10' || timing === 'pause-lunch' || timing === 'day-end') {
                return getLessonInfoForPauseOrDayEnd(timing, dayKey, currentTime);
            }

            // Standard-Optionen: während der Lektion
            for (const lektion of state.stundenplan) {
                const [start, end] = lektion.zeit.split('-');
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                const startTime = startH * 60 + startM;
                const endTime = endH * 60 + endM;
                const duration = endTime - startTime;

                // Berechne Zeitfenster basierend auf Konfiguration
                let windowStart, windowEnd;
                
                if (timing === 'start') {
                    // Am Anfang: erste 5 Minuten
                    windowStart = startTime;
                    windowEnd = startTime + 5;
                } else if (timing === 'middle') {
                    // In der Mitte: 2.5 Minuten vor und nach der Mitte
                    const middle = startTime + Math.floor(duration / 2);
                    windowStart = middle - 3;
                    windowEnd = middle + 3;
                } else {
                    // end-5, end-10, end-15: X Minuten vor Ende
                    const minutesBefore = parseInt(timing.split('-')[1]) || 5;
                    windowStart = endTime - minutesBefore;
                    windowEnd = endTime;
                }
                
                if (currentTime >= windowStart && currentTime <= windowEnd) {
                    const fachId = lektion[dayKey];
                    if (fachId) {
                        const fach = state.faecher.find(f => f.id === fachId);
                        if (fach) {
                            return { 
                                ...fach,
                                lektionIndex: lektion.lektion,
                                dayKey: dayKey,
                                endTime: endTime
                            };
                        }
                    }
                }
            }
            return null;
        }

        // Hilfsfunktion für Pausen- und Tagesend-Erinnerungen
        function getLessonInfoForPauseOrDayEnd(timing, dayKey, currentTime) {
            // Finde alle Lektionen des Tages
            const todayLessons = state.stundenplan
                .filter(l => l[dayKey] && state.faecherEnabled[l[dayKey]])
                .map(l => {
                    const [start, end] = l.zeit.split('-');
                    const [endH, endM] = end.split(':').map(Number);
                    return {
                        ...l,
                        fachId: l[dayKey],
                        endTime: endH * 60 + endM
                    };
                })
                .sort((a, b) => a.endTime - b.endTime);
            
            if (todayLessons.length === 0) return null;
            
            // Zeitfenster für Erinnerungen definieren
            let reminderWindow = null;
            
            if (timing === 'pause-10') {
                // 10-Uhr-Pause: typischerweise 09:50 - 10:15 (590-615 Minuten)
                reminderWindow = { start: 9 * 60 + 50, end: 10 * 60 + 15 };
            } else if (timing === 'pause-lunch') {
                // Mittagspause: typischerweise 11:50 - 13:30 (710-810 Minuten)
                reminderWindow = { start: 11 * 60 + 50, end: 13 * 60 + 30 };
            } else if (timing === 'day-end') {
                // Nach der letzten Lektion: 5 Minuten Fenster nach Ende
                const lastLesson = todayLessons[todayLessons.length - 1];
                reminderWindow = { start: lastLesson.endTime, end: lastLesson.endTime + 30 };
            }
            
            if (!reminderWindow) return null;
            
            // Prüfe ob wir im Erinnerungs-Zeitfenster sind
            if (currentTime >= reminderWindow.start && currentTime <= reminderWindow.end) {
                // Finde Lektionen, die VOR diesem Zeitfenster enden und noch nicht erinnert wurden
                const lessonsToRemind = todayLessons.filter(l => l.endTime <= reminderWindow.start);
                
                // Nimm die erste noch nicht erinnerte Lektion
                for (const lesson of lessonsToRemind) {
                    const fach = state.faecher.find(f => f.id === lesson.fachId);
                    if (fach) {
                        return {
                            ...fach,
                            lektionIndex: lesson.lektion,
                            dayKey: dayKey,
                            endTime: lesson.endTime
                        };
                    }
                }
            }
            
            return null;
        }

        // Alert-Tracking Variable
        let alertFachId = null;

        function getCurrentDayKey() {
            if (testMode.active) {
                const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
                return dayMap[testMode.day];
            }
            const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
            return dayMap[new Date().getDay()];
        }

        function getCurrentLektionIndex() {
            let currentTime;
            if (testMode.active) {
                const [h, m] = testMode.time.split(':').map(Number);
                currentTime = h * 60 + m;
            } else {
                const now = new Date();
                currentTime = now.getHours() * 60 + now.getMinutes();
            }

            for (const lektion of state.stundenplan) {
                const [start, end] = lektion.zeit.split('-');
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                const startTime = startH * 60 + startM;
                const endTime = endH * 60 + endM;

                if (currentTime >= startTime && currentTime <= endTime) {
                    return lektion.lektion;
                }
            }
            return null;
        }

        function updateDashboardStundenplan() {
            const tbody = document.getElementById('dashboard-stundenplan-body');
            const currentDayKey = getCurrentDayKey();
            const currentLektionIndex = getCurrentLektionIndex();

            let html = '';
            const days = ['mo', 'di', 'mi', 'do', 'fr'];

            state.stundenplan.forEach(lektion => {
                html += '<tr>';
                html += `<td style="font-weight: 600; white-space: nowrap;">${lektion.zeit}</td>`;
                
                days.forEach(day => {
                    const fachId = lektion[day];
                    const isCurrentDay = day === currentDayKey;
                    const isCurrentLektion = lektion.lektion === currentLektionIndex;
                    const isCurrentCell = isCurrentDay && isCurrentLektion && fachId;
                    
                    let cellClass = '';
                    if (isCurrentCell) {
                        cellClass = 'current-lesson-cell';
                    } else if (isCurrentDay) {
                        cellClass = 'current-day-column';
                    }
                    
                    const fachDisplay = fachId ? getFachDisplayShort(fachId) : '-';
                    html += `<td class="${cellClass}">${fachDisplay}</td>`;
                });
                
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function getFachDisplayShort(fachId) {
            if (!fachId) return '-';
            const fach = state.faecher.find(f => f.id === fachId);
            return fach ? `${fach.name} ${fach.klasse}` : '-';
        }

        // ========================================
        // GRAFIKEN - FORTSCHRITT & ZEITVERLAUF
        // ========================================

        function updateFortschrittFaecher() {
            const container = document.getElementById('fortschritt-faecher');
            if (!container) return;
            
            const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id] !== false);
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            const target = state.semester.targetObservations || 3;
            
            let html = '';
            
            enabledFaecher.forEach(fach => {
                // Berechne Ziel und Ist
                const totalTarget = fach.schuelerIds.length * enabledKriterien.length * target;
                const actual = state.beobachtungen.filter(b => b.fachId === fach.id).length;
                const percentage = totalTarget > 0 ? Math.min(100, Math.round((actual / totalTarget) * 100)) : 0;
                
                // Farbe basierend auf Fortschritt
                let color = '#ef4444'; // Rot
                if (percentage >= 100) color = '#22c55e'; // Grün
                else if (percentage >= 66) color = '#0891b2'; // Türkis
                else if (percentage >= 33) color = '#f59e0b'; // Orange
                
                html += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <span style="font-weight: 500;">${fach.name} ${fach.klasse}</span>
                            <span style="font-size: 0.85rem; color: var(--text-light);">${actual} / ${totalTarget} (${percentage}%)</span>
                        </div>
                        <div style="background: var(--background); border-radius: 4px; height: 12px; overflow: hidden;">
                            <div style="background: ${color}; width: ${percentage}%; height: 100%; border-radius: 4px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="color: var(--text-light);">Keine Fächer aktiviert.</p>';
            }
            
            container.innerHTML = html;
        }

        function updateZeitverlauf() {
            const canvas = document.getElementById('zeitverlauf-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            // Canvas Grösse anpassen
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            const width = canvas.width;
            const height = canvas.height;
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Clear
            ctx.clearRect(0, 0, width, height);
            
            // Daten vorbereiten: Beobachtungen pro Woche
            const semesterStart = new Date(state.semester.start);
            const semesterEnd = new Date(state.semester.end);
            const today = new Date();
            
            // OPTIMIERUNG: Beobachtungen einmal nach Kalenderwoche gruppieren
            const beobachtungenProWoche = {};
            state.beobachtungen.forEach(b => {
                const date = new Date(b.timestamp);
                // Kalenderwoche berechnen (Jahr + Woche)
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                const weekNum = Math.ceil(((date - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                const key = `${date.getFullYear()}-${weekNum}`;
                beobachtungenProWoche[key] = (beobachtungenProWoche[key] || 0) + 1;
            });
            
            // Wochen berechnen
            const weeks = [];
            let currentWeek = new Date(semesterStart);
            currentWeek.setDate(currentWeek.getDate() - currentWeek.getDay() + 1); // Montag der Woche
            
            while (currentWeek <= semesterEnd && weeks.length < 52) { // Max 52 Wochen
                const weekEnd = new Date(currentWeek);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                // Kalenderwoche-Key berechnen
                const startOfYear = new Date(currentWeek.getFullYear(), 0, 1);
                const weekNum = Math.ceil(((currentWeek - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
                const key = `${currentWeek.getFullYear()}-${weekNum}`;
                
                weeks.push({
                    start: new Date(currentWeek),
                    count: beobachtungenProWoche[key] || 0,
                    isPast: weekEnd < today
                });
                
                currentWeek.setDate(currentWeek.getDate() + 7);
            }
            
            if (weeks.length === 0) return;
            
            // Ziel berechnen (gecached)
            const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id] !== false);
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            const target = state.semester.targetObservations || 3;
            let totalTarget = 0;
            enabledFaecher.forEach(f => {
                totalTarget += f.schuelerIds.length * enabledKriterien.length * target;
            });
            
            const targetPerWeek = weeks.length > 0 ? totalTarget / weeks.length : 0;
            
            // Max Wert für Y-Achse
            const maxCount = Math.max(...weeks.map(w => w.count), targetPerWeek, 10);
            
            // Y-Achse zeichnen
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, height - padding.bottom);
            ctx.lineTo(width - padding.right, height - padding.bottom);
            ctx.stroke();
            
            // Y-Achsen-Beschriftung
            ctx.fillStyle = '#6b7280';
            ctx.font = '11px system-ui';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight * (4 - i) / 4);
                const value = Math.round(maxCount * i / 4);
                ctx.fillText(value.toString(), padding.left - 8, y + 4);
                
                // Hilfslinien
                ctx.strokeStyle = '#f3f4f6';
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
            }
            
            // Ziel-Linie (gestrichelt)
            const targetY = padding.top + chartHeight - (targetPerWeek / maxCount * chartHeight);
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding.left, targetY);
            ctx.lineTo(width - padding.right, targetY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Balken zeichnen
            const barWidth = Math.max(8, (chartWidth / weeks.length) - 4);
            
            weeks.forEach((week, i) => {
                const x = padding.left + (i * chartWidth / weeks.length) + (chartWidth / weeks.length - barWidth) / 2;
                const barHeight = (week.count / maxCount) * chartHeight;
                const y = height - padding.bottom - barHeight;
                
                // Balken
                ctx.fillStyle = week.isPast ? '#0891b2' : '#a5f3fc';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // X-Achsen-Beschriftung (nur jede 2. Woche)
                if (i % 2 === 0 || weeks.length <= 10) {
                    ctx.fillStyle = '#6b7280';
                    ctx.font = '10px system-ui';
                    ctx.textAlign = 'center';
                    const weekLabel = `W${i + 1}`;
                    ctx.fillText(weekLabel, x + barWidth / 2, height - padding.bottom + 15);
                }
            });
        }

        // ========================================
        // GRAFIKEN - HEATMAP
        // ========================================

        function showEvalTab(tabName) {
            // Tabs umschalten
            document.querySelectorAll('#screen-evaluation .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Tab-Header umschalten
            document.getElementById('eval-tab-einzelschueler').style.display = tabName === 'einzelschueler' ? 'block' : 'none';
            document.getElementById('eval-tab-zeugnis').style.display = tabName === 'zeugnis' ? 'block' : 'none';
            document.getElementById('eval-tab-heatmap').style.display = tabName === 'heatmap' ? 'block' : 'none';
            document.getElementById('eval-tab-archiv').style.display = tabName === 'archiv' ? 'block' : 'none';
            
            // Content umschalten
            document.getElementById('evaluation-content').style.display = tabName === 'einzelschueler' ? 'block' : 'none';
            document.getElementById('zeugnis-content').style.display = tabName === 'zeugnis' ? 'block' : 'none';
            document.getElementById('heatmap-content').style.display = tabName === 'heatmap' ? 'block' : 'none';
            
            // Zeugnis-Matrix Dropdown füllen
            if (tabName === 'zeugnis') {
                const select = document.getElementById('zeugnis-fach');
                if (select.options.length <= 1) {
                    state.faecher.forEach(f => {
                        if (state.faecherEnabled[f.id] !== false) {
                            const opt = document.createElement('option');
                            opt.value = f.id;
                            opt.textContent = `${f.name} ${f.klasse}`;
                            select.appendChild(opt);
                        }
                    });
                }
            }
            
            // Heatmap Dropdown füllen
            if (tabName === 'heatmap') {
                const select = document.getElementById('heatmap-fach');
                if (select.options.length <= 1) {
                    state.faecher.forEach(f => {
                        if (state.faecherEnabled[f.id] !== false) {
                            const opt = document.createElement('option');
                            opt.value = f.id;
                            opt.textContent = `${f.name} ${f.klasse}`;
                            select.appendChild(opt);
                        }
                    });
                }
            }
            
            // Archiv-Liste laden und Name vorausfüllen
            if (tabName === 'archiv') {
                updateArchiveList();
                // Aktuellen Semester-Namen als Vorschlag einfügen
                const archiveNameInput = document.getElementById('archive-name');
                if (archiveNameInput && !archiveNameInput.value) {
                    archiveNameInput.value = state.semester.name || '';
                }
            }
        }

        // ========================================
        // ZEUGNIS-MATRIX
        // ========================================
        
        function updateZeugnisMatrix() {
            const fachId = document.getElementById('zeugnis-fach').value;
            const container = document.getElementById('zeugnis-matrix');
            
            if (!fachId) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">Bitte ein Fach wählen.</p>';
                return;
            }
            
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach || fach.schuelerIds.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">Keine Schüler in diesem Fach.</p>';
                return;
            }
            
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            
            // Schüler sammeln und sortieren
            const schuelerList = fach.schuelerIds
                .map(sid => state.schueler.find(s => s.id === sid))
                .filter(s => s)
                .sort((a, b) => a.nachname.localeCompare(b.nachname));
            
            if (schuelerList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">Keine Schüler gefunden.</p>';
                return;
            }
            
            // Berechne Median für jede Schüler-Kriterium Kombination
            function getMedianRating(schuelerId, kritId) {
                const ratings = state.beobachtungen
                    .filter(b => b.schuelerId === schuelerId && b.fachId === fachId && b.kriterium === kritId)
                    .map(b => b.rating);
                
                if (ratings.length === 0) return null;
                
                ratings.sort((a, b) => a - b);
                const mid = Math.floor(ratings.length / 2);
                return ratings.length % 2 === 0 
                    ? (ratings[mid - 1] + ratings[mid]) / 2 
                    : ratings[mid];
            }
            
            // Farbe basierend auf Bewertung
            function getRatingColor(rating) {
                if (rating === null) return '#e5e7eb'; // Grau - keine Daten
                if (rating >= 3.5) return '#16a34a';   // Dunkelgrün - sehr gut
                if (rating >= 2.5) return '#84cc16';   // Hellgrün - gut
                if (rating >= 1.5) return '#f59e0b';   // Orange - genügend
                return '#ef4444';                       // Rot - nicht genügend
            }
            
            // Rating-Symbol
            function getRatingSymbol(rating) {
                if (rating === null) return '–';
                if (rating >= 3.5) return '●●●●';
                if (rating >= 2.5) return '●●●';
                if (rating >= 1.5) return '●●';
                return '●';
            }
            
            // Tabelle aufbauen
            const minWidth = 80 + schuelerList.length * 70;
            let html = `<table class="zeugnis-table" style="min-width: ${minWidth}px; width: 100%; border-collapse: collapse; font-size: 0.85rem;">`;
            
            // Header mit Schülernamen
            html += '<thead><tr>';
            html += '<th style="text-align: left; padding: 8px 12px; border-bottom: 2px solid var(--border); position: sticky; left: 0; background: white; z-index: 10; min-width: 140px;">Kriterium</th>';
            schuelerList.forEach(s => {
                const shortName = `${s.vorname.charAt(0)}. ${s.nachname}`;
                html += `<th style="padding: 8px 4px; border-bottom: 2px solid var(--border); text-align: center; white-space: nowrap; font-weight: 500; font-size: 0.8rem;" title="${s.vorname} ${s.nachname}">${shortName}</th>`;
            });
            html += '</tr></thead>';
            
            html += '<tbody>';
            
            // Zeilen nach Kategorie gruppieren
            const categories = [
                { prefix: 'L', name: 'Lernverhalten', color: '#dbeafe' },
                { prefix: 'A', name: 'Arbeitsverhalten', color: '#dcfce7' },
                { prefix: 'S', name: 'Sozialverhalten', color: '#fef3c7' }
            ];
            
            categories.forEach(cat => {
                const catKriterien = enabledKriterien.filter(k => k.id.startsWith(cat.prefix));
                
                if (catKriterien.length > 0) {
                    // Kategorie-Header
                    html += `<tr><td colspan="${schuelerList.length + 1}" style="padding: 8px 12px; background: ${cat.color}; font-weight: 600; border-top: 1px solid var(--border);">${cat.name}</td></tr>`;
                    
                    // Kriterien dieser Kategorie
                    catKriterien.forEach(krit => {
                        html += '<tr>';
                        html += `<td style="padding: 6px 12px; border-bottom: 1px solid var(--border); position: sticky; left: 0; background: white; z-index: 5; font-size: 0.8rem;">${krit.id} ${krit.name}</td>`;
                        
                        schuelerList.forEach(s => {
                            const median = getMedianRating(s.id, krit.id);
                            const color = getRatingColor(median);
                            const symbol = getRatingSymbol(median);
                            const tooltip = median !== null ? `Median: ${median.toFixed(1)}` : 'Keine Beobachtungen';
                            
                            html += `<td style="padding: 4px; border-bottom: 1px solid var(--border); text-align: center;" title="${s.vorname} ${s.nachname} - ${krit.name}: ${tooltip}">
                                <span style="display: inline-block; padding: 2px 6px; border-radius: 4px; background: ${color}; color: ${median !== null && median < 2.5 ? 'white' : (median === null ? '#666' : 'white')}; font-size: 0.75rem; letter-spacing: 1px;">${symbol}</span>
                            </td>`;
                        });
                        
                        html += '</tr>';
                    });
                }
            });
            
            html += '</tbody></table>';
            
            container.innerHTML = html;
        }

        // Sortierrichtung speichern
        let heatmapSortDir = 'asc';
        let faecherSortCol = 'name';
        let faecherSortDir = 'asc';
        let schuelerSortCol = 'nachname';
        let schuelerSortDir = 'asc';

        function setHeatmapSort(col) {
            const currentSort = document.getElementById('heatmap-sort').value;
            if (currentSort === col) {
                // Gleiche Spalte: Richtung umkehren
                heatmapSortDir = heatmapSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                // Neue Spalte: Standard-Richtung
                heatmapSortDir = (col === 'beobachtungen' || col === 'luecken') ? 'desc' : 'asc';
            }
            document.getElementById('heatmap-sort').value = col;
            updateHeatmap();
        }

        function updateHeatmap() {
            const fachId = document.getElementById('heatmap-fach').value;
            const sortBy = document.getElementById('heatmap-sort').value;
            const container = document.getElementById('heatmap-grid');
            
            if (!fachId) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 40px;">Bitte ein Fach wählen.</p>';
                return;
            }
            
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            const target = state.semester.targetObservations || 3;
            
            // Schüler mit Statistiken sammeln
            let schuelerList = fach.schuelerIds
                .map(sid => {
                    const schueler = state.schueler.find(s => s.id === sid);
                    if (!schueler) return null;
                    
                    // Beobachtungen zählen
                    const totalBeob = state.beobachtungen.filter(b => 
                        b.schuelerId === schueler.id && b.fachId === fachId
                    ).length;
                    
                    // Lücken zählen (Kriterien ohne genug Beobachtungen)
                    let luecken = 0;
                    enabledKriterien.forEach(krit => {
                        const count = state.beobachtungen.filter(b => 
                            b.schuelerId === schueler.id && 
                            b.fachId === fachId && 
                            b.kriteriumId === krit.id
                        ).length;
                        if (count < target) luecken++;
                    });
                    
                    return { ...schueler, totalBeob, luecken };
                })
                .filter(s => s);
            
            // Sortieren mit Richtung
            const dir = heatmapSortDir === 'asc' ? 1 : -1;
            switch (sortBy) {
                case 'vorname':
                    schuelerList.sort((a, b) => dir * a.vorname.localeCompare(b.vorname));
                    break;
                case 'beobachtungen':
                    schuelerList.sort((a, b) => dir * (a.totalBeob - b.totalBeob));
                    break;
                case 'luecken':
                    schuelerList.sort((a, b) => dir * (a.luecken - b.luecken));
                    break;
                default: // nachname
                    schuelerList.sort((a, b) => dir * a.nachname.localeCompare(b.nachname));
            }
            
            // Tabelle aufbauen - min-width basierend auf Anzahl Kriterien
            const minWidth = 200 + (enabledKriterien.length * 32) + 50; // Nachname + Vorname + Kriterien + Summe
            let html = `<table style="width: 100%; min-width: ${minWidth}px; border-collapse: collapse; font-size: 0.8rem;">`;
            
            // Sortier-Symbole (zeigt Richtung an)
            const sortSymbol = (col) => {
                if (sortBy === col) {
                    return heatmapSortDir === 'asc' 
                        ? ' <span style="color: var(--primary);">▲</span>'
                        : ' <span style="color: var(--primary);">▼</span>';
                }
                return ' <span style="color: #ccc;">▽</span>';
            };
            
            // Header
            html += `<thead><tr>
                <th style="padding: 8px 4px; text-align: left; border-bottom: 2px solid var(--border); position: sticky; left: 0; background: white; min-width: 100px; cursor: pointer; user-select: none;" onclick="setHeatmapSort('nachname')">Nachname${sortSymbol('nachname')}</th>
                <th style="padding: 8px 4px; text-align: left; border-bottom: 2px solid var(--border); background: white; min-width: 80px; cursor: pointer; user-select: none;" onclick="setHeatmapSort('vorname')">Vorname${sortSymbol('vorname')}</th>`;
            enabledKriterien.forEach(k => {
                html += `<th style="padding: 8px 4px; text-align: center; border-bottom: 2px solid var(--border); writing-mode: vertical-rl; text-orientation: mixed; height: 80px; font-weight: 500;">${k.id}</th>`;
            });
            html += `<th style="padding: 8px 4px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 500; cursor: pointer; user-select: none;" onclick="setHeatmapSort('beobachtungen')">Σ${sortSymbol('beobachtungen')}</th>`;
            html += '</tr></thead><tbody>';
            
            // Zeilen für Schüler
            schuelerList.forEach(schueler => {
                html += `<tr>
                    <td style="padding: 6px 4px; border-bottom: 1px solid var(--border); position: sticky; left: 0; background: white; font-weight: 500;">${schueler.nachname}</td>
                    <td style="padding: 6px 4px; border-bottom: 1px solid var(--border); background: white;">${schueler.vorname}</td>`;
                
                enabledKriterien.forEach(krit => {
                    const count = state.beobachtungen.filter(b => 
                        b.schuelerId === schueler.id && 
                        b.fachId === fachId && 
                        b.kriteriumId === krit.id
                    ).length;
                    
                    // Farbe basierend auf Anzahl
                    let bgColor = '#fee2e2'; // Rot - 0
                    let textColor = '#991b1b';
                    if (count >= target) {
                        bgColor = '#d1fae5'; // Grün - Ziel erreicht
                        textColor = '#065f46';
                    } else if (count > 0) {
                        bgColor = '#fef3c7'; // Gelb - teilweise
                        textColor = '#92400e';
                    }
                    
                    html += `<td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid var(--border); background: ${bgColor}; color: ${textColor}; font-weight: 500;">${count}</td>`;
                });
                
                // Summe
                html += `<td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid var(--border); font-weight: 600; background: var(--background);">${schueler.totalBeob}</td>`;
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========================================
        // GRAFIKEN - RADAR-DIAGRAMM
        // ========================================

        function drawRadarChart(canvasId, data, labels) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const size = Math.min(canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = size * 0.35;
            const numPoints = labels.length;
            
            // Clear
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Hintergrund-Ringe zeichnen
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let ring = 1; ring <= 4; ring++) {
                const ringRadius = radius * ring / 4;
                ctx.beginPath();
                for (let i = 0; i <= numPoints; i++) {
                    const angle = (Math.PI * 2 * i / numPoints) - Math.PI / 2;
                    const x = centerX + Math.cos(angle) * ringRadius;
                    const y = centerY + Math.sin(angle) * ringRadius;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.stroke();
            }
            
            // Achsen zeichnen
            ctx.strokeStyle = '#d1d5db';
            for (let i = 0; i < numPoints; i++) {
                const angle = (Math.PI * 2 * i / numPoints) - Math.PI / 2;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius);
                ctx.stroke();
            }
            
            // Daten-Polygon zeichnen
            ctx.fillStyle = 'rgba(8, 145, 178, 0.3)';
            ctx.strokeStyle = '#0891b2';
            ctx.lineWidth = 2;
            ctx.beginPath();
            data.forEach((value, i) => {
                const normalizedValue = value / 4; // Werte sind 1-4
                const angle = (Math.PI * 2 * i / numPoints) - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius * normalizedValue;
                const y = centerY + Math.sin(angle) * radius * normalizedValue;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // Datenpunkte zeichnen
            ctx.fillStyle = '#0891b2';
            data.forEach((value, i) => {
                const normalizedValue = value / 4;
                const angle = (Math.PI * 2 * i / numPoints) - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius * normalizedValue;
                const y = centerY + Math.sin(angle) * radius * normalizedValue;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Labels zeichnen
            ctx.fillStyle = '#374151';
            ctx.font = '11px system-ui';
            ctx.textAlign = 'center';
            labels.forEach((label, i) => {
                const angle = (Math.PI * 2 * i / numPoints) - Math.PI / 2;
                const labelRadius = radius + 20;
                const x = centerX + Math.cos(angle) * labelRadius;
                const y = centerY + Math.sin(angle) * labelRadius;
                
                // Text-Ausrichtung anpassen basierend auf Position
                if (Math.abs(angle + Math.PI / 2) < 0.1) {
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                } else if (Math.abs(angle - Math.PI / 2) < 0.1) {
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                } else if (angle > -Math.PI / 2 && angle < Math.PI / 2) {
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                } else {
                    ctx.textAlign = 'right';
                    ctx.textBaseline = 'middle';
                }
                
                ctx.fillText(label, x, y);
            });
        }

        function getRadarDataForStudent(studentId, fachId) {
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            const data = [];
            const labels = [];
            
            enabledKriterien.forEach(krit => {
                const beobachtungen = state.beobachtungen.filter(b => 
                    b.schuelerId === studentId && 
                    b.fachId === fachId && 
                    b.kriteriumId === krit.id
                );
                
                let avg = 2.5; // Default Mitte
                if (beobachtungen.length > 0) {
                    avg = beobachtungen.reduce((sum, b) => sum + b.rating, 0) / beobachtungen.length;
                }
                
                data.push(avg);
                labels.push(krit.id);
            });
            
            return { data, labels };
        }

        function applyTestTime() {
            const day = document.getElementById('test-day').value;
            const time = document.getElementById('test-time').value;
            const speed = parseInt(document.getElementById('test-speed').value) || 1;
            
            if (!day || !time) {
                showToast('Bitte Wochentag und Startzeit wählen', 'error');
                return;
            }
            
            // Stop any existing interval
            if (testMode.intervalId) {
                clearInterval(testMode.intervalId);
            }
            
            const [h, m] = time.split(':').map(Number);
            
            testMode.active = true;
            testMode.day = parseInt(day);
            testMode.speed = speed;
            testMode.startRealTime = Date.now();
            testMode.startSimTime = h * 60 + m; // in minutes
            
            // Update time display
            updateTestModeTime();
            
            // Start interval to update time
            testMode.intervalId = setInterval(() => {
                updateTestModeTime();
                updateDashboard();
            }, 1000); // Update every second
            
            updateDashboard();
            showToast(`Test-Modus gestartet (${speed}× Geschwindigkeit)`, 'success');
        }

        function updateTestModeTime() {
            if (!testMode.active) {
                document.getElementById('test-mode-sidebar').style.display = 'none';
                return;
            }
            
            const elapsedRealMs = Date.now() - testMode.startRealTime;
            const elapsedSimMinutes = (elapsedRealMs / 1000 / 60) * testMode.speed;
            const currentSimMinutes = testMode.startSimTime + elapsedSimMinutes;
            
            const hours = Math.floor(currentSimMinutes / 60) % 24;
            const minutes = Math.floor(currentSimMinutes % 60);
            
            testMode.time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            
            const dayNames = ['', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
            const statusText = `${dayNames[testMode.day]}, ${testMode.time} (${testMode.speed}×)`;
            
            // Update in Export section
            document.getElementById('test-mode-status').innerHTML = 
                `<span style="color: var(--primary); font-weight: 600;">▶ ${statusText}</span>`;
            
            // Update in Sidebar
            document.getElementById('test-mode-sidebar').style.display = 'block';
            document.getElementById('test-time-display').textContent = statusText;
        }

        function resetTestTime() {
            if (testMode.intervalId) {
                clearInterval(testMode.intervalId);
                testMode.intervalId = null;
            }
            
            testMode.active = false;
            testMode.day = null;
            testMode.time = null;
            testMode.speed = 1;
            testMode.startRealTime = null;
            testMode.startSimTime = null;
            
            document.getElementById('test-day').value = '';
            document.getElementById('test-time').value = '';
            document.getElementById('test-speed').value = '1';
            document.getElementById('test-mode-status').innerHTML = '';
            document.getElementById('test-mode-sidebar').style.display = 'none';
            
            updateDashboard();
            showToast('Test-Modus deaktiviert', 'success');
        }

        function checkCurrentLesson() {
            updateDashboard();
        }

        function updateFachSelects() {
            const selectConfigs = {
                'select-fach-klasse': '-- Fach wählen --',
                'eval-fach-klasse': '-- Fach wählen --',
                'config-schueler-fach': '-- Fach wählen --'
            };
            const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id]);

            Object.entries(selectConfigs).forEach(([id, placeholder]) => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = `<option value="">${placeholder}</option>`;
                
                enabledFaecher.forEach(fach => {
                    const option = document.createElement('option');
                    option.value = fach.id;
                    option.textContent = `${fach.name} ${fach.klasse} (${fach.schuelerIds.length} Schüler)`;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // ========================================
        // NAVIGATION
        // ========================================

        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('screen-' + screenName).classList.add('active');
            document.querySelector(`.nav-item[data-screen="${screenName}"]`).classList.add('active');

            // Close mobile sidebar
            document.getElementById('sidebar').classList.remove('open');

            // Screen-specific updates
            if (screenName === 'evaluation') {
                updateEvaluation();
            } else if (screenName === 'export') {
                updateDemoObservationCount();
            } else if (screenName === 'masterdata') {
                updateFaecherListe();
                updateSchuelerDropdown();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // ========================================
        // STAMMDATEN
        // ========================================

        function showMasterdataTab(tabName) {
            // Tabs umschalten
            document.querySelectorAll('#screen-masterdata .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Content umschalten
            document.getElementById('masterdata-tab-faecher').style.display = tabName === 'faecher' ? 'block' : 'none';
            document.getElementById('masterdata-tab-schueler').style.display = tabName === 'schueler' ? 'block' : 'none';
            document.getElementById('masterdata-tab-stundenplan').style.display = tabName === 'stundenplan' ? 'block' : 'none';
            
            // Daten laden
            if (tabName === 'faecher') updateFaecherListe();
            if (tabName === 'schueler') updateSchuelerDropdown();
            if (tabName === 'stundenplan') updateStundenplanEdit();
        }

        function updateFaecherListe() {
            const container = document.getElementById('faecher-liste');
            if (!container) return;
            
            if (state.faecher.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">Noch keine Fächer erfasst.</p>';
                return;
            }
            
            // Sortier-Symbole
            const sortSymbol = (col) => {
                if (faecherSortCol !== col) return '<span style="color: var(--text-light);">▽</span>';
                return faecherSortDir === 'asc' ? '▲' : '▼';
            };
            
            // Fächer sortieren
            const sortedFaecher = [...state.faecher].sort((a, b) => {
                const dir = faecherSortDir === 'asc' ? 1 : -1;
                if (faecherSortCol === 'name') {
                    return dir * a.name.localeCompare(b.name);
                } else if (faecherSortCol === 'klasse') {
                    return dir * a.klasse.localeCompare(b.klasse);
                } else if (faecherSortCol === 'schueler') {
                    return dir * (a.schuelerIds.length - b.schuelerIds.length);
                }
                return 0;
            });
            
            let html = `<div class="table-container"><table style="width: 100%; min-width: 400px;">
                <thead>
                    <tr>
                        <th style="cursor: pointer; user-select: none;" onclick="setFaecherSort('name')">Fach ${sortSymbol('name')}</th>
                        <th style="cursor: pointer; user-select: none;" onclick="setFaecherSort('klasse')">Klasse ${sortSymbol('klasse')}</th>
                        <th style="cursor: pointer; user-select: none;" onclick="setFaecherSort('schueler')">Schüler ${sortSymbol('schueler')}</th>
                        <th style="width: 100px;"></th>
                    </tr>
                </thead>
                <tbody>`;
            
            sortedFaecher.forEach(fach => {
                const schuelerCount = fach.schuelerIds.length;
                html += `
                    <tr>
                        <td>${fach.name}</td>
                        <td>${fach.klasse}</td>
                        <td>${schuelerCount}</td>
                        <td style="text-align: right;">
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 4px;" onclick="editFach('${fach.id}')" title="Bearbeiten">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="deleteFach('${fach.id}')" title="Löschen">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function setFaecherSort(col) {
            if (faecherSortCol === col) {
                faecherSortDir = faecherSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                faecherSortCol = col;
                faecherSortDir = col === 'schueler' ? 'desc' : 'asc';
            }
            updateFaecherListe();
        }

        function addFach() {
            const nameInput = document.getElementById('new-fach-name');
            const klasseInput = document.getElementById('new-fach-klasse');
            
            const name = nameInput.value.trim();
            const klasse = klasseInput.value.trim();
            
            if (!name || !klasse) {
                showToast('Bitte Fachname und Klasse eingeben', 'error');
                return;
            }
            
            const id = 'fach_' + Date.now();
            state.faecher.push({
                id: id,
                name: name,
                klasse: klasse,
                schuelerIds: []
            });
            state.faecherEnabled[id] = true;
            
            saveState();
            updateFaecherListe();
            updateAllDropdowns();
            
            nameInput.value = '';
            klasseInput.value = '';
            
            showToast(`${name} ${klasse} hinzugefügt`, 'success');
        }

        function deleteFach(fachId) {
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            const beobCount = state.beobachtungen.filter(b => b.fachId === fachId).length;
            
            let msg = `"${fach.name} ${fach.klasse}" wirklich löschen?`;
            if (beobCount > 0) {
                msg += `\n\nAchtung: ${beobCount} Beobachtungen sind mit diesem Fach verknüpft und werden ebenfalls gelöscht!`;
            }
            
            if (!confirm(msg)) return;
            
            // Beobachtungen löschen
            state.beobachtungen = state.beobachtungen.filter(b => b.fachId !== fachId);
            
            // Fach aus Stundenplan entfernen
            state.stundenplan.forEach(lektion => {
                ['mo', 'di', 'mi', 'do', 'fr'].forEach(day => {
                    if (lektion[day] === fachId) lektion[day] = null;
                });
            });
            
            // Fach löschen
            state.faecher = state.faecher.filter(f => f.id !== fachId);
            delete state.faecherEnabled[fachId];
            
            saveState();
            updateFaecherListe();
            updateAllDropdowns();
            updateDashboard();
            
            showToast('Fach gelöscht', 'success');
        }

        function editFach(fachId) {
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            const html = `
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Fachname</label>
                        <input type="text" class="form-input" id="edit-fach-name" value="${fach.name}">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Klasse</label>
                        <input type="text" class="form-input" id="edit-fach-klasse" value="${fach.klasse}">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveFachEdit('${fachId}')">Speichern</button>
                </div>
            `;
            
            document.getElementById('modal-title').textContent = 'Fach bearbeiten';
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('detail-modal').classList.add('active');
            document.getElementById('edit-fach-name').focus();
        }

        function saveFachEdit(fachId) {
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            const newName = document.getElementById('edit-fach-name').value.trim();
            const newKlasse = document.getElementById('edit-fach-klasse').value.trim();
            
            if (!newName || !newKlasse) {
                showToast('Name und Klasse dürfen nicht leer sein', 'error');
                return;
            }
            
            fach.name = newName;
            fach.klasse = newKlasse;
            
            saveState();
            closeModal();
            updateFaecherListe();
            updateAllDropdowns();
            updateDashboard();
            
            showToast('Fach aktualisiert', 'success');
        }

        function updateSchuelerDropdown() {
            const select = document.getElementById('masterdata-schueler-fach');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Fach wählen --</option>';
            state.faecher.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} ${f.klasse}`;
                select.appendChild(opt);
            });
        }

        function updateSchuelerListe() {
            const fachId = document.getElementById('masterdata-schueler-fach').value;
            const container = document.getElementById('schueler-edit-container');
            const liste = document.getElementById('schueler-liste');
            
            if (!fachId) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            // Sortier-Symbole
            const sortSymbol = (col) => {
                if (schuelerSortCol !== col) return '<span style="color: var(--text-light);">▽</span>';
                return schuelerSortDir === 'asc' ? '▲' : '▼';
            };
            
            // Schüler sortieren
            const schueler = fach.schuelerIds
                .map(sid => state.schueler.find(s => s.id === sid))
                .filter(s => s)
                .sort((a, b) => {
                    const dir = schuelerSortDir === 'asc' ? 1 : -1;
                    if (schuelerSortCol === 'nachname') {
                        return dir * a.nachname.localeCompare(b.nachname);
                    } else if (schuelerSortCol === 'vorname') {
                        return dir * a.vorname.localeCompare(b.vorname);
                    }
                    return 0;
                });
            
            if (schueler.length === 0) {
                liste.innerHTML = '<p style="color: var(--text-light); text-align: center; padding: 20px;">Noch keine Schüler in dieser Klasse.</p>';
                return;
            }
            
            let html = `<div class="table-container"><table style="width: 100%; min-width: 350px;">
                <thead>
                    <tr>
                        <th style="cursor: pointer; user-select: none;" onclick="setSchuelerSort('nachname')">Nachname ${sortSymbol('nachname')}</th>
                        <th style="cursor: pointer; user-select: none;" onclick="setSchuelerSort('vorname')">Vorname ${sortSymbol('vorname')}</th>
                        <th style="width: 100px;"></th>
                    </tr>
                </thead>
                <tbody>`;
            
            schueler.forEach(s => {
                html += `
                    <tr>
                        <td>${s.nachname}</td>
                        <td>${s.vorname}</td>
                        <td style="text-align: right;">
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 4px;" onclick="editSchueler('${s.id}')" title="Bearbeiten">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem;" onclick="deleteSchueler('${fachId}', '${s.id}')" title="Aus Klasse entfernen">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            liste.innerHTML = html;
        }

        function setSchuelerSort(col) {
            if (schuelerSortCol === col) {
                schuelerSortDir = schuelerSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                schuelerSortCol = col;
                schuelerSortDir = 'asc';
            }
            updateSchuelerListe();
        }

        function importSchuelerExcel(event) {
            const fachId = document.getElementById('masterdata-schueler-fach').value;
            if (!fachId) {
                showToast('Bitte zuerst ein Fach wählen', 'error');
                event.target.value = '';
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Erstes Sheet lesen
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    
                    // In JSON konvertieren (erste Zeile = Header)
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    if (rows.length < 2) {
                        showToast('Die Datei enthält keine Daten', 'error');
                        return;
                    }
                    
                    const fach = state.faecher.find(f => f.id === fachId);
                    if (!fach) return;
                    
                    let imported = 0;
                    let skipped = 0;
                    
                    // Ab Zeile 2 (Index 1) - erste Zeile ist Header
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const nachname = row[0] ? String(row[0]).trim() : '';
                        const vorname = row[1] ? String(row[1]).trim() : '';
                        
                        if (!nachname || !vorname) {
                            skipped++;
                            continue;
                        }
                        
                        // Prüfen ob Schüler bereits existiert
                        let schueler = state.schueler.find(s => 
                            s.vorname.toLowerCase() === vorname.toLowerCase() && 
                            s.nachname.toLowerCase() === nachname.toLowerCase()
                        );
                        
                        if (!schueler) {
                            // Neuen Schüler erstellen
                            schueler = {
                                id: 'schueler_' + Date.now() + '_' + i,
                                vorname: vorname,
                                nachname: nachname
                            };
                            state.schueler.push(schueler);
                        }
                        
                        // Zur Klasse hinzufügen falls noch nicht drin
                        if (!fach.schuelerIds.includes(schueler.id)) {
                            fach.schuelerIds.push(schueler.id);
                            imported++;
                        } else {
                            skipped++;
                        }
                    }
                    
                    saveState();
                    updateSchuelerListe();
                    updateFaecherListe();
                    
                    if (imported > 0) {
                        showToast(`${imported} Schüler importiert` + (skipped > 0 ? `, ${skipped} übersprungen` : ''), 'success');
                    } else {
                        showToast('Keine neuen Schüler importiert', 'error');
                    }
                    
                } catch (error) {
                    console.error('Excel Import Fehler:', error);
                    showToast('Fehler beim Lesen der Excel-Datei', 'error');
                }
                
                // Input zurücksetzen
                event.target.value = '';
            };
            
            reader.readAsArrayBuffer(file);
        }

        function addSchueler() {
            const fachId = document.getElementById('masterdata-schueler-fach').value;
            const vornameInput = document.getElementById('new-schueler-vorname');
            const nachnameInput = document.getElementById('new-schueler-nachname');
            
            const vorname = vornameInput.value.trim();
            const nachname = nachnameInput.value.trim();
            
            if (!fachId) {
                showToast('Bitte zuerst ein Fach wählen', 'error');
                return;
            }
            
            if (!vorname || !nachname) {
                showToast('Bitte Vor- und Nachname eingeben', 'error');
                return;
            }
            
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return;
            
            // Prüfen ob Schüler bereits existiert
            let schueler = state.schueler.find(s => 
                s.vorname.toLowerCase() === vorname.toLowerCase() && 
                s.nachname.toLowerCase() === nachname.toLowerCase()
            );
            
            if (!schueler) {
                // Neuen Schüler anlegen
                schueler = {
                    id: 's_' + Date.now(),
                    vorname: vorname,
                    nachname: nachname
                };
                state.schueler.push(schueler);
            }
            
            // Schüler zum Fach hinzufügen (falls noch nicht drin)
            if (!fach.schuelerIds.includes(schueler.id)) {
                fach.schuelerIds.push(schueler.id);
            }
            
            saveState();
            updateSchuelerListe();
            updateFaecherListe();
            
            vornameInput.value = '';
            nachnameInput.value = '';
            
            showToast(`${vorname} ${nachname} hinzugefügt`, 'success');
        }

        function deleteSchueler(fachId, schuelerId) {
            const schueler = state.schueler.find(s => s.id === schuelerId);
            const fach = state.faecher.find(f => f.id === fachId);
            
            if (!schueler || !fach) return;
            
            const beobCount = state.beobachtungen.filter(b => 
                b.schuelerId === schuelerId && b.fachId === fachId
            ).length;
            
            let msg = `"${schueler.vorname} ${schueler.nachname}" aus ${fach.name} ${fach.klasse} entfernen?`;
            if (beobCount > 0) {
                msg += `\n\nAchtung: ${beobCount} Beobachtungen werden ebenfalls gelöscht!`;
            }
            
            if (!confirm(msg)) return;
            
            // Beobachtungen löschen
            state.beobachtungen = state.beobachtungen.filter(b => 
                !(b.schuelerId === schuelerId && b.fachId === fachId)
            );
            
            // Schüler aus Fach entfernen
            fach.schuelerIds = fach.schuelerIds.filter(id => id !== schuelerId);
            
            saveState();
            updateSchuelerListe();
            updateFaecherListe();
            
            showToast('Schüler entfernt', 'success');
        }

        function editSchueler(schuelerId) {
            const schueler = state.schueler.find(s => s.id === schuelerId);
            if (!schueler) return;
            
            const html = `
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Vorname</label>
                        <input type="text" class="form-input" id="edit-schueler-vorname" value="${schueler.vorname}">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">Nachname</label>
                        <input type="text" class="form-input" id="edit-schueler-nachname" value="${schueler.nachname}">
                    </div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveSchuelerEdit('${schuelerId}')">Speichern</button>
                </div>
            `;
            
            document.getElementById('modal-title').textContent = 'Schüler bearbeiten';
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('detail-modal').classList.add('active');
            document.getElementById('edit-schueler-vorname').focus();
        }

        function saveSchuelerEdit(schuelerId) {
            const schueler = state.schueler.find(s => s.id === schuelerId);
            if (!schueler) return;
            
            const newVorname = document.getElementById('edit-schueler-vorname').value.trim();
            const newNachname = document.getElementById('edit-schueler-nachname').value.trim();
            
            if (!newVorname || !newNachname) {
                showToast('Vor- und Nachname dürfen nicht leer sein', 'error');
                return;
            }
            
            schueler.vorname = newVorname;
            schueler.nachname = newNachname;
            
            saveState();
            closeModal();
            updateSchuelerListe();
            
            showToast('Schüler aktualisiert', 'success');
        }

        function updateStundenplanEdit() {
            const tbody = document.getElementById('stundenplan-edit-body');
            if (!tbody) return;
            
            let html = '';
            
            state.stundenplan.forEach((lektion, index) => {
                html += `<tr>
                    <td style="font-weight: 600;">${lektion.zeit}</td>`;
                
                ['mo', 'di', 'mi', 'do', 'fr'].forEach(day => {
                    const fachId = lektion[day];
                    const fach = fachId ? state.faecher.find(f => f.id === fachId) : null;
                    const displayText = fach ? `${fach.name} ${fach.klasse}` : '–';
                    
                    html += `<td style="cursor: pointer;" onclick="openStundenplanPicker(${index}, '${day}')">
                        <span style="color: ${fach ? 'var(--text)' : 'var(--text-light)'};">${displayText}</span>
                    </td>`;
                });
                
                html += `<td style="width: 40px;">
                    <button class="btn btn-secondary" style="padding: 2px 6px;" onclick="deleteStundenplanZeile(${index})" title="Zeile löschen">×</button>
                </td></tr>`;
            });
            
            tbody.innerHTML = html;
        }

        function openStundenplanPicker(rowIndex, day) {
            const lektion = state.stundenplan[rowIndex];
            const currentFachId = lektion[day];
            
            let options = '<option value="">– Kein Fach –</option>';
            state.faecher.forEach(f => {
                const selected = f.id === currentFachId ? 'selected' : '';
                options += `<option value="${f.id}" ${selected}>${f.name} ${f.klasse}</option>`;
            });
            
            const newFachId = prompt('Fach wählen:\n\n' + state.faecher.map((f, i) => `${i+1}. ${f.name} ${f.klasse}`).join('\n') + '\n\n(Nummer eingeben oder leer lassen für kein Fach)');
            
            if (newFachId === null) return; // Abgebrochen
            
            if (newFachId === '' || newFachId === '0') {
                lektion[day] = null;
            } else {
                const num = parseInt(newFachId) - 1;
                if (num >= 0 && num < state.faecher.length) {
                    lektion[day] = state.faecher[num].id;
                }
            }
            
            saveState();
            updateStundenplanEdit();
            updateDashboard();
        }

        function addStundenplanZeile() {
            const zeit = prompt('Zeitfenster eingeben (z.B. "10:30 - 11:15"):');
            if (!zeit) return;
            
            state.stundenplan.push({
                zeit: zeit,
                mo: null,
                di: null,
                mi: null,
                do: null,
                fr: null
            });
            
            saveState();
            updateStundenplanEdit();
        }

        function deleteStundenplanZeile(index) {
            if (!confirm('Diese Zeile wirklich löschen?')) return;
            
            state.stundenplan.splice(index, 1);
            saveState();
            updateStundenplanEdit();
            updateDashboard();
        }

        function updateAllDropdowns() {
            // Alle Fach-Dropdowns aktualisieren
            const dropdowns = [
                'select-fach-klasse',
                'eval-fach',
                'heatmap-fach',
                'masterdata-schueler-fach'
            ];
            
            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">-- Fach wählen --</option>';
                
                state.faecher.forEach(f => {
                    if (state.faecherEnabled[f.id] !== false) {
                        const opt = document.createElement('option');
                        opt.value = f.id;
                        opt.textContent = `${f.name} ${f.klasse}`;
                        select.appendChild(opt);
                    }
                });
                
                // Vorherigen Wert wiederherstellen falls noch vorhanden
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            });
        }

        function showConfigTab(tabName) {
            document.querySelectorAll('.config-tab').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById('config-' + tabName).style.display = 'block';
            event.target.classList.add('active');
            
            // Backup-Statistiken laden
            if (tabName === 'daten') {
                updateBackupStats();
            }
        }
        
        function updateBackupStats() {
            const container = document.getElementById('backup-stats');
            if (!container) return;
            
            const stats = [
                { label: 'Schüler', value: state.schueler.length, icon: '👤' },
                { label: 'Fächer', value: state.faecher.length, icon: '📚' },
                { label: 'Beobachtungen', value: state.beobachtungen.length, icon: '👁' },
                { label: 'Zeugnisnoten', value: Object.keys(state.zeugnisNoten).length, icon: '📝' },
                { label: 'Archiv', value: state.archive ? state.archive.length : 0, icon: '📦' }
            ];
            
            container.innerHTML = stats.map(s => `
                <div style="text-align: center; padding: 16px; background: var(--bg); border-radius: var(--radius);">
                    <div style="font-size: 1.5rem; margin-bottom: 4px;">${s.icon}</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--primary);">${s.value}</div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">${s.label}</div>
                </div>
            `).join('');
        }
        
        function resetAllData() {
            if (!confirm('⚠️ ACHTUNG: Alle Daten werden unwiderruflich gelöscht!\n\nDies umfasst:\n• Alle Schüler\n• Alle Fächer\n• Alle Beobachtungen\n• Alle Zeugnisnoten\n• Alle archivierten Semester\n\nFortfahren?')) {
                return;
            }
            
            if (!confirm('Bist du WIRKLICH sicher? Diese Aktion kann NICHT rückgängig gemacht werden!')) {
                return;
            }
            
            // Alles zurücksetzen
            localStorage.removeItem('lassoState');
            location.reload();
        }

        // ========================================
        // OBSERVATION
        // ========================================

        function startObservation() {
            const fachId = document.getElementById('select-fach-klasse').value;
            if (!fachId) {
                document.getElementById('observation-container').style.display = 'none';
                document.getElementById('observation-complete').style.display = 'none';
                return;
            }

            currentSession.fachId = fachId;
            currentSession.questions = generateQuestions(fachId, 5);
            currentSession.currentIndex = 0;
            currentSession.completed = 0;

            if (currentSession.questions.length === 0) {
                showToast('Keine Fragen verfügbar für diese Auswahl.', 'error');
                return;
            }

            document.getElementById('observation-container').style.display = 'block';
            document.getElementById('observation-complete').style.display = 'none';
            document.getElementById('question-total').textContent = currentSession.questions.length;
            
            showCurrentQuestion();
        }

        function generateQuestions(fachId, count) {
            const fach = state.faecher.find(f => f.id === fachId);
            if (!fach) return [];

            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            const questions = [];
            const gaps = calculateGaps().filter(g => g.fachId === fachId);
            
            // Konfigurierbare Einstellungen
            const MAX_PER_SCHUELER = state.semester.maxQuestionsPerStudent || 3;
            const prioritizeGaps = state.semester.prioritizeGaps !== false;
            
            // Zähler für Schüler
            const schuelerCount = {};

            // Wenn Priorisierung aktiv: Lücken zuerst füllen
            if (prioritizeGaps) {
                // Mische die Gaps für Variation
                const shuffledGaps = [...gaps].sort(() => Math.random() - 0.5);
                
                for (const gap of shuffledGaps) {
                    if (questions.length >= count) break;
                    
                    // Max pro Schüler prüfen
                    if ((schuelerCount[gap.schuelerId] || 0) >= MAX_PER_SCHUELER) continue;
                    
                    const krit = enabledKriterien.find(k => k.id === gap.kriteriumId);
                    if (!krit) continue;

                    // Nur aktive Indikatoren verwenden
                    const indikatoren = getActiveIndikatoren(krit.id);
                    if (indikatoren.length === 0) continue;
                    
                    const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

                    questions.push({
                        schuelerId: gap.schuelerId,
                        kriteriumId: krit.id,
                        indikator
                    });
                    
                    schuelerCount[gap.schuelerId] = (schuelerCount[gap.schuelerId] || 0) + 1;
                }
            }

            // Restliche Fragen zufällig füllen
            let attempts = 0;
            while (questions.length < count && attempts < 100) {
                attempts++;
                const schuelerId = fach.schuelerIds[Math.floor(Math.random() * fach.schuelerIds.length)];
                
                // Max pro Schüler prüfen
                if ((schuelerCount[schuelerId] || 0) >= MAX_PER_SCHUELER) continue;
                
                const krit = enabledKriterien[Math.floor(Math.random() * enabledKriterien.length)];
                
                // Nur aktive Indikatoren verwenden
                const indikatoren = getActiveIndikatoren(krit.id);
                if (indikatoren.length === 0) continue;
                
                const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

                questions.push({
                    schuelerId,
                    kriteriumId: krit.id,
                    indikator
                });
                
                schuelerCount[schuelerId] = (schuelerCount[schuelerId] || 0) + 1;
            }

            return questions;
        }

        function showCurrentQuestion() {
            const q = currentSession.questions[currentSession.currentIndex];
            const schueler = state.schueler.find(s => s.id === q.schuelerId);
            const fach = state.faecher.find(f => f.id === currentSession.fachId);
            const krit = KRITERIEN.find(k => k.id === q.kriteriumId);

            document.getElementById('question-number').textContent = currentSession.currentIndex + 1;
            document.getElementById('q-student').textContent = `${schueler.vorname} ${schueler.nachname}`;
            document.getElementById('q-fach').textContent = `${fach.name} ${fach.klasse}`;
            document.getElementById('q-kriterium').textContent = `${krit.id} ${krit.bereich}`;
            document.getElementById('q-indicator').textContent = q.indikator;

            const progress = (currentSession.currentIndex / currentSession.questions.length) * 100;
            document.getElementById('session-progress').textContent = Math.round(progress) + '%';
            document.getElementById('session-progress-fill').style.width = progress + '%';
        }

        function submitRating(rating) {
            const q = currentSession.questions[currentSession.currentIndex];

            if (rating > 0) {
                state.beobachtungen.push({
                    id: Date.now().toString(),
                    schuelerId: q.schuelerId,
                    fachId: currentSession.fachId,
                    kriteriumId: q.kriteriumId,
                    indikator: q.indikator,
                    rating,
                    timestamp: new Date().toISOString()
                });
                currentSession.completed++;
                saveState();
            }

            currentSession.currentIndex++;

            if (currentSession.currentIndex >= currentSession.questions.length) {
                finishSession();
            } else {
                showCurrentQuestion();
            }

            updateStats();
        }

        function finishSession() {
            document.getElementById('observation-container').style.display = 'none';
            document.getElementById('observation-complete').style.display = 'block';
            document.getElementById('completed-count').textContent = currentSession.completed;
        }

        function startNewRound() {
            startObservation();
        }

        // ========================================
        // EVALUATION
        // ========================================

        function updateEvaluationStudentSelect() {
            const fachId = document.getElementById('eval-fach-klasse').value;
            const select = document.getElementById('eval-student');
            
            select.innerHTML = '<option value="">-- Schüler wählen --</option>';
            
            if (fachId) {
                const fach = state.faecher.find(f => f.id === fachId);
                console.log('Fach gefunden:', fach);
                console.log('Anzahl Schüler im State:', state.schueler.length);
                
                if (fach && fach.schuelerIds && fach.schuelerIds.length > 0) {
                    // Schüler sammeln und nach Nachname sortieren
                    const schuelerList = fach.schuelerIds
                        .map(sid => state.schueler.find(st => st.id === sid))
                        .filter(s => s)
                        .sort((a, b) => a.nachname.localeCompare(b.nachname));
                    
                    console.log('Schüler gefunden:', schuelerList.length);
                    
                    if (schuelerList.length === 0) {
                        // Fallback: Zeige alle Schüler wenn keine gefunden
                        console.warn('Keine Schüler gefunden für Fach, zeige alle');
                    }
                    
                    schuelerList.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = `${s.nachname}, ${s.vorname}`;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('Fach hat keine schuelerIds:', fach);
                }
            }
        }

        function updateEvaluation() {
            const fachId = document.getElementById('eval-fach-klasse').value;
            const container = document.getElementById('evaluation-content');
            
            // WICHTIG: Student-Auswahl VORHER speichern!
            const currentStudentId = document.getElementById('eval-student').value;
            
            // Schülerliste aktualisieren (nur wenn Fach gewählt)
            updateEvaluationStudentSelect();
            
            // Student-Auswahl wiederherstellen (falls vorhanden und noch gültig)
            if (currentStudentId) {
                const studentSelect = document.getElementById('eval-student');
                // Prüfen ob der Schüler noch in der Liste ist
                const optionExists = Array.from(studentSelect.options).some(opt => opt.value === currentStudentId);
                if (optionExists) {
                    studentSelect.value = currentStudentId;
                }
            }
            
            const studentId = document.getElementById('eval-student').value;

            if (!fachId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <h3>Fach wählen</h3>
                        <p>Wähle zuerst ein Fach aus der Liste oben.</p>
                    </div>
                `;
                return;
            }

            if (!studentId) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <h3>Schüler auswählen</h3>
                        <p>Wähle jetzt einen Schüler aus der Liste.</p>
                    </div>
                `;
                return;
            }

            showStudentEvaluation(studentId, fachId);
        }

        function showStudentEvaluation(studentId, fachId) {
            const student = state.schueler.find(s => s.id === studentId);
            const fach = fachId ? state.faecher.find(f => f.id === fachId) : null;
            const container = document.getElementById('evaluation-content');

            let beobachtungen = state.beobachtungen.filter(b => b.schuelerId === studentId);
            if (fachId) {
                beobachtungen = beobachtungen.filter(b => b.fachId === fachId);
            }

            if (beobachtungen.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <h3>${student.vorname} ${student.nachname}</h3>
                        <p style="color: var(--text-light); margin-top: 12px;">Noch keine Beobachtungen erfasst.</p>
                    </div>
                `;
                return;
            }

            // Radar-Diagramm Daten holen
            const radarData = getRadarDataForStudent(studentId, fachId);

            let html = `
                <!-- Boxplots Detail -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">${student.vorname} ${student.nachname} – Detailbewertung</h2>
                        <button class="btn btn-primary" onclick="applyZeugnisVorschlag('${studentId}', '${fachId || ''}')">
                            Vorschläge übernehmen
                        </button>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light); font-size: 0.9rem;">${beobachtungen.length} Beobachtungen – Klicke auf einen Boxplot für Details</p>
                    <div class="boxplot-container">
            `;

            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            
            enabledKriterien.forEach(krit => {
                const kritBeob = beobachtungen.filter(b => b.kriteriumId === krit.id);
                const ratings = kritBeob.map(b => b.rating);
                const key = `${studentId}-${fachId || 'all'}-${krit.id}`;
                const currentNote = state.zeugnisNoten[key] || 0;
                const tooltip = getBoxplotTooltip(ratings);
                
                // Vorschlag berechnen
                const vorschlag = ratings.length > 0 ? Math.round(ratings.reduce((a, b) => a + b, 0) / ratings.length) : 0;
                const vorschlagSymbol = ['', '–', '=', '+', '++'][vorschlag] || '';
                
                html += `
                    <div class="boxplot-row">
                        <div class="boxplot-label">
                            ${krit.name}
                            <span class="boxplot-info" onclick="showKriteriumInfo('${krit.id}')" title="Indikatoren anzeigen">i</span>
                        </div>
                        <span class="boxplot-divider">–</span>
                        <div class="boxplot-chart" title="${tooltip}" onclick="showDetailModal('${studentId}', '${fachId || ''}', '${krit.id}')" style="cursor: pointer;">
                            ${renderBoxplot(ratings)}
                        </div>
                        <span class="vorschlag-badge" title="Vorschlag: ${vorschlagSymbol || 'keine Daten'}" style="background: ${vorschlag ? 'var(--primary-light)' : 'var(--background)'}; color: ${vorschlag ? 'var(--primary)' : 'var(--text-light)'}; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; min-width: 28px; text-align: center;">
                            ${vorschlag ? vorschlagSymbol : '?'}
                        </span>
                        <div class="zeugnis-select" style="margin-left: 8px;">
                            <button class="zeugnis-btn ${currentNote === 1 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 1)">–</button>
                            <button class="zeugnis-btn ${currentNote === 2 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 2)">=</button>
                            <button class="zeugnis-btn ${currentNote === 3 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 3)">+</button>
                            <button class="zeugnis-btn ${currentNote === 4 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 4)">++</button>
                        </div>
                    </div>
                `;
            });

            html += `
                        <div class="boxplot-row" style="border-bottom: none; padding-top: 0;">
                            <div class="boxplot-label"></div>
                            <span class="boxplot-divider" style="visibility: hidden;">–</span>
                            <div class="boxplot-scale">
                                <span>–</span><span>=</span><span>+</span><span>++</span>
                            </div>
                            <span style="visibility: hidden; padding: 4px 8px; min-width: 28px;">?</span>
                            <div class="zeugnis-select" style="margin-left: 8px; visibility: hidden;">
                                <button class="zeugnis-btn">–</button>
                                <button class="zeugnis-btn">=</button>
                                <button class="zeugnis-btn">+</button>
                                <button class="zeugnis-btn">++</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Radar-Diagramm Übersicht -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Übersicht</h2>
                    </div>
                    <div style="display: flex; justify-content: center; padding: 20px 0;">
                        <canvas id="radar-chart-${studentId}" width="350" height="350"></canvas>
                    </div>
                    <p style="text-align: center; font-size: 0.85rem; color: var(--text-light);">
                        Je grösser die Fläche, desto besser. Mitte = – (nicht genügend), Rand = ++ (sehr gut)
                    </p>
                </div>
            `;

            container.innerHTML = html;
            
            // Radar-Chart zeichnen nach DOM-Update
            setTimeout(() => {
                drawRadarChart(`radar-chart-${studentId}`, radarData.data, radarData.labels);
            }, 50);
        }

        function showFachOverview(fachId) {
            const fach = state.faecher.find(f => f.id === fachId);
            const container = document.getElementById('evaluation-content');

            const beobachtungen = state.beobachtungen.filter(b => b.fachId === fachId);

            let html = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">${fach.name} ${fach.klasse}</h2>
                        <span>${beobachtungen.length} Beobachtungen</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Schüler/in</th>
                                    <th>Beob.</th>
                                    <th>Ø Bewertung</th>
                                    <th>Abdeckung</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            fach.schuelerIds.forEach(sid => {
                const s = state.schueler.find(st => st.id === sid);
                if (!s) return;

                const sBeob = beobachtungen.filter(b => b.schuelerId === sid);
                const avg = sBeob.length > 0 
                    ? (sBeob.reduce((sum, b) => sum + b.rating, 0) / sBeob.length).toFixed(2)
                    : '-';
                
                const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
                const coveredKriterien = new Set(sBeob.map(b => b.kriteriumId)).size;
                const coverage = Math.round((coveredKriterien / enabledKriterien.length) * 100);

                html += `
                    <tr>
                        <td>${s.nachname}, ${s.vorname}</td>
                        <td>${sBeob.length}</td>
                        <td>${avg}</td>
                        <td>
                            <div class="progress-bar" style="width: 100px; height: 6px;">
                                <div class="progress-fill" style="width: ${coverage}%"></div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;" onclick="document.getElementById('eval-student').value='${sid}'; updateEvaluation();">
                                Details
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div>';
            container.innerHTML = html;
        }

        function getBoxplotTooltip(ratings) {
            if (ratings.length === 0) {
                return 'Keine Beobachtungen vorhanden';
            }

            const ratingSymbols = ['', '–', '=', '+', '++'];
            const ratingNames = ['', 'nicht genügend', 'genügend', 'gut', 'sehr gut'];
            
            const sorted = [...ratings].sort((a, b) => a - b);
            const min = sorted[0];
            const max = sorted[sorted.length - 1];
            const avg = (ratings.reduce((a, b) => a + b, 0) / ratings.length);
            
            // Quartile berechnen
            function percentile(arr, p) {
                if (arr.length === 1) return arr[0];
                const index = (arr.length - 1) * p;
                const lower = Math.floor(index);
                const upper = Math.ceil(index);
                const weight = index - lower;
                if (upper >= arr.length) return arr[lower];
                return arr[lower] * (1 - weight) + arr[upper] * weight;
            }
            
            const median = percentile(sorted, 0.5);
            
            // Verteilung zählen
            const counts = [0, 0, 0, 0, 0];
            ratings.forEach(r => counts[r]++);
            
            let tooltip = `${ratings.length} Beobachtungen\n`;
            tooltip += `━━━━━━━━━━━━━━━\n`;
            tooltip += `Tiefster: ${ratingSymbols[min]} (${ratingNames[min]})\n`;
            tooltip += `Median: ${ratingSymbols[Math.round(median)]} (${ratingNames[Math.round(median)]})\n`;
            tooltip += `Höchster: ${ratingSymbols[max]} (${ratingNames[max]})\n`;
            tooltip += `Durchschnitt: ${avg.toFixed(1)}\n`;
            tooltip += `━━━━━━━━━━━━━━━\n`;
            tooltip += `Verteilung:\n`;
            tooltip += `– (nicht genügend): ${counts[1]}x\n`;
            tooltip += `= (genügend): ${counts[2]}x\n`;
            tooltip += `+ (gut): ${counts[3]}x\n`;
            tooltip += `++ (sehr gut): ${counts[4]}x`;
            
            return tooltip;
        }

        function renderBoxplot(ratings) {
            if (ratings.length === 0) {
                return '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; color: var(--text-light);">Keine Daten</div>';
            }

            const sorted = [...ratings].sort((a, b) => a - b);
            const min = sorted[0];
            const max = sorted[sorted.length - 1];
            
            // Verbesserte Quartil-Berechnung (lineare Interpolation)
            function percentile(arr, p) {
                if (arr.length === 1) return arr[0];
                const index = (arr.length - 1) * p;
                const lower = Math.floor(index);
                const upper = Math.ceil(index);
                const weight = index - lower;
                if (upper >= arr.length) return arr[lower];
                return arr[lower] * (1 - weight) + arr[upper] * weight;
            }
            
            const q1 = percentile(sorted, 0.25);
            const median = percentile(sorted, 0.5);
            const q3 = percentile(sorted, 0.75);

            // Scale to percentage (1-4 -> 0-100%), mit Padding für Randwerte
            const scale = (v) => {
                const raw = ((v - 1) / 3) * 100;
                // Padding: 2% vom Rand weg, damit Elemente nicht abgeschnitten werden
                return 2 + (raw * 0.96);
            };

            const boxLeft = scale(q1);
            const boxRight = scale(q3);
            const boxWidth = boxRight - boxLeft;
            const medianPos = scale(median);
            const minPos = scale(min);
            const maxPos = scale(max);

            let html = '';

            // Spezialfall: Alle Werte gleich - nur Median-Linie zeigen
            if (min === max) {
                html += `<div class="boxplot-median" style="left: ${medianPos}%; transform: translateX(-50%);"></div>`;
                return html;
            }

            // Spezialfall: Q1 = Q3 (keine Box, aber Whisker)
            if (q1 === q3) {
                // Linker Whisker
                if (min < q1) {
                    html += `<div class="boxplot-whisker-end" style="left: ${minPos}%; transform: translateX(-50%);"></div>`;
                    html += `<div class="boxplot-whisker" style="left: ${minPos}%; width: ${medianPos - minPos}%;"></div>`;
                }
                // Median
                html += `<div class="boxplot-median" style="left: ${medianPos}%; transform: translateX(-50%);"></div>`;
                // Rechter Whisker
                if (max > q3) {
                    html += `<div class="boxplot-whisker" style="left: ${medianPos}%; width: ${maxPos - medianPos}%;"></div>`;
                    html += `<div class="boxplot-whisker-end" style="left: ${maxPos}%; transform: translateX(-50%);"></div>`;
                }
                return html;
            }

            // Normaler Fall: Box mit Whiskers
            // Linker Whisker
            if (min < q1) {
                html += `<div class="boxplot-whisker-end" style="left: ${minPos}%; transform: translateX(-50%);"></div>`;
                html += `<div class="boxplot-whisker" style="left: ${minPos}%; width: ${boxLeft - minPos}%;"></div>`;
            }

            // Box
            html += `<div class="boxplot-box" style="left: ${boxLeft}%; width: ${boxWidth}%;"></div>`;
            
            // Median
            html += `<div class="boxplot-median" style="left: ${medianPos}%; transform: translateX(-50%);"></div>`;

            // Rechter Whisker
            if (max > q3) {
                html += `<div class="boxplot-whisker" style="left: ${boxRight}%; width: ${maxPos - boxRight}%;"></div>`;
                html += `<div class="boxplot-whisker-end" style="left: ${maxPos}%; transform: translateX(-50%);"></div>`;
            }

            return html;
        }

        function setZeugnisNote(key, note) {
            // Toggle: Wenn gleiche Note nochmal geklickt wird, deaktivieren
            if (state.zeugnisNoten[key] === note) {
                delete state.zeugnisNoten[key];
            } else {
                state.zeugnisNoten[key] = note;
            }
            saveState();
            updateEvaluation();
        }

        function applyZeugnisVorschlag(studentId, fachId) {
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);
            let applied = 0;
            
            enabledKriterien.forEach(krit => {
                let beobachtungen = state.beobachtungen.filter(b => 
                    b.schuelerId === studentId && b.kriteriumId === krit.id
                );
                if (fachId) {
                    beobachtungen = beobachtungen.filter(b => b.fachId === fachId);
                }
                
                if (beobachtungen.length > 0) {
                    const ratings = beobachtungen.map(b => b.rating);
                    const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length;
                    const vorschlag = Math.round(avg);
                    
                    const key = `${studentId}-${fachId || 'all'}-${krit.id}`;
                    state.zeugnisNoten[key] = vorschlag;
                    applied++;
                }
            });
            
            saveState();
            updateEvaluation();
            showToast(`${applied} Vorschläge übernommen`, 'success');
        }

        function showDetailModal(studentId, fachId, kriteriumId) {
            const student = state.schueler.find(s => s.id === studentId);
            const krit = KRITERIEN.find(k => k.id === kriteriumId);
            
            let beobachtungen = state.beobachtungen.filter(b => 
                b.schuelerId === studentId && b.kriteriumId === kriteriumId
            );
            if (fachId) {
                beobachtungen = beobachtungen.filter(b => b.fachId === fachId);
            }

            document.getElementById('modal-title').textContent = 
                `${student.vorname} ${student.nachname} - ${krit.id}`;

            let html = `<p style="margin-bottom: 16px; color: var(--text-light);">${krit.name}</p>`;
            
            if (beobachtungen.length === 0) {
                html += '<p>Keine Beobachtungen vorhanden.</p>';
            } else {
                html += '<table style="width: 100%;"><thead><tr><th>Datum</th><th>Indikator</th><th>Bewertung</th></tr></thead><tbody>';
                
                beobachtungen.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                beobachtungen.forEach(b => {
                    const date = new Date(b.timestamp).toLocaleDateString('de-CH');
                    const ratingLabels = ['', 'nicht genügend', 'genügend', 'gut', 'sehr gut'];
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td style="font-size: 0.9rem;">${b.indikator}</td>
                            <td><span class="chip">${b.rating} - ${ratingLabels[b.rating]}</span></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }

            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('detail-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        function showKriteriumInfo(kriteriumId) {
            const krit = KRITERIEN.find(k => k.id === kriteriumId);
            const standardIndikatoren = INDIKATOREN[kriteriumId] || [];
            const customIndikatoren = state.customIndikatoren[kriteriumId] || [];
            
            document.getElementById('modal-title').textContent = `${krit.id} – ${krit.name}`;
            
            let html = `
                <p style="margin-bottom: 16px; color: var(--text-light);">
                    <strong>Bereich:</strong> ${krit.bereich}
                </p>
                <h4 style="margin-bottom: 12px;">Aktive Indikatoren:</h4>
                <ul style="margin: 0; padding-left: 20px;">
            `;
            
            // Standard-Indikatoren
            standardIndikatoren.forEach((ind, index) => {
                const enabled = isIndikatorEnabled(kriteriumId, index, false);
                if (enabled) {
                    html += `<li style="margin-bottom: 8px; line-height: 1.5;">${ind}</li>`;
                }
            });
            
            // Custom-Indikatoren
            customIndikatoren.forEach((ind, index) => {
                const enabled = isIndikatorEnabled(kriteriumId, index, true);
                if (enabled) {
                    html += `<li style="margin-bottom: 8px; line-height: 1.5;">${ind} <span style="font-size: 0.75rem; color: var(--primary);">(eigener)</span></li>`;
                }
            });
            
            html += '</ul>';
            
            // Deaktivierte Indikatoren anzeigen falls vorhanden
            const disabledIndikatoren = [];
            standardIndikatoren.forEach((ind, index) => {
                if (!isIndikatorEnabled(kriteriumId, index, false)) {
                    disabledIndikatoren.push(ind);
                }
            });
            customIndikatoren.forEach((ind, index) => {
                if (!isIndikatorEnabled(kriteriumId, index, true)) {
                    disabledIndikatoren.push(ind + ' (eigener)');
                }
            });
            
            if (disabledIndikatoren.length > 0) {
                html += `
                    <h4 style="margin: 16px 0 12px 0; color: var(--text-light);">Deaktivierte Indikatoren:</h4>
                    <ul style="margin: 0; padding-left: 20px; color: var(--text-light);">
                `;
                disabledIndikatoren.forEach(ind => {
                    html += `<li style="margin-bottom: 8px; line-height: 1.5; text-decoration: line-through;">${ind}</li>`;
                });
                html += '</ul>';
            }
            
            html += `
                <p style="margin-top: 16px; font-size: 0.85rem; color: var(--text-light);">
                    Indikatoren können unter <strong>Konfiguration → LAS-Kriterien</strong> angepasst werden.
                </p>
            `;
            
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('detail-modal').classList.add('active');
        }

        // ========================================
        // OBSERVATION MODAL
        // ========================================

        function openObservationModal() {
            const currentFach = getCurrentFach();
            if (!currentFach) {
                showToast('Keine aktuelle Lektion erkannt', 'error');
                return;
            }

            // Status zurücksetzen
            alertFachId = null;

            const questionsCount = state.semester.questionsPerRound || calculateMinQuestionsPerLesson();
            currentSession.fachId = currentFach.id;
            currentSession.questions = generateQuestions(currentFach.id, questionsCount);
            currentSession.currentIndex = 0;
            currentSession.completed = 0;

            if (currentSession.questions.length === 0) {
                showToast('Keine Fragen verfügbar', 'error');
                return;
            }

            document.getElementById('obs-modal-fach').textContent = `${currentFach.name} ${currentFach.klasse}`;
            document.getElementById('obs-question-total').textContent = currentSession.questions.length;
            
            showModalQuestion();
            document.getElementById('observation-modal').classList.add('active');
        }

        function showModalQuestion() {
            const q = currentSession.questions[currentSession.currentIndex];
            const schueler = state.schueler.find(s => s.id === q.schuelerId);
            const krit = KRITERIEN.find(k => k.id === q.kriteriumId);

            document.getElementById('obs-question-number').textContent = currentSession.currentIndex + 1;
            document.getElementById('obs-student').textContent = `${schueler.vorname} ${schueler.nachname}`;
            document.getElementById('obs-kriterium').textContent = `${krit.id} ${krit.bereich}`;
            document.getElementById('obs-indicator').textContent = q.indikator;

            const progress = (currentSession.currentIndex / currentSession.questions.length) * 100;
            document.getElementById('obs-session-progress').textContent = Math.round(progress) + '%';
            document.getElementById('obs-progress-fill').style.width = progress + '%';
        }

        function submitModalRating(rating) {
            const q = currentSession.questions[currentSession.currentIndex];

            if (rating > 0) {
                state.beobachtungen.push({
                    id: Date.now().toString(),
                    schuelerId: q.schuelerId,
                    fachId: currentSession.fachId,
                    kriteriumId: q.kriteriumId,
                    indikator: q.indikator,
                    rating,
                    timestamp: new Date().toISOString()
                });
                currentSession.completed++;
                saveState();
            }

            currentSession.currentIndex++;

            if (currentSession.currentIndex >= currentSession.questions.length) {
                closeObservationModal();
                showObservationCompleteModal();
            } else {
                showModalQuestion();
            }

            updateStats();
        }

        function closeObservationModal() {
            document.getElementById('observation-modal').classList.remove('active');
            // Dashboard aktualisieren, damit "noch zu erledigen" wieder angezeigt wird
            updateDashboard();
        }

        function showObservationCompleteModal() {
            document.getElementById('obs-completed-count').textContent = currentSession.completed;
            document.getElementById('observation-complete-modal').classList.add('active');
        }

        function closeObservationCompleteModal() {
            document.getElementById('observation-complete-modal').classList.remove('active');
            updateDashboard();
        }

        function startNewObservationRound() {
            closeObservationCompleteModal();
            openObservationModal();
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================

        document.addEventListener('keydown', function(e) {
            // Nur wenn Observation-Modal aktiv ist
            const obsModal = document.getElementById('observation-modal');
            if (!obsModal || !obsModal.classList.contains('active')) return;
            
            // Nicht bei Input-Feldern
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    submitModalRating(1);
                    break;
                case '2':
                    e.preventDefault();
                    submitModalRating(2);
                    break;
                case '3':
                    e.preventDefault();
                    submitModalRating(3);
                    break;
                case '4':
                    e.preventDefault();
                    submitModalRating(4);
                    break;
                case '0':
                case 's':
                case 'S':
                    e.preventDefault();
                    submitModalRating(0);
                    break;
                case 'Escape':
                    e.preventDefault();
                    closeObservationModal();
                    break;
            }
        });

        // ========================================
        // CONFIGURATION
        // ========================================

        function updateSemesterConfig() {
            document.getElementById('config-semester-name').value = state.semester.name || '';
            document.getElementById('config-semester-start').value = state.semester.start;
            document.getElementById('config-semester-end').value = state.semester.end;
            document.getElementById('config-target').value = state.semester.targetObservations;
            document.getElementById('config-questions-per-round').value = state.semester.questionsPerRound || 13;
            
            // Erinnerungs-Einstellungen
            document.getElementById('config-reminder-timing').value = state.semester.reminderTiming || 'end-5';
            document.getElementById('config-reminder-sound').checked = state.semester.reminderSound !== false;
            document.getElementById('config-pending-retention').value = state.semester.pendingRetention || 'day-end';
            
            // Beobachtungs-Einstellungen
            document.getElementById('config-max-per-student').value = state.semester.maxQuestionsPerStudent || 3;
            document.getElementById('config-prioritize-gaps').checked = state.semester.prioritizeGaps !== false;
            
            updateMinQuestionsDisplay();
            updateFerienList();
        }

        function calculateMinQuestionsPerLesson() {
            // Zähle Schüler-Fach-Kombinationen
            let totalCombinations = 0;
            state.faecher.forEach(fach => {
                if (state.faecherEnabled[fach.id]) {
                    totalCombinations += fach.schuelerIds.length;
                }
            });

            // Zähle aktivierte Kriterien
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false).length;

            // Gesamtanzahl nötige Beobachtungen
            const totalObservations = totalCombinations * enabledKriterien * state.semester.targetObservations;

            // Zähle Lektionen pro Woche aus Stundenplan
            let lessonsPerWeek = 0;
            state.stundenplan.forEach(lektion => {
                ['mo', 'di', 'mi', 'do', 'fr'].forEach(day => {
                    if (lektion[day] && state.faecherEnabled[lektion[day]]) {
                        lessonsPerWeek++;
                    }
                });
            });

            if (lessonsPerWeek === 0) return 13; // Fallback

            // Wochen im Semester berechnen
            const start = new Date(state.semester.start);
            const end = new Date(state.semester.end);
            const weeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));

            // Gesamtanzahl Lektionen
            const totalLessons = lessonsPerWeek * weeks;

            if (totalLessons === 0) return 13; // Fallback

            // Minimum pro Lektion (aufgerundet)
            return Math.ceil(totalObservations / totalLessons);
        }

        function updateMinQuestionsDisplay() {
            const min = calculateMinQuestionsPerLesson();
            document.getElementById('min-questions-display').textContent = min;
            
            // Falls noch keine questionsPerRound gesetzt ist, setze auf Minimum
            if (!state.semester.questionsPerRound) {
                state.semester.questionsPerRound = min;
                document.getElementById('config-questions-per-round').value = min;
            }
        }

        function saveSemesterConfig() {
            state.semester.name = document.getElementById('config-semester-name').value.trim();
            state.semester.start = document.getElementById('config-semester-start').value;
            state.semester.end = document.getElementById('config-semester-end').value;
            state.semester.targetObservations = parseInt(document.getElementById('config-target').value) || 3;
            state.semester.questionsPerRound = parseInt(document.getElementById('config-questions-per-round').value) || 13;
            
            // Erinnerungs-Einstellungen
            state.semester.reminderTiming = document.getElementById('config-reminder-timing').value;
            state.semester.reminderSound = document.getElementById('config-reminder-sound').checked;
            state.semester.pendingRetention = document.getElementById('config-pending-retention').value;
            
            // Beobachtungs-Einstellungen
            state.semester.maxQuestionsPerStudent = parseInt(document.getElementById('config-max-per-student').value) || 3;
            state.semester.prioritizeGaps = document.getElementById('config-prioritize-gaps').checked;
            
            saveState();
            updateStats();
            updateDashboard(); // Semester-Name im Dashboard aktualisieren
            updateMinQuestionsDisplay();
            showToast('Einstellungen gespeichert', 'success');
        }

        function updateKriterienList() {
            const container = document.getElementById('kriterien-list');
            let html = '';

            KRITERIEN.forEach(krit => {
                const enabled = state.kriterienEnabled[krit.id] !== false;
                const standardIndikatoren = INDIKATOREN[krit.id] || [];
                const customIndikatoren = state.customIndikatoren[krit.id] || [];
                const totalCount = standardIndikatoren.length + customIndikatoren.length;
                const enabledCount = getEnabledIndikatorenCount(krit.id);
                
                html += `
                    <div class="kriterium-item" style="border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0;">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="toggleKriteriumExpand('${krit.id}')">
                                <span class="expand-icon" id="expand-${krit.id}" style="font-size: 0.8rem; color: var(--text-light); transition: transform 0.2s;">▶</span>
                                <div>
                                    <strong>${krit.id}</strong> ${krit.name}
                                    <div style="font-size: 0.85rem; color: var(--text-light);">
                                        ${krit.bereich} – ${enabledCount}/${totalCount} Indikatoren aktiv
                                    </div>
                                </div>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleKriterium('${krit.id}')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="indikatoren-list" id="indikatoren-${krit.id}" style="display: none; padding: 0 0 16px 32px;">
                            ${renderIndikatorenList(krit.id, standardIndikatoren, customIndikatoren)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderIndikatorenList(kritId, standardIndikatoren, customIndikatoren) {
            let html = '';
            
            // Standard-Indikatoren
            standardIndikatoren.forEach((ind, index) => {
                const enabled = isIndikatorEnabled(kritId, index, false);
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" ${enabled ? 'checked' : ''} 
                            onchange="toggleIndikator('${kritId}', ${index}, false)"
                            style="cursor: pointer;">
                        <span style="flex: 1; font-size: 0.9rem;">${ind}</span>
                        <span style="font-size: 0.75rem; color: var(--text-light); background: var(--background); padding: 2px 6px; border-radius: 4px;">Standard</span>
                    </div>
                `;
            });
            
            // Custom-Indikatoren
            customIndikatoren.forEach((ind, index) => {
                const enabled = isIndikatorEnabled(kritId, index, true);
                html += `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border);">
                        <input type="checkbox" ${enabled ? 'checked' : ''} 
                            onchange="toggleIndikator('${kritId}', ${index}, true)"
                            style="cursor: pointer;">
                        <span style="flex: 1; font-size: 0.9rem;" id="custom-ind-${kritId}-${index}">${ind}</span>
                        <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem;" 
                            onclick="editCustomIndikator('${kritId}', ${index})">✎</button>
                        <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.75rem; color: var(--danger);" 
                            onclick="deleteCustomIndikator('${kritId}', ${index})">✕</button>
                    </div>
                `;
            });
            
            // Hinzufügen-Button
            html += `
                <div style="padding: 8px 0;">
                    <div id="add-indikator-form-${kritId}" style="display: none; margin-bottom: 8px;">
                        <input type="text" id="new-indikator-${kritId}" class="form-input" 
                            placeholder="Neuen Indikator eingeben..." style="font-size: 0.9rem; margin-bottom: 8px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" style="padding: 4px 12px; font-size: 0.85rem;" 
                                onclick="saveNewIndikator('${kritId}')">Speichern</button>
                            <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;" 
                                onclick="cancelNewIndikator('${kritId}')">Abbrechen</button>
                        </div>
                    </div>
                    <button id="add-indikator-btn-${kritId}" class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;" 
                        onclick="showAddIndikatorForm('${kritId}')">
                        + Eigenen Indikator hinzufügen
                    </button>
                </div>
                <div style="padding-top: 8px; border-top: 1px solid var(--border); margin-top: 8px;">
                    <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.8rem; color: var(--text-light);" 
                        onclick="resetIndikatoren('${kritId}')">
                        ↺ Auf Standard zurücksetzen
                    </button>
                </div>
            `;
            
            return html;
        }

        function isIndikatorEnabled(kritId, index, isCustom) {
            const key = isCustom ? `${kritId}-custom` : kritId;
            if (!state.indikatorenEnabled[key]) return true; // Default: enabled
            if (state.indikatorenEnabled[key][index] === undefined) return true;
            return state.indikatorenEnabled[key][index];
        }

        function getEnabledIndikatorenCount(kritId) {
            const standardIndikatoren = INDIKATOREN[kritId] || [];
            const customIndikatoren = state.customIndikatoren[kritId] || [];
            let count = 0;
            
            standardIndikatoren.forEach((_, index) => {
                if (isIndikatorEnabled(kritId, index, false)) count++;
            });
            customIndikatoren.forEach((_, index) => {
                if (isIndikatorEnabled(kritId, index, true)) count++;
            });
            
            return count;
        }

        function toggleKriteriumExpand(kritId) {
            const list = document.getElementById(`indikatoren-${kritId}`);
            const icon = document.getElementById(`expand-${kritId}`);
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            } else {
                list.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleIndikator(kritId, index, isCustom) {
            const key = isCustom ? `${kritId}-custom` : kritId;
            if (!state.indikatorenEnabled[key]) {
                state.indikatorenEnabled[key] = {};
            }
            
            const currentValue = state.indikatorenEnabled[key][index];
            state.indikatorenEnabled[key][index] = currentValue === false ? true : false;
            
            saveState();
            updateKriterienList();
            
            // Liste wieder aufklappen
            const list = document.getElementById(`indikatoren-${kritId}`);
            const icon = document.getElementById(`expand-${kritId}`);
            if (list) {
                list.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            }
        }

        function showAddIndikatorForm(kritId) {
            document.getElementById(`add-indikator-form-${kritId}`).style.display = 'block';
            document.getElementById(`add-indikator-btn-${kritId}`).style.display = 'none';
            document.getElementById(`new-indikator-${kritId}`).focus();
        }

        function cancelNewIndikator(kritId) {
            document.getElementById(`add-indikator-form-${kritId}`).style.display = 'none';
            document.getElementById(`add-indikator-btn-${kritId}`).style.display = 'inline-block';
            document.getElementById(`new-indikator-${kritId}`).value = '';
        }

        function saveNewIndikator(kritId) {
            const input = document.getElementById(`new-indikator-${kritId}`);
            const text = input.value.trim();
            
            if (!text) {
                showToast('Bitte Text eingeben', 'error');
                return;
            }
            
            if (!state.customIndikatoren[kritId]) {
                state.customIndikatoren[kritId] = [];
            }
            
            state.customIndikatoren[kritId].push(text);
            saveState();
            updateKriterienList();
            showToast('Indikator hinzugefügt', 'success');
            
            // Liste wieder aufklappen
            setTimeout(() => {
                const list = document.getElementById(`indikatoren-${kritId}`);
                const icon = document.getElementById(`expand-${kritId}`);
                if (list) {
                    list.style.display = 'block';
                    icon.style.transform = 'rotate(90deg)';
                }
            }, 50);
        }

        function editCustomIndikator(kritId, index) {
            const newText = prompt('Indikator bearbeiten:', state.customIndikatoren[kritId][index]);
            if (newText !== null && newText.trim()) {
                state.customIndikatoren[kritId][index] = newText.trim();
                saveState();
                updateKriterienList();
                showToast('Indikator aktualisiert', 'success');
                
                // Liste wieder aufklappen
                setTimeout(() => {
                    const list = document.getElementById(`indikatoren-${kritId}`);
                    const icon = document.getElementById(`expand-${kritId}`);
                    if (list) {
                        list.style.display = 'block';
                        icon.style.transform = 'rotate(90deg)';
                    }
                }, 50);
            }
        }

        function deleteCustomIndikator(kritId, index) {
            if (confirm('Diesen Indikator wirklich löschen?')) {
                state.customIndikatoren[kritId].splice(index, 1);
                
                // Auch die enabled-Einstellungen anpassen
                const key = `${kritId}-custom`;
                if (state.indikatorenEnabled[key]) {
                    delete state.indikatorenEnabled[key][index];
                    // Indizes neu nummerieren
                    const newEnabled = {};
                    Object.keys(state.indikatorenEnabled[key]).forEach(k => {
                        const oldIndex = parseInt(k);
                        if (oldIndex > index) {
                            newEnabled[oldIndex - 1] = state.indikatorenEnabled[key][k];
                        } else {
                            newEnabled[oldIndex] = state.indikatorenEnabled[key][k];
                        }
                    });
                    state.indikatorenEnabled[key] = newEnabled;
                }
                
                saveState();
                updateKriterienList();
                showToast('Indikator gelöscht', 'success');
                
                // Liste wieder aufklappen
                setTimeout(() => {
                    const list = document.getElementById(`indikatoren-${kritId}`);
                    const icon = document.getElementById(`expand-${kritId}`);
                    if (list) {
                        list.style.display = 'block';
                        icon.style.transform = 'rotate(90deg)';
                    }
                }, 50);
            }
        }

        function resetIndikatoren(kritId) {
            if (confirm(`Alle Indikatoren für "${kritId}" auf Standard zurücksetzen?\n\nDies aktiviert alle Standard-Indikatoren und löscht eigene Indikatoren.`)) {
                // Enabled-Status zurücksetzen
                delete state.indikatorenEnabled[kritId];
                delete state.indikatorenEnabled[`${kritId}-custom`];
                
                // Custom-Indikatoren löschen
                delete state.customIndikatoren[kritId];
                
                saveState();
                updateKriterienList();
                showToast('Indikatoren zurückgesetzt', 'success');
                
                // Liste wieder aufklappen
                setTimeout(() => {
                    const list = document.getElementById(`indikatoren-${kritId}`);
                    const icon = document.getElementById(`expand-${kritId}`);
                    if (list) {
                        list.style.display = 'block';
                        icon.style.transform = 'rotate(90deg)';
                    }
                }, 50);
            }
        }

        function getActiveIndikatoren(kritId) {
            // Gibt alle aktiven Indikatoren für ein Kriterium zurück
            const result = [];
            
            const standardIndikatoren = INDIKATOREN[kritId] || [];
            standardIndikatoren.forEach((ind, index) => {
                if (isIndikatorEnabled(kritId, index, false)) {
                    result.push(ind);
                }
            });
            
            const customIndikatoren = state.customIndikatoren[kritId] || [];
            customIndikatoren.forEach((ind, index) => {
                if (isIndikatorEnabled(kritId, index, true)) {
                    result.push(ind);
                }
            });
            
            return result;
        }

        // ========================================
        // FERIEN MANAGEMENT
        // ========================================

        function updateFerienList() {
            const container = document.getElementById('ferien-list');
            if (!container) return;
            
            if (!state.ferien || state.ferien.length === 0) {
                container.innerHTML = '<p style="color: var(--text-light); font-style: italic;">Keine Ferien erfasst</p>';
                return;
            }
            
            // Nach Startdatum sortieren
            const sortedFerien = [...state.ferien].sort((a, b) => new Date(a.start) - new Date(b.start));
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            sortedFerien.forEach(ferien => {
                const startDate = new Date(ferien.start).toLocaleDateString('de-CH');
                const endDate = new Date(ferien.end).toLocaleDateString('de-CH');
                const isActive = isDateInFerien(new Date());
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: ${isActive ? 'rgba(8, 145, 178, 0.1)' : 'var(--background)'}; border-radius: var(--radius); border: 1px solid var(--border);">
                        <div>
                            <strong>${ferien.name}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-light);">${startDate} – ${endDate}</div>
                        </div>
                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; color: var(--danger);" 
                            onclick="deleteFerien('${ferien.id}')">✕</button>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function addFerien() {
            const name = document.getElementById('ferien-name').value.trim();
            const start = document.getElementById('ferien-start').value;
            const end = document.getElementById('ferien-end').value;
            
            if (!name || !start || !end) {
                showToast('Bitte alle Felder ausfüllen', 'error');
                return;
            }
            
            if (new Date(start) > new Date(end)) {
                showToast('Startdatum muss vor Enddatum liegen', 'error');
                return;
            }
            
            if (!state.ferien) state.ferien = [];
            
            state.ferien.push({
                id: Date.now().toString(),
                name,
                start,
                end
            });
            
            saveState();
            updateFerienList();
            
            // Felder leeren
            document.getElementById('ferien-name').value = '';
            document.getElementById('ferien-start').value = '';
            document.getElementById('ferien-end').value = '';
            
            showToast('Ferien hinzugefügt', 'success');
        }

        function deleteFerien(ferienId) {
            if (confirm('Diese Ferien wirklich löschen?')) {
                state.ferien = state.ferien.filter(f => f.id !== ferienId);
                saveState();
                updateFerienList();
                showToast('Ferien gelöscht', 'success');
            }
        }

        async function importFerienFromAPI() {
            const kantonCode = document.getElementById('import-kanton').value;
            
            if (!kantonCode) {
                showToast('Bitte einen Kanton wählen', 'error');
                return;
            }
            
            // Zeitraum: aktuelles Schuljahr + nächstes Jahr
            const now = new Date();
            const year = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
            const validFrom = `${year}-08-01`;
            const validTo = `${year + 2}-07-31`;
            
            const url = `https://openholidaysapi.org/SchoolHolidays?countryIsoCode=CH&subdivisionCode=${kantonCode}&validFrom=${validFrom}&validTo=${validTo}&languageIsoCode=DE`;
            
            try {
                showToast('Lade Ferien...', 'success');
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data || data.length === 0) {
                    showToast('Keine Ferien gefunden für diesen Kanton', 'error');
                    return;
                }
                
                // Ferien konvertieren und hinzufügen
                if (!state.ferien) state.ferien = [];
                
                let added = 0;
                data.forEach(holiday => {
                    const name = holiday.name?.[0]?.text || holiday.type || 'Ferien';
                    const start = holiday.startDate;
                    const end = holiday.endDate;
                    
                    // Prüfen ob diese Ferien schon existieren (gleiches Datum)
                    const exists = state.ferien.some(f => 
                        f.start === start && f.end === end
                    );
                    
                    if (!exists && start && end) {
                        state.ferien.push({
                            id: Date.now().toString() + added,
                            name,
                            start,
                            end
                        });
                        added++;
                    }
                });
                
                // Nach Datum sortieren
                state.ferien.sort((a, b) => new Date(a.start) - new Date(b.start));
                
                saveState();
                updateFerienList();
                
                const kantonName = document.getElementById('import-kanton').selectedOptions[0].text;
                showToast(`${added} Ferien für ${kantonName} importiert`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Ferien:', error);
                showToast('Fehler beim Laden. Bitte später erneut versuchen.', 'error');
            }
        }

        function isDateInFerien(date) {
            if (!state.ferien || state.ferien.length === 0) return false;
            
            const checkDate = new Date(date);
            checkDate.setHours(12, 0, 0, 0); // Mittag, um Zeitzonenprobleme zu vermeiden
            
            return state.ferien.some(ferien => {
                const start = new Date(ferien.start);
                const end = new Date(ferien.end);
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                return checkDate >= start && checkDate <= end;
            });
        }

        function isInFerien() {
            // Prüft ob heute Ferien sind (berücksichtigt auch Test-Modus)
            if (testMode.active) {
                // Im Test-Modus: Simuliertes Datum berechnen
                // Für Einfachheit: Ferien im Test-Modus ignorieren oder aktuelles Datum verwenden
                return isDateInFerien(new Date());
            }
            return isDateInFerien(new Date());
        }

        // ========================================
        // SEMESTER-ARCHIV
        // ========================================

        function archiveSemester() {
            const name = document.getElementById('archive-name').value.trim();
            
            if (!name) {
                showToast('Bitte eine Bezeichnung eingeben', 'error');
                return;
            }
            
            // Prüfen ob Daten vorhanden sind
            if (state.beobachtungen.length === 0) {
                showToast('Keine Beobachtungen zum Archivieren vorhanden', 'error');
                return;
            }
            
            // Bestätigung
            const beobCount = state.beobachtungen.length;
            const zeugnisCount = Object.keys(state.zeugnisNoten).length;
            
            if (!confirm(`Semester "${name}" archivieren?\n\n` +
                `• ${beobCount} Beobachtungen\n` +
                `• ${zeugnisCount} Zeugnisnoten\n\n` +
                `Die aktuellen Daten werden archiviert und das Semester wird für einen Neustart zurückgesetzt.`)) {
                return;
            }
            
            // Archiv erstellen
            const archive = {
                id: Date.now().toString(),
                name: name,
                closedAt: new Date().toISOString(),
                semester: { ...state.semester },
                beobachtungen: [...state.beobachtungen],
                zeugnisNoten: { ...state.zeugnisNoten },
                schueler: JSON.parse(JSON.stringify(state.schueler)),
                faecher: JSON.parse(JSON.stringify(state.faecher)),
                kriterienEnabled: { ...state.kriterienEnabled }
            };
            
            // Zum Archiv hinzufügen
            if (!state.archive) state.archive = [];
            state.archive.push(archive);
            
            // Aktuelles Semester zurücksetzen
            state.beobachtungen = [];
            state.zeugnisNoten = {};
            state.pendingLessons = [];
            
            // Neues Semester-Datum setzen (Start = heute)
            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + 5); // Ca. 5 Monate später
            
            state.semester.name = ''; // Neuer Name für neues Semester
            state.semester.start = today.toISOString().split('T')[0];
            state.semester.end = endDate.toISOString().split('T')[0];
            
            // Ferien leeren (neues Semester = neue Ferien)
            state.ferien = [];
            
            saveState();
            
            // UI aktualisieren
            document.getElementById('archive-name').value = '';
            updateArchiveList();
            updateSemesterConfig();
            updateStats();
            updateDashboard();
            
            showToast(`Semester "${name}" archiviert!`, 'success');
        }

        function updateArchiveList() {
            const container = document.getElementById('archive-list');
            if (!container) return;
            
            if (!state.archive || state.archive.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom: 12px; opacity: 0.5;">
                            <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                        </svg>
                        <p>Noch keine archivierten Semester.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<h4 style="margin-bottom: 12px;">Archivierte Semester</h4>';
            
            // Neueste zuerst
            const sortedArchive = [...state.archive].sort((a, b) => 
                new Date(b.closedAt) - new Date(a.closedAt)
            );
            
            sortedArchive.forEach(archive => {
                const closedDate = new Date(archive.closedAt).toLocaleDateString('de-CH');
                const beobCount = archive.beobachtungen?.length || 0;
                const zeugnisCount = Object.keys(archive.zeugnisNoten || {}).length;
                const schuelerCount = archive.schueler?.length || 0;
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg); border-radius: var(--radius); margin-bottom: 8px; border: 1px solid var(--border);">
                        <div>
                            <strong>${archive.name}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Abgeschlossen: ${closedDate} · ${beobCount} Beobachtungen · ${schuelerCount} Schüler
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="viewArchivedSemester('${archive.id}')">
                                Ansehen
                            </button>
                            <button class="btn btn-secondary btn-sm" style="color: var(--danger);" onclick="deleteArchivedSemester('${archive.id}')">
                                ×
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function viewArchivedSemester(archiveId) {
            const archive = state.archive.find(a => a.id === archiveId);
            if (!archive) return;
            
            // Modal mit Zusammenfassung anzeigen
            const closedDate = new Date(archive.closedAt).toLocaleDateString('de-CH');
            const semesterStart = new Date(archive.semester.start).toLocaleDateString('de-CH');
            const semesterEnd = new Date(archive.semester.end).toLocaleDateString('de-CH');
            
            // Statistiken berechnen
            const beobCount = archive.beobachtungen?.length || 0;
            const zeugnisNoten = archive.zeugnisNoten || {};
            
            // Zeugnisnoten nach Fach gruppieren
            let zeugnisHtml = '';
            if (Object.keys(zeugnisNoten).length > 0) {
                const RATING_LABELS = { 1: '–', 2: '=', 3: '+', 4: '++' };
                
                // Nach Fach gruppieren
                const byFach = {};
                Object.entries(zeugnisNoten).forEach(([key, ratings]) => {
                    const [schuelerId, fachId] = key.split('_');
                    if (!byFach[fachId]) byFach[fachId] = [];
                    
                    const schueler = archive.schueler.find(s => s.id === schuelerId);
                    const schuelerName = schueler ? `${schueler.vorname} ${schueler.nachname}` : 'Unbekannt';
                    
                    byFach[fachId].push({ schuelerName, ratings });
                });
                
                Object.entries(byFach).forEach(([fachId, entries]) => {
                    const fach = archive.faecher.find(f => f.id === fachId);
                    const fachName = fach ? `${fach.name} ${fach.klasse}` : fachId;
                    
                    zeugnisHtml += `<div style="margin-top: 16px;"><strong>${fachName}</strong></div>`;
                    zeugnisHtml += '<div style="font-size: 0.9rem; margin-top: 8px;">';
                    
                    entries.forEach(({ schuelerName, ratings }) => {
                        const ratingStr = Object.entries(ratings)
                            .map(([k, v]) => `${k}: ${RATING_LABELS[v] || v}`)
                            .join(', ');
                        zeugnisHtml += `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">${schuelerName}: ${ratingStr}</div>`;
                    });
                    
                    zeugnisHtml += '</div>';
                });
            }
            
            // Modal erstellen und anzeigen
            const modalHtml = `
                <div class="modal-overlay active" id="archive-view-modal" onclick="if(event.target===this)this.remove()">
                    <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">${archive.name}</h3>
                            <button class="modal-close" onclick="document.getElementById('archive-view-modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                                <div style="background: var(--bg); padding: 12px; border-radius: var(--radius);">
                                    <div style="font-size: 0.85rem; color: var(--text-light);">Zeitraum</div>
                                    <div style="font-weight: 500;">${semesterStart} – ${semesterEnd}</div>
                                </div>
                                <div style="background: var(--bg); padding: 12px; border-radius: var(--radius);">
                                    <div style="font-size: 0.85rem; color: var(--text-light);">Abgeschlossen</div>
                                    <div style="font-weight: 500;">${closedDate}</div>
                                </div>
                                <div style="background: var(--bg); padding: 12px; border-radius: var(--radius);">
                                    <div style="font-size: 0.85rem; color: var(--text-light);">Beobachtungen</div>
                                    <div style="font-weight: 500;">${beobCount}</div>
                                </div>
                                <div style="background: var(--bg); padding: 12px; border-radius: var(--radius);">
                                    <div style="font-size: 0.85rem; color: var(--text-light);">Schüler</div>
                                    <div style="font-weight: 500;">${archive.schueler?.length || 0}</div>
                                </div>
                            </div>
                            
                            ${zeugnisHtml ? `
                                <h4 style="margin-bottom: 8px;">Zeugnisnoten</h4>
                                ${zeugnisHtml}
                            ` : '<p style="color: var(--text-light);">Keine Zeugnisnoten erfasst.</p>'}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="exportArchivedSemester('${archive.id}')">
                                Als JSON exportieren
                            </button>
                            <button class="btn btn-primary" onclick="document.getElementById('archive-view-modal').remove()">
                                Schliessen
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function deleteArchivedSemester(archiveId) {
            const archive = state.archive.find(a => a.id === archiveId);
            if (!archive) return;
            
            if (!confirm(`Archiviertes Semester "${archive.name}" unwiderruflich löschen?`)) return;
            
            state.archive = state.archive.filter(a => a.id !== archiveId);
            saveState();
            updateArchiveList();
            showToast('Archiv gelöscht', 'success');
        }

        function exportArchivedSemester(archiveId) {
            const archive = state.archive.find(a => a.id === archiveId);
            if (!archive) return;
            
            const dataStr = JSON.stringify(archive, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `LASSO-Archiv-${archive.name.replace(/[^a-zA-Z0-9]/g, '-')}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Export gestartet', 'success');
        }

        function toggleKriterium(kritId) {
            state.kriterienEnabled[kritId] = state.kriterienEnabled[kritId] === false ? true : false;
            saveState();
            updateStats();
            updateKriterienList();
        }

        function updateFaecherList() {
            const container = document.getElementById('faecher-list');
            if (!container) return; // Element wurde entfernt
            
            let html = '';

            state.faecher.forEach(fach => {
                const enabled = state.faecherEnabled[fach.id] !== false;
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                        <div>
                            <strong>${fach.name}</strong> ${fach.klasse}
                            <div style="font-size: 0.85rem; color: var(--text-light);">${fach.schuelerIds.length} Schüler</div>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleFach('${fach.id}')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleFach(fachId) {
            state.faecherEnabled[fachId] = !state.faecherEnabled[fachId];
            saveState();
            updateFachSelects();
            updateStats();
        }

        function showSchuelerList() {
            const fachSelect = document.getElementById('config-schueler-fach');
            const container = document.getElementById('schueler-list-container');
            
            if (!fachSelect || !container) return; // Elemente wurden entfernt

            const fachId = fachSelect.value;

            if (!fachId) {
                container.innerHTML = '';
                return;
            }

            const fach = state.faecher.find(f => f.id === fachId);
            let html = '<table style="width: 100%;"><thead><tr><th>#</th><th>Nachname</th><th>Vorname</th></tr></thead><tbody>';

            fach.schuelerIds.forEach((sid, i) => {
                const s = state.schueler.find(st => st.id === sid);
                if (s) {
                    html += `<tr><td>${i + 1}</td><td>${s.nachname}</td><td>${s.vorname}</td></tr>`;
                }
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ========================================
        // EXPORT / IMPORT
        // ========================================

        function exportData() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `las-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Daten exportiert', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    state = imported;
                    saveState();
                    updateUI();
                    showToast('Daten importiert', 'success');
                } catch (err) {
                    showToast('Fehler beim Import: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function generateDemoData(count) {
            const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id]);
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false);

            for (let i = 0; i < count; i++) {
                const fach = enabledFaecher[Math.floor(Math.random() * enabledFaecher.length)];
                const schuelerId = fach.schuelerIds[Math.floor(Math.random() * fach.schuelerIds.length)];
                const krit = enabledKriterien[Math.floor(Math.random() * enabledKriterien.length)];
                
                // Nur aktive Indikatoren verwenden
                const indikatoren = getActiveIndikatoren(krit.id);
                if (indikatoren.length === 0) continue;
                
                const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

                // Generate somewhat realistic rating (mostly 3, some 2 and 4, few 1)
                const rand = Math.random();
                let rating;
                if (rand < 0.05) rating = 1;
                else if (rand < 0.25) rating = 2;
                else if (rand < 0.75) rating = 3;
                else rating = 4;

                // Random date within semester
                const start = new Date(state.semester.start);
                const end = new Date(state.semester.end);
                const randomDate = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));

                state.beobachtungen.push({
                    id: Date.now().toString() + i,
                    schuelerId,
                    fachId: fach.id,
                    kriteriumId: krit.id,
                    indikator,
                    rating,
                    timestamp: randomDate.toISOString()
                });
            }

            saveState();
            updateUI();
            showToast(`${count} Demo-Beobachtungen generiert`, 'success');
        }

        // ========================================
        // UTILITIES
        // ========================================

        // Notification Sound (einfacher Beep mit Web Audio API)
        let audioContext = null;
        
        function playNotificationSound() {
            if (!state.semester.reminderSound) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Erster Ton
                playBeep(audioContext, 880, 0, 0.15);  // A5
                // Zweiter Ton (höher)
                playBeep(audioContext, 1100, 0.2, 0.15);  // C#6
            } catch (e) {
                console.log('Audio nicht verfügbar:', e);
            }
        }
        
        function playBeep(ctx, frequency, startTime, duration) {
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime + startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + startTime + duration);
            
            oscillator.start(ctx.currentTime + startTime);
            oscillator.stop(ctx.currentTime + startTime + duration);
        }
        
        function playTestSound() {
            // Temporär Sound aktivieren für Test
            const originalSetting = state.semester.reminderSound;
            state.semester.reminderSound = true;
            playNotificationSound();
            state.semester.reminderSound = originalSetting;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
