<!DOCTYPE html>

<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAS-Beobachtungssystem</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&family=Merriweather:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4a9d5b;
            --primary-dark: #3a7d4b;
            --primary-light: #e8f5e9;
            --secondary: #f5b041;
            --secondary-light: #fef3e2;
            --danger: #e74c3c;
            --danger-light: #fdeaea;
            --text: #2c3e50;
            --text-light: #7f8c8d;
            --bg: #f8f9fa;
            --white: #ffffff;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --radius: 8px;
            --radius-lg: 12px;
        }

```
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        min-height: 100vh;
    }

    /* Layout */
    .app-container {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 280px;
        background: var(--white);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        position: fixed;
        height: 100vh;
        z-index: 100;
        transition: transform 0.3s ease;
    }

    .sidebar-header {
        padding: 20px;
        background: var(--primary);
        color: white;
    }

    .sidebar-header h1 {
        font-family: 'Merriweather', serif;
        font-size: 1.4rem;
        margin-bottom: 4px;
    }

    .sidebar-header p {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .sidebar-nav {
        flex: 1;
        padding: 16px 0;
        overflow-y: auto;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }

    .nav-item:hover {
        background: var(--primary-light);
    }

    .nav-item.active {
        background: var(--primary-light);
        border-left-color: var(--primary);
        font-weight: 600;
    }

    .nav-item svg {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        opacity: 0.7;
    }

    .nav-item.active svg {
        opacity: 1;
    }

    .sidebar-footer {
        padding: 16px 20px;
        border-top: 1px solid var(--border);
        font-size: 0.8rem;
        color: var(--text-light);
    }

    /* Main Content */
    .main-content {
        flex: 1;
        margin-left: 280px;
        padding: 24px;
        max-width: 1200px;
    }

    /* Cards */
    .card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow);
        padding: 24px;
        margin-bottom: 20px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .card-title {
        font-family: 'Merriweather', serif;
        font-size: 1.2rem;
        color: var(--text);
    }

    /* Alert / Notification Banner */
    .alert-banner {
        background: linear-gradient(135deg, var(--secondary) 0%, #e67e22 100%);
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius-lg);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: var(--shadow-lg);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.01); }
    }

    .alert-banner-content {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .alert-banner h3 {
        font-size: 1.1rem;
        margin-bottom: 4px;
    }

    .alert-banner p {
        font-size: 0.9rem;
        opacity: 0.95;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: var(--radius);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        gap: 8px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: var(--white);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-secondary:hover {
        background: var(--bg);
    }

    .btn-lg {
        padding: 14px 28px;
        font-size: 1.05rem;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    /* Rating Buttons */
    .rating-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .rating-btn {
        flex: 1;
        min-width: 120px;
        padding: 16px 12px;
        border-radius: var(--radius);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        text-align: center;
    }

    .rating-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .rating-btn.rating-1 {
        background: #ffebee;
        color: #c62828;
        border-color: #ef9a9a;
    }

    .rating-btn.rating-1:hover {
        background: #ffcdd2;
    }

    .rating-btn.rating-2 {
        background: #fff3e0;
        color: #e65100;
        border-color: #ffcc80;
    }

    .rating-btn.rating-2:hover {
        background: #ffe0b2;
    }

    .rating-btn.rating-3 {
        background: #e8f5e9;
        color: #2e7d32;
        border-color: #a5d6a7;
    }

    .rating-btn.rating-3:hover {
        background: #c8e6c9;
    }

    .rating-btn.rating-4 {
        background: #e3f2fd;
        color: #1565c0;
        border-color: #90caf9;
    }

    .rating-btn.rating-4:hover {
        background: #bbdefb;
    }

    .rating-btn.rating-skip {
        background: var(--bg);
        color: var(--text-light);
        border-color: var(--border);
        flex: 0;
        min-width: 100px;
    }

    /* Progress */
    .progress-container {
        margin-bottom: 24px;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .progress-bar {
        height: 8px;
        background: var(--border);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* Question Card */
    .question-card {
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        padding: 32px;
        margin-bottom: 20px;
    }

    .question-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .question-tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        background: var(--primary-light);
        color: var(--primary-dark);
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .question-tag.fach {
        background: var(--secondary-light);
        color: #b7791f;
    }

    .student-name {
        font-family: 'Merriweather', serif;
        font-size: 1.8rem;
        color: var(--primary-dark);
        margin-bottom: 16px;
    }

    .indicator-text {
        font-size: 1.15rem;
        color: var(--text);
        line-height: 1.7;
        padding: 16px;
        background: var(--bg);
        border-radius: var(--radius);
        border-left: 4px solid var(--primary);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--white);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-top: 4px;
    }

    /* Select */
    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
    }

    .form-select, .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        font-family: inherit;
        background: var(--white);
        transition: border-color 0.2s;
    }

    .form-select:focus, .form-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    /* Tables */
    .table-container {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    th {
        font-weight: 600;
        background: var(--bg);
    }

    tr:hover {
        background: var(--primary-light);
    }

    /* Boxplot Container */
    .boxplot-container {
        padding: 16px 0;
        margin: 16px 0;
    }

    .boxplot-row {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        gap: 12px;
    }

    .boxplot-row:last-of-type {
        border-bottom: none;
    }

    .boxplot-label {
        width: 240px;
        font-size: 0.95rem;
        font-weight: 400;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .boxplot-info {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--border);
        color: var(--text-light);
        font-size: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .boxplot-info:hover {
        background: #0891b2;
        color: white;
    }

    .boxplot-divider {
        color: var(--text-light);
        font-size: 1.2rem;
    }

    .boxplot-chart {
        flex: 1;
        height: 32px;
        background: white;
        border-radius: 4px;
        position: relative;
        border: 1px solid var(--border);
    }

    .boxplot-scale {
        flex: 1;
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-light);
        padding: 0 4px;
    }

    .boxplot-box {
        position: absolute;
        height: 100%;
        background: rgba(8, 145, 178, 0.15);
        border: 2px solid #0891b2;
        border-radius: 4px;
        z-index: 1;
    }

    .boxplot-median {
        position: absolute;
        width: 3px;
        height: 100%;
        background: #0891b2;
        z-index: 2;
    }

    .boxplot-whisker {
        position: absolute;
        height: 2px;
        top: 50%;
        transform: translateY(-50%);
        background: #0891b2;
    }

    .boxplot-whisker-end {
        position: absolute;
        width: 2px;
        height: 50%;
        top: 25%;
        background: #0891b2;
        z-index: 3;
    }

    /* Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal {
        background: var(--white);
        border-radius: var(--radius-lg);
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-family: 'Merriweather', serif;
        font-size: 1.2rem;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
    }

    .modal-body {
        padding: 24px;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    /* Tabs */
    .tabs {
        display: flex;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
    }

    .tab {
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-light);
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab:hover {
        color: var(--text);
    }

    .tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    /* Toggle Switch */
    .toggle-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toggle {
        position: relative;
        width: 50px;
        height: 26px;
    }

    .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border);
        transition: 0.3s;
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }

    .toggle input:checked + .toggle-slider {
        background-color: var(--primary);
    }

    .toggle input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    /* Screen visibility */
    .screen {
        display: none;
    }

    .screen.active {
        display: block;
    }

    /* Responsive */
    .mobile-menu-btn {
        display: none;
        position: fixed;
        top: 16px;
        left: 16px;
        z-index: 101;
        background: var(--primary);
        color: white;
        border: none;
        padding: 12px;
        border-radius: var(--radius);
        cursor: pointer;
    }

    /* Tablet Optimierung (768px - 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
        .sidebar {
            width: 220px;
        }

        .main-content {
            margin-left: 220px;
            padding: 16px;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
        }

        .nav-item {
            padding: 10px 16px;
            font-size: 0.9rem;
        }

        .boxplot-label {
            width: 180px;
            font-size: 0.85rem;
        }

        .boxplot-row {
            gap: 8px;
        }

        .zeugnis-btn {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .card {
            padding: 16px;
        }
    }

    /* Smartphone Optimierung */
    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
            padding: 16px;
            padding-top: 70px;
        }

        .mobile-menu-btn {
            display: block;
        }

        .rating-buttons {
            flex-direction: column;
        }

        .rating-btn {
            min-width: 100%;
        }

        .stats-grid {
            grid-template-columns: 1fr 1fr;
        }

        .boxplot-row {
            flex-wrap: wrap;
            gap: 8px;
        }

        .boxplot-label {
            width: 100%;
            font-size: 0.9rem;
        }

        .boxplot-divider {
            display: none;
        }

        .boxplot-chart {
            width: 100%;
            order: 1;
        }

        .boxplot-row .btn {
            order: 2;
        }

        .boxplot-row .zeugnis-select {
            order: 3;
            margin-left: 0;
        }
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1001;
    }

    .toast {
        background: var(--text);
        color: white;
        padding: 16px 24px;
        border-radius: var(--radius);
        margin-top: 12px;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease;
    }

    .toast.success {
        background: var(--primary);
    }

    .toast.error {
        background: var(--danger);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-light);
    }

    .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.2rem;
        margin-bottom: 8px;
        color: var(--text);
    }

    /* Badge */
    .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 24px;
        height: 24px;
        padding: 0 8px;
        background: var(--danger);
        color: white;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 8px;
    }

    /* Zeugnisnote Selection */
    .zeugnis-select {
        display: flex;
        gap: 4px;
    }

    .zeugnis-btn {
        padding: 4px 10px;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        background: white;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .zeugnis-btn:hover {
        border-color: #0891b2;
    }

    .zeugnis-btn.selected {
        background: #0891b2;
        color: white;
        border-color: #0891b2;
    }

    /* Stundenplan Highlighting */
    .current-lesson-cell {
        background: var(--primary) !important;
        color: white !important;
        font-weight: 600;
        border-radius: var(--radius);
        animation: pulse-cell 2s infinite;
    }

    @keyframes pulse-cell {
        0%, 100% { box-shadow: 0 0 0 0 rgba(74, 157, 91, 0.4); }
        50% { box-shadow: 0 0 0 8px rgba(74, 157, 91, 0); }
    }

    .current-day-column {
        background: var(--primary-light);
    }

    /* Test Mode */
    .test-mode-banner {
        background: var(--secondary);
        color: white;
        padding: 8px 16px;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Chip / Tag list */
    .chip-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .chip {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background: var(--bg);
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .chip.active {
        background: var(--primary);
        color: white;
    }
</style>
```

</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
    </button>

```
<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>LAS</h1>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" data-screen="dashboard" onclick="showScreen('dashboard')">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                Dashboard
            </div>
            <div class="nav-item" data-screen="observe" onclick="showScreen('observe')">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                Beobachten
            </div>
            <div class="nav-item" data-screen="evaluation" onclick="showScreen('evaluation')">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Auswertung
            </div>
            <div class="nav-item" data-screen="config" onclick="showScreen('config')">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                Konfiguration
            </div>
            <div class="nav-item" data-screen="export" onclick="showScreen('export')">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Export / Import
            </div>
        </nav>
        
        <!-- Noch zu erledigen in Sidebar -->
        <div id="pending-observations-card" style="display:none; padding: 12px; border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="openPendingModal()">
                <div style="font-weight: 600; font-size: 0.85rem; color: var(--secondary);">
                    Noch zu erledigen
                </div>
                <div id="pending-count-badge" style="background: var(--secondary); color: white; font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 10px;">0</div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div id="test-mode-sidebar" style="display:none; background: var(--secondary); color: white; padding: 8px; border-radius: var(--radius); margin-bottom: 8px; font-weight: 600; font-size: 0.85rem;">
                ▶ Test-Modus aktiv
                <div id="test-time-display" style="font-weight: 400;"></div>
            </div>
            <div id="semester-info">Semester: Laden...</div>
            <div id="current-time"></div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Screen -->
        <div class="screen active" id="screen-dashboard">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Stundenplan</h2>
                </div>
                <div class="table-container">
                    <table id="dashboard-stundenplan">
                        <thead>
                            <tr>
                                <th>Zeit</th>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-stundenplan-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Observe Screen -->
        <div class="screen" id="screen-observe">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Fach / Klasse wählen</h2>
                </div>
                <p style="margin-bottom: 16px; color: var(--text-light);">
                    Für Beobachtungen zwischendurch – unabhängig vom Stundenplan. 
                    Wähle ein Fach und das System generiert automatisch Fragen zu Schülern und Kriterien, 
                    bei denen noch Beobachtungen fehlen.
                </p>
                <div class="form-group">
                    <label class="form-label">Fach</label>
                    <select class="form-select" id="select-fach-klasse" onchange="startObservation()">
                        <option value="">-- Bitte wählen --</option>
                    </select>
                </div>
            </div>

            <div id="observation-container" style="display:none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <span>Frage <span id="question-number">1</span> von <span id="question-total">5</span></span>
                        <span id="session-progress">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="session-progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="question-card">
                    <div class="question-meta">
                        <span class="question-tag" id="q-kriterium">L01 Lernverhalten</span>
                        <span class="question-tag fach" id="q-fach">Mathematik</span>
                    </div>
                    <div class="student-name" id="q-student">Max Mustermann</div>
                    <div class="indicator-text" id="q-indicator">
                        Bringt eigene Interessen, Ideen und Vorschläge ein
                    </div>
                    <div class="rating-buttons">
                        <button class="rating-btn rating-1" onclick="submitRating(1)">
                            1 - nicht genügend
                        </button>
                        <button class="rating-btn rating-2" onclick="submitRating(2)">
                            2 - genügend
                        </button>
                        <button class="rating-btn rating-3" onclick="submitRating(3)">
                            3 - gut
                        </button>
                        <button class="rating-btn rating-4" onclick="submitRating(4)">
                            4 - sehr gut
                        </button>
                        <button class="rating-btn rating-skip" onclick="submitRating(0)">
                            Überspringen
                        </button>
                    </div>
                </div>
            </div>

            <div id="observation-complete" style="display:none;">
                <div class="card" style="text-align:center; padding: 60px;">
                    <svg width="80" height="80" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin: 0 auto 20px;">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h2 style="margin-bottom: 12px;">Runde abgeschlossen!</h2>
                    <p style="color: var(--text-light); margin-bottom: 24px;">
                        Du hast <span id="completed-count">5</span> Beobachtungen erfasst.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="btn btn-primary" onclick="startNewRound()">
                            Weitere Runde
                        </button>
                        <button class="btn btn-secondary" onclick="showScreen('dashboard')">
                            Zum Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Evaluation Screen -->
        <div class="screen" id="screen-evaluation">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Auswertung</h2>
                </div>
                <p style="margin-bottom: 16px; color: var(--text-light);">
                    Übersicht aller Beobachtungen pro Schüler. Die Boxplots zeigen die Verteilung der Bewertungen 
                    pro Kriterium. Hier legst du auch die definitive LAS-Beurteilung pro Fach (nicht genügend, genügend, gut, sehr gut) fest.
                </p>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">Fach / Klasse</label>
                        <select class="form-select" id="eval-fach-klasse" onchange="updateEvaluation()">
                            <option value="">-- Fach wählen --</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label class="form-label">Schüler/in</label>
                        <select class="form-select" id="eval-student" onchange="updateEvaluation()">
                            <option value="">-- Schüler wählen --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="evaluation-content">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <h3>Noch keine Daten</h3>
                    <p>Erfasse zuerst einige Beobachtungen.</p>
                </div>
            </div>
        </div>

        <!-- Config Screen -->
        <div class="screen" id="screen-config">
            <div class="tabs">
                <div class="tab active" onclick="showConfigTab('semester')">Semester</div>
                <div class="tab" onclick="showConfigTab('kriterien')">LAS-Kriterien</div>
                <div class="tab" onclick="showConfigTab('faecher')">Fächer</div>
                <div class="tab" onclick="showConfigTab('schueler')">Listen</div>
            </div>

            <div id="config-semester" class="config-tab">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Semester-Einstellungen</h2>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label class="form-label">Semester-Start</label>
                            <input type="date" class="form-input" id="config-semester-start" onchange="saveSemesterConfig()">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label class="form-label">Semester-Ende</label>
                            <input type="date" class="form-input" id="config-semester-end" onchange="saveSemesterConfig()">
                        </div>
                    </div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label class="form-label">Beobachtungen pro Schüler pro Fach</label>
                            <input type="number" class="form-input" id="config-target" value="3" min="1" max="10" style="width: 100px;" onchange="saveSemesterConfig()">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px;">
                            <label class="form-label">Fragen pro Runde</label>
                            <input type="number" class="form-input" id="config-questions-per-round" value="13" min="1" max="50" style="width: 100px;" onchange="saveSemesterConfig()">
                            <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 4px;">
                                Minimum: <span id="min-questions-display">-</span> Fragen/Lektion
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="config-kriterien" class="config-tab" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Kriterien aktivieren/deaktivieren</h2>
                    </div>
                    <div id="kriterien-list"></div>
                </div>
            </div>

            <div id="config-faecher" class="config-tab" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Fächer aktivieren/deaktivieren</h2>
                    </div>
                    <div id="faecher-list"></div>
                </div>
            </div>

            <div id="config-schueler" class="config-tab" style="display:none;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Schülerlisten</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fach / Klasse wählen</label>
                        <select class="form-select" id="config-schueler-fach" onchange="showSchuelerList()">
                            <option value="">-- Bitte wählen --</option>
                        </select>
                    </div>
                    <div id="schueler-list-container"></div>
                </div>
            </div>
        </div>

        <!-- Export Screen -->
        <div class="screen" id="screen-export">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title">Daten exportieren</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Exportiere alle Daten als JSON-Datei für ein Backup.
                    </p>
                    <button class="btn btn-primary" onclick="exportData()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Export (JSON)
                    </button>
                </div>

                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h2 class="card-title">Daten importieren</h2>
                    </div>
                    <p style="margin-bottom: 16px; color: var(--text-light);">
                        Importiere eine zuvor exportierte JSON-Datei. <strong>Achtung:</strong> Dies überschreibt alle aktuellen Daten!
                    </p>
                    <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Import (JSON)
                    </button>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title">Test-Modus: Zeit simulieren</h2>
                </div>
                <p style="margin-bottom: 16px; color: var(--text-light);">
                    Simuliere einen bestimmten Wochentag und Uhrzeit, um die Stundenplan-Erkennung zu testen.
                </p>
                <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: end;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Wochentag</label>
                        <select class="form-select" id="test-day" style="width: 150px;">
                            <option value="">-- Echtzeit --</option>
                            <option value="1">Montag</option>
                            <option value="2">Dienstag</option>
                            <option value="3">Mittwoch</option>
                            <option value="4">Donnerstag</option>
                            <option value="5">Freitag</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Startzeit</label>
                        <input type="time" class="form-input" id="test-time" style="width: 130px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Geschwindigkeit</label>
                        <select class="form-select" id="test-speed" style="width: 100px;">
                            <option value="1">1×</option>
                            <option value="2">2×</option>
                            <option value="5">5×</option>
                            <option value="10">10×</option>
                            <option value="30">30×</option>
                            <option value="60">60×</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="applyTestTime()">Starten</button>
                    <button class="btn btn-secondary" onclick="resetTestTime()">Zurücksetzen</button>
                </div>
                <div id="test-mode-status" style="margin-top: 12px;"></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Demo-Modus</h2>
                </div>
                <p style="margin-bottom: 12px; color: var(--text-light);">
                    Generiere zufällige Testdaten, um das System auszuprobieren.
                </p>
                <p style="margin-bottom: 16px; font-size: 0.95rem;">
                    <strong>Aktuelle Beobachtungen:</strong> <span id="demo-observation-count">0</span>
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="generateDemoData(100)">
                        +100 Beobachtungen
                    </button>
                    <button class="btn btn-secondary" onclick="generateDemoData(500)">
                        +500 Beobachtungen
                    </button>
                    <button class="btn btn-secondary" onclick="clearAllData()" style="color: var(--danger);">
                        Alle Daten löschen
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detail-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Detailansicht</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Schliessen</button>
        </div>
    </div>
</div>

<!-- Beobachtungs-Modal -->
<div class="modal-overlay" id="observation-modal">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">
                <span id="obs-modal-fach">Beobachtung</span>
            </h3>
            <button class="modal-close" onclick="closeObservationModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="progress-container" style="padding: 16px 24px; background: var(--bg); margin: 0;">
                <div class="progress-header">
                    <span>Frage <span id="obs-question-number">1</span> von <span id="obs-question-total">5</span></span>
                    <span id="obs-session-progress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="obs-progress-fill" style="width: 0%"></div>
                </div>
            </div>
            
            <div style="padding: 24px;">
                <div class="question-meta" style="margin-bottom: 12px;">
                    <span class="question-tag" id="obs-kriterium">L01 Lernverhalten</span>
                </div>
                <div class="student-name" id="obs-student">Max Mustermann</div>
                <div class="indicator-text" id="obs-indicator">
                    Bringt eigene Interessen, Ideen und Vorschläge ein
                </div>
                <div class="rating-buttons">
                    <button class="rating-btn rating-1" onclick="submitModalRating(1)">
                        1 - nicht genügend
                    </button>
                    <button class="rating-btn rating-2" onclick="submitModalRating(2)">
                        2 - genügend
                    </button>
                    <button class="rating-btn rating-3" onclick="submitModalRating(3)">
                        3 - gut
                    </button>
                    <button class="rating-btn rating-4" onclick="submitModalRating(4)">
                        4 - sehr gut
                    </button>
                    <button class="rating-btn rating-skip" onclick="submitModalRating(0)">
                        Überspringen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Beobachtung-Abgeschlossen Modal -->
<div class="modal-overlay" id="observation-complete-modal">
    <div class="modal" style="max-width: 400px; text-align: center;">
        <div class="modal-body" style="padding: 40px;">
            <svg width="60" height="60" fill="none" stroke="var(--primary)" stroke-width="2" viewBox="0 0 24 24" style="margin-bottom: 16px;">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h2 style="margin-bottom: 8px;">Runde abgeschlossen!</h2>
            <p style="color: var(--text-light); margin-bottom: 24px;">
                Du hast <span id="obs-completed-count">5</span> Beobachtungen erfasst.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-primary" onclick="startNewObservationRound()">
                    Weitere Runde
                </button>
                <button class="btn btn-secondary" onclick="closeObservationCompleteModal()">
                    Fertig
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pending-Modal -->
<div class="modal-overlay" id="pending-modal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title">Noch zu erledigen</h3>
            <button class="modal-close" onclick="closePendingModal()">&times;</button>
        </div>
        <div class="modal-body" id="pending-modal-body" style="max-height: 400px; overflow-y: auto;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePendingModal()">Schliessen</button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
    // ========================================
    // DATA STRUCTURES
    // ========================================
    
    const KRITERIEN = [
        { id: 'L01', bereich: 'Lernverhalten', name: 'beteiligt sich aktiv am Unterricht' },
        { id: 'L02', bereich: 'Lernverhalten', name: 'konzentriert sich auf eine Aufgabe' },
        { id: 'L03', bereich: 'Lernverhalten', name: 'entwickelt sinnvolle Lösungen' },
        { id: 'A04', bereich: 'Arbeitsverhalten', name: 'arbeitet ausdauernd' },
        { id: 'A05', bereich: 'Arbeitsverhalten', name: 'führt Arbeiten selbständig aus' },
        { id: 'A06', bereich: 'Arbeitsverhalten', name: 'gestaltet Arbeiten sorgfältig' },
        { id: 'A07', bereich: 'Arbeitsverhalten', name: 'führt Arbeiten zuverlässig aus' },
        { id: 'A08', bereich: 'Arbeitsverhalten', name: 'geht konstruktiv mit Rückmeldungen um' },
        { id: 'A09', bereich: 'Arbeitsverhalten', name: 'arbeitet in angemessenem Tempo' },
        { id: 'S10', bereich: 'Sozialverhalten', name: 'arbeitet mit andern konstruktiv zusammen' },
        { id: 'S11', bereich: 'Sozialverhalten', name: 'begegnet Mitmenschen respektvoll' },
        { id: 'S12', bereich: 'Sozialverhalten', name: 'hält sich an Abmachungen und Regeln' }
    ];

    const INDIKATOREN = {
        'L01': [
            'Bringt eigene Interessen, Ideen und Vorschläge ein',
            'Stellt Fragen, die Neugierde erkennen lassen',
            'Gestaltet Lernprozesse aktiv mit',
            'Traut sich etwas zu',
            'Nutzt die eigenen Fähigkeiten',
            'Arbeitet aus eigenem Antrieb'
        ],
        'L02': [
            'Erledigt eigenverantwortlich Hausaufgaben',
            'Bereitet sich auf Lernkontrollen vor',
            'Setzt Strategien ein, um eine Aufgabe auch bei Widerständen zu Ende zu führen',
            'Lässt sich kaum von Aufgaben ablenken',
            'Passt im Unterricht gut auf'
        ],
        'L03': [
            'Fragt nach Ursachen eines Problems, bevor Lösungen genannt werden',
            'Erkennt und nennt verschiedene Aspekte eines Problems',
            'Verschafft sich Informationen, schätzt sie ein und verarbeitet sie',
            'Bezieht Kenntnisse aus verschiedenen Fachbereichen ein',
            'Überträgt eigene Erfahrungen auf Problemstellungen im Unterricht',
            'Hat kreative Einfälle zum Thema',
            'Entwickelt realisierbare Lösungsvorschläge',
            'Berücksichtigt mögliche Konsequenzen und Folgen einer Entscheidung',
            'Erprobt neue Herangehensweisen und variiert Methoden'
        ],
        'A04': [
            'Kann sich über längere Zeit mit einem Lerngegenstand beschäftigen',
            'Beendet angefangene Arbeiten',
            'Gibt nicht auf, wenn sich nicht sofort Erfolg einstellt',
            'Lässt sich nicht ablenken',
            'Berücksichtigt in der Zeitplanung die Anforderungen der Aufgabe',
            'Arbeitet auch dann weiter, wenn eine Arbeit nicht so interessiert',
            'Ist erst zufrieden, wenn die Arbeit gut gemacht ist'
        ],
        'A05': [
            'Setzt sich realistische Ziele',
            'Schätzt eigene Leistungen realistisch ein',
            'Kann selbständig und strukturiert planen',
            'Kann Arbeitsschritte ohne ständige Bestätigung der Lehrperson umsetzen',
            'Kann der Situation entsprechend entscheiden und handeln',
            'Besorgt sich fehlende Informationen und benötigte Hilfsmittel',
            'Probiert aus, bevor um Hilfe gebeten wird',
            'Kontrolliert eigene Arbeiten und nimmt Verbesserungen vor',
            'Setzt sich mit dem eigenen Lernverhalten auseinander'
        ],
        'A06': [
            'Arbeitsblätter und Hefte sind übersichtlich und verständlich dargestellt',
            'Geht mit Materialien, Werkzeugen und Geräten sorgfältig um',
            'Arbeitet sauber'
        ],
        'A07': [
            'Orientiert sich am Ziel der Aufgabe',
            'Hält sich an vereinbarte Zeiten',
            'Hat die Schulmaterialien dabei',
            'Hat die Hausaufgaben erledigt',
            'Hält Termine bei Arbeitsaufträgen ein',
            'Andere können sich auf Zusagen verlassen',
            'Überprüft eigene Arbeitsergebnisse und optimiert sie'
        ],
        'A08': [
            'Kann Misserfolge verarbeiten',
            'Kann bei Kritik zuhören und mit Anregungen konstruktiv umgehen',
            'Ist in der Lage, Fehler zuzugeben',
            'Vermag Argumente für und gegen eine Sache einzubeziehen',
            'Kann Leistungen und eigenes Verhalten einschätzen',
            'Betrachtet kritische Rückmeldungen als Unterstützung zur Verbesserung'
        ],
        'A09': [
            'Richtet sich den Arbeitsplatz sinnvoll ein',
            'Beginnt sofort mit der Arbeit',
            'Arbeitet mit wenig Unterbrechung',
            'Passt das Arbeitstempo den eigenen Fähigkeiten an',
            'Erledigt die Arbeiten mit angemessenem Zeitaufwand',
            'Kommt bei der Arbeit zügig voran'
        ],
        'S10': [
            'Beteiligt sich aktiv an der Zusammenarbeit mit anderen',
            'Hört aufmerksam zu',
            'Nimmt Meldungen und Standpunkte von anderen wahr und bezieht sie ein',
            'Stellt eigene Interessen zugunsten der Gruppe zurück oder setzt sich durch',
            'Gibt sich bei der Planung von Gruppenarbeiten aktiv ein',
            'Trägt dazu bei, Arbeiten zusammen mit anderen gut zu lösen'
        ],
        'S11': [
            'Nimmt Menschen in ihren Gemeinsamkeiten und Differenzen wahr',
            'Geht taktvoll mit Menschen um',
            'Achtet auf einen wertschätzenden Sprachgebrauch',
            'Erkennt herabwürdigenden Sprachgebrauch und nimmt ihn nicht passiv hin',
            'Benimmt sich gegenüber Erwachsenen anständig',
            'Benimmt sich gegenüber anderen Schülern anständig',
            'Bleibt auch bei schlechter Laune anderen gegenüber anständig'
        ],
        'S12': [
            'Verhält sich regelkonform',
            'Hält sich an die Vereinbarungen der Gruppe, Klasse und Schule',
            'Kommt den persönlichen Pflichten nach',
            'Akzeptiert faire Lösungen und setzt diese um',
            'Stört den Unterricht nicht',
            'Hört zu, wenn andere sprechen',
            'Lässt andere ausreden',
            'Trägt zu einem friedlichen Zusammenleben bei'
        ]
    };

    const DEFAULT_FAECHER = [
        { id: 'erg-1d', name: 'ERG', klasse: '1d', schuelerIds: [] },
        { id: 'nt-1d', name: 'NT', klasse: '1d', schuelerIds: [] },
        { id: 'nt-1c', name: 'NT', klasse: '1c', schuelerIds: [] },
        { id: 'el-1cd', name: 'EL', klasse: '1c+1d', schuelerIds: [] },
        { id: 'mi-1cd', name: 'MI', klasse: '1c/1d', schuelerIds: [] },
        { id: 'mathe-1sek', name: 'Mathe', klasse: '1. Sek', schuelerIds: [] },
        { id: 'mathe-3sek', name: 'Mathe', klasse: '3. Sek', schuelerIds: [] },
        { id: 'icdl-3kl', name: 'ICDL', klasse: '3. Klasse', schuelerIds: [] }
    ];

    const DEFAULT_STUNDENPLAN = [
        { lektion: 1, zeit: '07:25-08:10', mo: 'erg-1d', di: null, mi: 'el-1cd', do: null, fr: 'mathe-1sek' },
        { lektion: 2, zeit: '08:15-09:00', mo: 'nt-1d', di: 'mathe-3sek', mi: 'el-1cd', do: null, fr: 'mathe-1sek' },
        { lektion: 3, zeit: '09:05-09:50', mo: 'el-1cd', di: 'nt-1d', mi: null, do: null, fr: null },
        { lektion: 4, zeit: '10:15-11:00', mo: 'el-1cd', di: 'mi-1cd', mi: 'mathe-1sek', do: null, fr: 'nt-1c' },
        { lektion: 5, zeit: '11:05-11:50', mo: 'mathe-3sek', di: 'mi-1cd', mi: 'mathe-3sek', do: 'mathe-3sek', fr: 'mathe-3sek' },
        { lektion: 6, zeit: '11:50-12:35', mo: null, di: null, mi: null, do: null, fr: null },
        { lektion: 7, zeit: '12:35-13:20', mo: null, di: null, mi: null, do: null, fr: null },
        { lektion: 8, zeit: '13:30-14:15', mo: null, di: 'mathe-1sek', mi: null, do: 'mathe-1sek', fr: null },
        { lektion: 9, zeit: '14:20-15:05', mo: null, di: 'nt-1c', mi: null, do: 'mathe-1sek', fr: null },
        { lektion: 10, zeit: '15:10-15:55', mo: null, di: null, mi: null, do: 'icdl-3kl', fr: null },
        { lektion: 11, zeit: '16:00-16:45', mo: null, di: null, mi: null, do: null, fr: null }
    ];

    // Fiktive Schülernamen mit Vielfalt
    const VORNAMEN_CH = ['Luca', 'Noah', 'Leon', 'Liam', 'Elias', 'Gabriel', 'Louis', 'David', 'Samuel', 'Julian', 'Mia', 'Emma', 'Sofia', 'Emilia', 'Lena', 'Anna', 'Laura', 'Lea', 'Elena', 'Nina'];
    const VORNAMEN_INTERNATIONAL = ['Aleksandar', 'Driton', 'Erion', 'Blerim', 'Fatmir', 'Arben', 'Besnik', 'Mehmet', 'Kemal', 'Yusuf', 'Ahmed', 'Omar', 'Amir', 'Hassan', 'Ali', 'Fatima', 'Amira', 'Leyla', 'Zeynep', 'Aylin', 'Sara', 'Mira', 'Dina', 'Selina', 'Alina', 'Liridona', 'Albina', 'Teuta', 'Vjosa', 'Ardiana', 'Diego', 'Marco', 'Alessandro', 'Matteo', 'Lorenzo', 'Giulia', 'Chiara', 'Valentina', 'Alessia', 'Francesca', 'Miguel', 'Carlos', 'João', 'Pedro', 'Ana', 'Maria', 'Beatriz', 'Inês', 'Wei', 'Chen', 'Li', 'Mei', 'Yuki', 'Hana', 'Priya', 'Ananya', 'Rohan', 'Arjun'];
    const NACHNAMEN_CH = ['Müller', 'Meier', 'Schmid', 'Keller', 'Weber', 'Huber', 'Schneider', 'Meyer', 'Steiner', 'Fischer', 'Gerber', 'Brunner', 'Baumann', 'Frei', 'Zimmermann', 'Moser', 'Widmer', 'Wyss', 'Graf', 'Roth'];
    const NACHNAMEN_INTERNATIONAL = ['Berisha', 'Krasniqi', 'Gashi', 'Hoxha', 'Shala', 'Rama', 'Bytyqi', 'Ymeri', 'Salihu', 'Hasani', 'Yilmaz', 'Demir', 'Kaya', 'Celik', 'Özdemir', 'Rossi', 'Russo', 'Ferrari', 'Esposito', 'Bianchi', 'Silva', 'Santos', 'Ferreira', 'Oliveira', 'Rodrigues', 'Garcia', 'Martinez', 'Lopez', 'Gonzalez', 'Rodriguez', 'Chen', 'Wang', 'Li', 'Zhang', 'Liu', 'Nguyen', 'Tran', 'Patel', 'Singh', 'Kumar', 'Jovanović', 'Petrović', 'Nikolić', 'Marković', 'Đorđević'];

    // ========================================
    // STATE
    // ========================================

    let state = {
        semester: {
            start: '2025-08-11',
            end: '2026-01-23',
            targetObservations: 3,
            questionsPerRound: 13
        },
        faecher: [],
        schueler: [],
        stundenplan: [],
        kriterienEnabled: {},
        faecherEnabled: {},
        beobachtungen: [],
        zeugnisNoten: {},
        pendingLessons: [] // Verpasste Lektionen
    };

    // Current observation session
    let currentSession = {
        fachId: null,
        questions: [],
        currentIndex: 0,
        completed: 0
    };

    // Test mode for simulating date/time
    let testMode = {
        active: false,
        day: null,  // 1=Mo, 2=Di, etc.
        time: null,  // "HH:MM"
        speed: 1,
        startRealTime: null,
        startSimTime: null,
        intervalId: null
    };

    // ========================================
    // INITIALIZATION
    // ========================================

    function init() {
        loadState();
        if (state.schueler.length === 0) {
            generateInitialData();
        }
        
        // Setze questionsPerRound auf Minimum falls nicht vorhanden
        if (!state.semester.questionsPerRound) {
            state.semester.questionsPerRound = calculateMinQuestionsPerLesson();
            saveState();
        }
        
        updateUI();
        updateClock();
        setInterval(updateClock, 60000);
    }

    function loadState() {
        const saved = localStorage.getItem('las-state');
        if (saved) {
            const loaded = JSON.parse(saved);
            
            // Validierung: Prüfen ob die Datenstruktur noch gültig ist
            const isValid = loaded.schueler && 
                            loaded.schueler.length > 0 && 
                            loaded.faecher && 
                            loaded.faecher.length > 0 &&
                            loaded.faecher.every(f => f.schuelerIds && f.schuelerIds.length > 0);
            
            if (isValid) {
                state = loaded;
                
                // Fehlende Properties initialisieren (für ältere States)
                if (!state.pendingLessons) state.pendingLessons = [];
                if (!state.semester.questionsPerRound) state.semester.questionsPerRound = 13;
                
                console.log('State geladen:', state.schueler.length, 'Schüler,', state.faecher.length, 'Fächer');
            } else {
                console.warn('Gespeicherte Daten ungültig, generiere neu');
                localStorage.removeItem('las-state');
            }
        }
    }

    function saveState() {
        localStorage.setItem('las-state', JSON.stringify(state));
    }

    function generateInitialData() {
        // Generate base class students
        const schueler1c = generateSchuelerList(17, '1c');
        const schueler1d = generateSchuelerList(18, '1d');
        const schueler3Sek = generateSchuelerList(19, '3sek');
        
        // Mathe 1. Sek: 4 aus 1c + 4 aus 1d + 7 neue aus 1a/1b
        const mathe1SekAus1c = schueler1c.slice(0, 4);
        const mathe1SekAus1d = schueler1d.slice(0, 4);
        const schueler1ab = generateSchuelerList(7, '1ab'); // Nur Mathe bei dir
        
        // ICDL: 3 aus 3. Sek + 3 neue
        const icdlAus3Sek = schueler3Sek.slice(0, 3);
        const schuelerICDLNeu = generateSchuelerList(3, 'icdl-other');

        // Alle Schüler sammeln (keine Duplikate, da IDs eindeutig)
        state.schueler = [
            ...schueler1c, 
            ...schueler1d, 
            ...schueler1ab,
            ...schueler3Sek, 
            ...schuelerICDLNeu
        ];

        // Setup Fächer with student IDs
        state.faecher = DEFAULT_FAECHER.map(f => {
            let schuelerIds = [];
            switch(f.id) {
                case 'erg-1d': 
                case 'nt-1d':
                    schuelerIds = schueler1d.map(s => s.id);
                    break;
                case 'nt-1c':
                    schuelerIds = schueler1c.map(s => s.id);
                    break;
                case 'el-1cd':
                    schuelerIds = [...schueler1c, ...schueler1d].map(s => s.id);
                    break;
                case 'mi-1cd':
                    // MI alterniert zwischen 1c und 1d, aber beide Klassen werden separat beurteilt
                    schuelerIds = [...schueler1c, ...schueler1d].map(s => s.id);
                    break;
                case 'mathe-1sek':
                    // 4 aus 1c + 4 aus 1d + 7 aus 1a/1b
                    schuelerIds = [
                        ...mathe1SekAus1c.map(s => s.id),
                        ...mathe1SekAus1d.map(s => s.id),
                        ...schueler1ab.map(s => s.id)
                    ];
                    break;
                case 'mathe-3sek':
                    schuelerIds = schueler3Sek.map(s => s.id);
                    break;
                case 'icdl-3kl':
                    // 3 aus 3. Sek + 3 neue
                    schuelerIds = [
                        ...icdlAus3Sek.map(s => s.id),
                        ...schuelerICDLNeu.map(s => s.id)
                    ];
                    break;
            }
            return { ...f, schuelerIds };
        });

        state.stundenplan = DEFAULT_STUNDENPLAN;

        // Enable all Kriterien
        KRITERIEN.forEach(k => {
            state.kriterienEnabled[k.id] = true;
        });

        // Enable all Fächer
        state.faecher.forEach(f => {
            state.faecherEnabled[f.id] = true;
        });

        saveState();
    }

    function generateSchuelerList(count, gruppe) {
        const schueler = [];
        const allVornamen = [...VORNAMEN_CH, ...VORNAMEN_INTERNATIONAL];
        const allNachnamen = [...NACHNAMEN_CH, ...NACHNAMEN_INTERNATIONAL];
        
        for (let i = 0; i < count; i++) {
            const vorname = allVornamen[Math.floor(Math.random() * allVornamen.length)];
            const nachname = allNachnamen[Math.floor(Math.random() * allNachnamen.length)];
            schueler.push({
                id: `${gruppe}-${i}`,
                vorname,
                nachname,
                gruppe
            });
        }
        return schueler;
    }

    // ========================================
    // UI UPDATES
    // ========================================

    function updateUI() {
        updateStats();
        updateFachSelects();
        updateDashboard();
        updateKriterienList();
        updateFaecherList();
        updateSemesterConfig();
        updateDemoObservationCount();
    }

    function updateDemoObservationCount() {
        const countElement = document.getElementById('demo-observation-count');
        if (countElement) {
            countElement.textContent = state.beobachtungen.length;
        }
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString('de-CH', {
            weekday: 'long',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        const semesterStart = new Date(state.semester.start);
        const semesterEnd = new Date(state.semester.end);
        document.getElementById('semester-info').textContent = 
            `Semester: ${semesterStart.toLocaleDateString('de-CH')} - ${semesterEnd.toLocaleDateString('de-CH')}`;

        checkCurrentLesson();
    }

    function updateStats() {
        // Wird aufgerufen nach Änderungen, aktualisiert Dashboard
        updateDashboard();
    }

    function calculateTargetObservations() {
        let total = 0;
        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
        
        state.faecher.forEach(fach => {
            if (state.faecherEnabled[fach.id]) {
                total += fach.schuelerIds.length * enabledKriterien.length * state.semester.targetObservations;
            }
        });
        return total;
    }

    function updateDashboard() {
        // Update dashboard timetable
        updateDashboardStundenplan();
        
        // Update pending list
        updatePendingList();

        // Prüfe ob wir am Ende einer Lektion sind
        const lessonEndInfo = getLessonEndInfo();
        
        if (lessonEndInfo && state.faecherEnabled[lessonEndInfo.id]) {
            // Prüfe ob diese Lektion heute schon in pending ist
            const today = new Date().toDateString();
            const alreadyPending = state.pendingLessons.some(p => 
                p.fachId === lessonEndInfo.id && 
                p.date === today &&
                p.lektionIndex === lessonEndInfo.lektionIndex
            );
            
            if (!alreadyPending && alertFachId !== lessonEndInfo.id) {
                // Neue Lektion zu pending hinzufügen
                alertFachId = lessonEndInfo.id; // Merken um Duplikate zu vermeiden
                
                state.pendingLessons.push({
                    fachId: lessonEndInfo.id,
                    fachName: lessonEndInfo.name,
                    fachKlasse: lessonEndInfo.klasse,
                    lektionIndex: lessonEndInfo.lektionIndex,
                    date: today,
                    timestamp: Date.now()
                });
                saveState();
                updatePendingList();
            }
        } else {
            // Nicht mehr am Lektionsende - Reset
            alertFachId = null;
        }
    }

    function moveAlertToPending(fachInfo) {
        // Nicht mehr benötigt, aber für Kompatibilität behalten
    }

    function updatePendingList() {
        const card = document.getElementById('pending-observations-card');
        const badge = document.getElementById('pending-count-badge');
        
        // Alte Einträge entfernen (älter als heute)
        const today = new Date().toDateString();
        state.pendingLessons = state.pendingLessons.filter(p => p.date === today);
        
        if (state.pendingLessons.length === 0) {
            card.style.display = 'none';
            return;
        }
        
        card.style.display = 'block';
        badge.textContent = state.pendingLessons.length;
    }

    function openPendingModal() {
        const body = document.getElementById('pending-modal-body');
        
        if (state.pendingLessons.length === 0) {
            body.innerHTML = '<p style="color: var(--text-light);">Keine offenen Beobachtungen.</p>';
        } else {
            let html = '';
            state.pendingLessons.forEach((pending, index) => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg); border-radius: var(--radius); margin-bottom: 8px;">
                        <div>
                            <strong>${pending.fachName} ${pending.fachKlasse}</strong>
                            <div style="font-size: 0.85rem; color: var(--text-light);">Lektion ${pending.lektionIndex}</div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary btn-sm" onclick="observePending(${index}); closePendingModal();">Jetzt</button>
                            <button class="btn btn-secondary btn-sm" onclick="dismissPending(${index})">×</button>
                        </div>
                    </div>
                `;
            });
            body.innerHTML = html;
        }
        
        document.getElementById('pending-modal').classList.add('active');
    }

    function closePendingModal() {
        document.getElementById('pending-modal').classList.remove('active');
    }

    function observePending(index) {
        const pending = state.pendingLessons[index];
        if (!pending) return;
        
        const fach = state.faecher.find(f => f.id === pending.fachId);
        if (!fach) return;
        
        // Starte Beobachtung für dieses Fach
        const questionsCount = state.semester.questionsPerRound || calculateMinQuestionsPerLesson();
        currentSession.fachId = fach.id;
        currentSession.questions = generateQuestions(fach.id, questionsCount);
        currentSession.currentIndex = 0;
        currentSession.completed = 0;

        if (currentSession.questions.length === 0) {
            showToast('Keine Fragen verfügbar', 'error');
            return;
        }

        document.getElementById('obs-modal-fach').textContent = `${fach.name} ${fach.klasse}`;
        document.getElementById('obs-question-total').textContent = currentSession.questions.length;
        
        // Entferne aus pending
        state.pendingLessons.splice(index, 1);
        saveState();
        updatePendingList();
        
        showModalQuestion();
        document.getElementById('observation-modal').classList.add('active');
    }

    function dismissPending(index) {
        state.pendingLessons.splice(index, 1);
        saveState();
        updatePendingList();
        
        // Modal neu rendern falls offen
        if (document.getElementById('pending-modal').classList.contains('active')) {
            openPendingModal();
        }
        
        showToast('Verworfen', 'success');
    }

    function calculateGaps() {
        const gaps = [];
        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);

        state.faecher.forEach(fach => {
            if (!state.faecherEnabled[fach.id]) return;

            fach.schuelerIds.forEach(schuelerId => {
                enabledKriterien.forEach(krit => {
                    const count = state.beobachtungen.filter(b => 
                        b.schuelerId === schuelerId && 
                        b.fachId === fach.id && 
                        b.kriteriumId === krit.id
                    ).length;

                    if (count < state.semester.targetObservations) {
                        gaps.push({
                            schuelerId,
                            fachId: fach.id,
                            kriteriumId: krit.id,
                            count
                        });
                    }
                });
            });
        });

        // Sort by count (ascending) - least observations first
        gaps.sort((a, b) => a.count - b.count);
        return gaps;
    }

    function getCurrentFach() {
        let day, currentTime;
        
        if (testMode.active) {
            day = testMode.day;
            const [h, m] = testMode.time.split(':').map(Number);
            currentTime = h * 60 + m;
        } else {
            const now = new Date();
            day = now.getDay(); // 0=Sun, 1=Mon, ...
            currentTime = now.getHours() * 60 + now.getMinutes();
        }
        
        const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
        const dayKey = dayMap[day];
        
        if (!dayKey) return null;

        for (const lektion of state.stundenplan) {
            const [start, end] = lektion.zeit.split('-');
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            const startTime = startH * 60 + startM;
            const endTime = endH * 60 + endM;

            if (currentTime >= startTime && currentTime <= endTime) {
                const fachId = lektion[dayKey];
                if (fachId) {
                    return { 
                        ...state.faecher.find(f => f.id === fachId),
                        lektionIndex: lektion.lektion,
                        dayKey: dayKey
                    };
                }
            }
        }
        return null;
    }

    // Prüft ob wir am Ende einer Lektion sind (letzte 5 Minuten)
    function getLessonEndInfo() {
        let day, currentTime;
        
        if (testMode.active) {
            day = testMode.day;
            const [h, m] = testMode.time.split(':').map(Number);
            currentTime = h * 60 + m;
        } else {
            const now = new Date();
            day = now.getDay();
            currentTime = now.getHours() * 60 + now.getMinutes();
        }
        
        const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
        const dayKey = dayMap[day];
        
        if (!dayKey) return null;

        for (const lektion of state.stundenplan) {
            const [start, end] = lektion.zeit.split('-');
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            const startTime = startH * 60 + startM;
            const endTime = endH * 60 + endM;

            // Prüfe ob wir in den letzten 5 Minuten der Lektion sind
            const fiveMinBeforeEnd = endTime - 5;
            
            if (currentTime >= fiveMinBeforeEnd && currentTime <= endTime) {
                const fachId = lektion[dayKey];
                if (fachId) {
                    const fach = state.faecher.find(f => f.id === fachId);
                    if (fach) {
                        return { 
                            ...fach,
                            lektionIndex: lektion.lektion,
                            dayKey: dayKey,
                            endTime: endTime
                        };
                    }
                }
            }
        }
        return null;
    }

    // Alert-Tracking Variable
    let alertFachId = null;

    function getCurrentDayKey() {
        if (testMode.active) {
            const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
            return dayMap[testMode.day];
        }
        const dayMap = { 1: 'mo', 2: 'di', 3: 'mi', 4: 'do', 5: 'fr' };
        return dayMap[new Date().getDay()];
    }

    function getCurrentLektionIndex() {
        let currentTime;
        if (testMode.active) {
            const [h, m] = testMode.time.split(':').map(Number);
            currentTime = h * 60 + m;
        } else {
            const now = new Date();
            currentTime = now.getHours() * 60 + now.getMinutes();
        }

        for (const lektion of state.stundenplan) {
            const [start, end] = lektion.zeit.split('-');
            const [startH, startM] = start.split(':').map(Number);
            const [endH, endM] = end.split(':').map(Number);
            const startTime = startH * 60 + startM;
            const endTime = endH * 60 + endM;

            if (currentTime >= startTime && currentTime <= endTime) {
                return lektion.lektion;
            }
        }
        return null;
    }

    function updateDashboardStundenplan() {
        const tbody = document.getElementById('dashboard-stundenplan-body');
        const currentDayKey = getCurrentDayKey();
        const currentLektionIndex = getCurrentLektionIndex();

        let html = '';
        const days = ['mo', 'di', 'mi', 'do', 'fr'];

        state.stundenplan.forEach(lektion => {
            html += '<tr>';
            html += `<td style="font-weight: 600; white-space: nowrap;">${lektion.zeit}</td>`;
            
            days.forEach(day => {
                const fachId = lektion[day];
                const isCurrentDay = day === currentDayKey;
                const isCurrentLektion = lektion.lektion === currentLektionIndex;
                const isCurrentCell = isCurrentDay && isCurrentLektion && fachId;
                
                let cellClass = '';
                if (isCurrentCell) {
                    cellClass = 'current-lesson-cell';
                } else if (isCurrentDay) {
                    cellClass = 'current-day-column';
                }
                
                const fachDisplay = fachId ? getFachDisplayShort(fachId) : '-';
                html += `<td class="${cellClass}">${fachDisplay}</td>`;
            });
            
            html += '</tr>';
        });

        tbody.innerHTML = html;
    }

    function getFachDisplayShort(fachId) {
        if (!fachId) return '-';
        const fach = state.faecher.find(f => f.id === fachId);
        return fach ? `${fach.name} ${fach.klasse}` : '-';
    }

    function applyTestTime() {
        const day = document.getElementById('test-day').value;
        const time = document.getElementById('test-time').value;
        const speed = parseInt(document.getElementById('test-speed').value) || 1;
        
        if (!day || !time) {
            showToast('Bitte Wochentag und Startzeit wählen', 'error');
            return;
        }
        
        // Stop any existing interval
        if (testMode.intervalId) {
            clearInterval(testMode.intervalId);
        }
        
        const [h, m] = time.split(':').map(Number);
        
        testMode.active = true;
        testMode.day = parseInt(day);
        testMode.speed = speed;
        testMode.startRealTime = Date.now();
        testMode.startSimTime = h * 60 + m; // in minutes
        
        // Update time display
        updateTestModeTime();
        
        // Start interval to update time
        testMode.intervalId = setInterval(() => {
            updateTestModeTime();
            updateDashboard();
        }, 1000); // Update every second
        
        updateDashboard();
        showToast(`Test-Modus gestartet (${speed}× Geschwindigkeit)`, 'success');
    }

    function updateTestModeTime() {
        if (!testMode.active) {
            document.getElementById('test-mode-sidebar').style.display = 'none';
            return;
        }
        
        const elapsedRealMs = Date.now() - testMode.startRealTime;
        const elapsedSimMinutes = (elapsedRealMs / 1000 / 60) * testMode.speed;
        const currentSimMinutes = testMode.startSimTime + elapsedSimMinutes;
        
        const hours = Math.floor(currentSimMinutes / 60) % 24;
        const minutes = Math.floor(currentSimMinutes % 60);
        
        testMode.time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        
        const dayNames = ['', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag'];
        const statusText = `${dayNames[testMode.day]}, ${testMode.time} (${testMode.speed}×)`;
        
        // Update in Export section
        document.getElementById('test-mode-status').innerHTML = 
            `<span style="color: var(--primary); font-weight: 600;">▶ ${statusText}</span>`;
        
        // Update in Sidebar
        document.getElementById('test-mode-sidebar').style.display = 'block';
        document.getElementById('test-time-display').textContent = statusText;
    }

    function resetTestTime() {
        if (testMode.intervalId) {
            clearInterval(testMode.intervalId);
            testMode.intervalId = null;
        }
        
        testMode.active = false;
        testMode.day = null;
        testMode.time = null;
        testMode.speed = 1;
        testMode.startRealTime = null;
        testMode.startSimTime = null;
        
        document.getElementById('test-day').value = '';
        document.getElementById('test-time').value = '';
        document.getElementById('test-speed').value = '1';
        document.getElementById('test-mode-status').innerHTML = '';
        document.getElementById('test-mode-sidebar').style.display = 'none';
        
        updateDashboard();
        showToast('Test-Modus deaktiviert', 'success');
    }

    function checkCurrentLesson() {
        updateDashboard();
    }

    function updateFachSelects() {
        const selectConfigs = {
            'select-fach-klasse': '-- Fach wählen --',
            'eval-fach-klasse': '-- Fach wählen --',
            'config-schueler-fach': '-- Fach wählen --'
        };
        const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id]);

        Object.entries(selectConfigs).forEach(([id, placeholder]) => {
            const select = document.getElementById(id);
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = `<option value="">${placeholder}</option>`;
            
            enabledFaecher.forEach(fach => {
                const option = document.createElement('option');
                option.value = fach.id;
                option.textContent = `${fach.name} ${fach.klasse} (${fach.schuelerIds.length} Schüler)`;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        });
    }

    // ========================================
    // NAVIGATION
    // ========================================

    function showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById('screen-' + screenName).classList.add('active');
        document.querySelector(`.nav-item[data-screen="${screenName}"]`).classList.add('active');

        // Close mobile sidebar
        document.getElementById('sidebar').classList.remove('open');

        // Screen-specific updates
        if (screenName === 'evaluation') {
            updateEvaluation();
        } else if (screenName === 'export') {
            updateDemoObservationCount();
        }
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    function showConfigTab(tabName) {
        document.querySelectorAll('.config-tab').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
        
        document.getElementById('config-' + tabName).style.display = 'block';
        event.target.classList.add('active');
    }

    // ========================================
    // OBSERVATION
    // ========================================

    function startObservation() {
        const fachId = document.getElementById('select-fach-klasse').value;
        if (!fachId) {
            document.getElementById('observation-container').style.display = 'none';
            document.getElementById('observation-complete').style.display = 'none';
            return;
        }

        currentSession.fachId = fachId;
        currentSession.questions = generateQuestions(fachId, 5);
        currentSession.currentIndex = 0;
        currentSession.completed = 0;

        if (currentSession.questions.length === 0) {
            showToast('Keine Fragen verfügbar für diese Auswahl.', 'error');
            return;
        }

        document.getElementById('observation-container').style.display = 'block';
        document.getElementById('observation-complete').style.display = 'none';
        document.getElementById('question-total').textContent = currentSession.questions.length;
        
        showCurrentQuestion();
    }

    function generateQuestions(fachId, count) {
        const fach = state.faecher.find(f => f.id === fachId);
        if (!fach) return [];

        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
        const questions = [];
        const gaps = calculateGaps().filter(g => g.fachId === fachId);
        
        // Zähler für Schüler (max 3 pro Runde)
        const schuelerCount = {};
        const MAX_PER_SCHUELER = 3;

        // Prioritize gaps
        for (const gap of gaps) {
            if (questions.length >= count) break;
            
            // Max 3 pro Schüler prüfen
            if ((schuelerCount[gap.schuelerId] || 0) >= MAX_PER_SCHUELER) continue;
            
            const krit = enabledKriterien.find(k => k.id === gap.kriteriumId);
            if (!krit) continue;

            const indikatoren = INDIKATOREN[krit.id];
            const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

            questions.push({
                schuelerId: gap.schuelerId,
                kriteriumId: krit.id,
                indikator
            });
            
            schuelerCount[gap.schuelerId] = (schuelerCount[gap.schuelerId] || 0) + 1;
        }

        // Fill remaining with random (auch hier max 3 pro Schüler)
        let attempts = 0;
        while (questions.length < count && attempts < 100) {
            attempts++;
            const schuelerId = fach.schuelerIds[Math.floor(Math.random() * fach.schuelerIds.length)];
            
            // Max 3 pro Schüler prüfen
            if ((schuelerCount[schuelerId] || 0) >= MAX_PER_SCHUELER) continue;
            
            const krit = enabledKriterien[Math.floor(Math.random() * enabledKriterien.length)];
            const indikatoren = INDIKATOREN[krit.id];
            const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

            questions.push({
                schuelerId,
                kriteriumId: krit.id,
                indikator
            });
            
            schuelerCount[schuelerId] = (schuelerCount[schuelerId] || 0) + 1;
        }

        return questions;
    }

    function showCurrentQuestion() {
        const q = currentSession.questions[currentSession.currentIndex];
        const schueler = state.schueler.find(s => s.id === q.schuelerId);
        const fach = state.faecher.find(f => f.id === currentSession.fachId);
        const krit = KRITERIEN.find(k => k.id === q.kriteriumId);

        document.getElementById('question-number').textContent = currentSession.currentIndex + 1;
        document.getElementById('q-student').textContent = `${schueler.vorname} ${schueler.nachname}`;
        document.getElementById('q-fach').textContent = `${fach.name} ${fach.klasse}`;
        document.getElementById('q-kriterium').textContent = `${krit.id} ${krit.bereich}`;
        document.getElementById('q-indicator').textContent = q.indikator;

        const progress = (currentSession.currentIndex / currentSession.questions.length) * 100;
        document.getElementById('session-progress').textContent = Math.round(progress) + '%';
        document.getElementById('session-progress-fill').style.width = progress + '%';
    }

    function submitRating(rating) {
        const q = currentSession.questions[currentSession.currentIndex];

        if (rating > 0) {
            state.beobachtungen.push({
                id: Date.now().toString(),
                schuelerId: q.schuelerId,
                fachId: currentSession.fachId,
                kriteriumId: q.kriteriumId,
                indikator: q.indikator,
                rating,
                timestamp: new Date().toISOString()
            });
            currentSession.completed++;
            saveState();
        }

        currentSession.currentIndex++;

        if (currentSession.currentIndex >= currentSession.questions.length) {
            finishSession();
        } else {
            showCurrentQuestion();
        }

        updateStats();
    }

    function finishSession() {
        document.getElementById('observation-container').style.display = 'none';
        document.getElementById('observation-complete').style.display = 'block';
        document.getElementById('completed-count').textContent = currentSession.completed;
    }

    function startNewRound() {
        startObservation();
    }

    // ========================================
    // EVALUATION
    // ========================================

    function updateEvaluationStudentSelect() {
        const fachId = document.getElementById('eval-fach-klasse').value;
        const select = document.getElementById('eval-student');
        
        select.innerHTML = '<option value="">-- Schüler wählen --</option>';
        
        if (fachId) {
            const fach = state.faecher.find(f => f.id === fachId);
            console.log('Fach gefunden:', fach);
            console.log('Anzahl Schüler im State:', state.schueler.length);
            
            if (fach && fach.schuelerIds && fach.schuelerIds.length > 0) {
                // Schüler sammeln und nach Nachname sortieren
                const schuelerList = fach.schuelerIds
                    .map(sid => state.schueler.find(st => st.id === sid))
                    .filter(s => s)
                    .sort((a, b) => a.nachname.localeCompare(b.nachname));
                
                console.log('Schüler gefunden:', schuelerList.length);
                
                if (schuelerList.length === 0) {
                    // Fallback: Zeige alle Schüler wenn keine gefunden
                    console.warn('Keine Schüler gefunden für Fach, zeige alle');
                }
                
                schuelerList.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `${s.nachname}, ${s.vorname}`;
                    select.appendChild(option);
                });
            } else {
                console.warn('Fach hat keine schuelerIds:', fach);
            }
        }
    }

    function updateEvaluation() {
        const fachId = document.getElementById('eval-fach-klasse').value;
        const container = document.getElementById('evaluation-content');
        
        // WICHTIG: Student-Auswahl VORHER speichern!
        const currentStudentId = document.getElementById('eval-student').value;
        
        // Schülerliste aktualisieren (nur wenn Fach gewählt)
        updateEvaluationStudentSelect();
        
        // Student-Auswahl wiederherstellen (falls vorhanden und noch gültig)
        if (currentStudentId) {
            const studentSelect = document.getElementById('eval-student');
            // Prüfen ob der Schüler noch in der Liste ist
            const optionExists = Array.from(studentSelect.options).some(opt => opt.value === currentStudentId);
            if (optionExists) {
                studentSelect.value = currentStudentId;
            }
        }
        
        const studentId = document.getElementById('eval-student').value;

        if (!fachId) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <h3>Fach wählen</h3>
                    <p>Wähle zuerst ein Fach aus der Liste oben.</p>
                </div>
            `;
            return;
        }

        if (!studentId) {
            container.innerHTML = `
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <h3>Schüler auswählen</h3>
                    <p>Wähle jetzt einen Schüler aus der Liste.</p>
                </div>
            `;
            return;
        }

        showStudentEvaluation(studentId, fachId);
    }

    function showStudentEvaluation(studentId, fachId) {
        const student = state.schueler.find(s => s.id === studentId);
        const fach = fachId ? state.faecher.find(f => f.id === fachId) : null;
        const container = document.getElementById('evaluation-content');

        let beobachtungen = state.beobachtungen.filter(b => b.schuelerId === studentId);
        if (fachId) {
            beobachtungen = beobachtungen.filter(b => b.fachId === fachId);
        }

        if (beobachtungen.length === 0) {
            container.innerHTML = `
                <div class="card">
                    <h3>${student.vorname} ${student.nachname}</h3>
                    <p style="color: var(--text-light); margin-top: 12px;">Noch keine Beobachtungen erfasst.</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">${student.vorname} ${student.nachname}</h2>
                    <span>${beobachtungen.length} Beobachtungen</span>
                </div>
                <div class="boxplot-container">
        `;

        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
        
        enabledKriterien.forEach(krit => {
            const kritBeob = beobachtungen.filter(b => b.kriteriumId === krit.id);
            const ratings = kritBeob.map(b => b.rating);
            const key = `${studentId}-${fachId || 'all'}-${krit.id}`;
            const currentNote = state.zeugnisNoten[key] || 0;
            
            html += `
                <div class="boxplot-row">
                    <div class="boxplot-label">
                        ${krit.name}
                        <span class="boxplot-info" onclick="showKriteriumInfo('${krit.id}')" title="Indikatoren anzeigen">i</span>
                    </div>
                    <span class="boxplot-divider">–</span>
                    <div class="boxplot-chart">
                        ${renderBoxplot(ratings)}
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="showDetailModal('${studentId}', '${fachId || ''}', '${krit.id}')" style="padding: 4px 10px; font-size: 0.8rem;">
                        Details
                    </button>
                    <div class="zeugnis-select" style="margin-left: 8px;">
                        <button class="zeugnis-btn ${currentNote === 1 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 1)">1</button>
                        <button class="zeugnis-btn ${currentNote === 2 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 2)">2</button>
                        <button class="zeugnis-btn ${currentNote === 3 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 3)">3</button>
                        <button class="zeugnis-btn ${currentNote === 4 ? 'selected' : ''}" onclick="setZeugnisNote('${key}', 4)">4</button>
                    </div>
                </div>
            `;
        });

        html += `
                    <div class="boxplot-row" style="border-bottom: none; padding-top: 0;">
                        <div class="boxplot-label"></div>
                        <span class="boxplot-divider" style="visibility: hidden;">–</span>
                        <div class="boxplot-scale">
                            <span>1</span><span>2</span><span>3</span><span>4</span>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="visibility: hidden; padding: 4px 10px;">Details</button>
                        <div class="zeugnis-select" style="margin-left: 8px; visibility: hidden;">
                            <button class="zeugnis-btn">1</button>
                            <button class="zeugnis-btn">2</button>
                            <button class="zeugnis-btn">3</button>
                            <button class="zeugnis-btn">4</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    function showFachOverview(fachId) {
        const fach = state.faecher.find(f => f.id === fachId);
        const container = document.getElementById('evaluation-content');

        const beobachtungen = state.beobachtungen.filter(b => b.fachId === fachId);

        let html = `
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">${fach.name} ${fach.klasse}</h2>
                    <span>${beobachtungen.length} Beobachtungen</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Schüler/in</th>
                                <th>Beob.</th>
                                <th>Ø Bewertung</th>
                                <th>Abdeckung</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
        `;

        fach.schuelerIds.forEach(sid => {
            const s = state.schueler.find(st => st.id === sid);
            if (!s) return;

            const sBeob = beobachtungen.filter(b => b.schuelerId === sid);
            const avg = sBeob.length > 0 
                ? (sBeob.reduce((sum, b) => sum + b.rating, 0) / sBeob.length).toFixed(2)
                : '-';
            
            const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);
            const coveredKriterien = new Set(sBeob.map(b => b.kriteriumId)).size;
            const coverage = Math.round((coveredKriterien / enabledKriterien.length) * 100);

            html += `
                <tr>
                    <td>${s.nachname}, ${s.vorname}</td>
                    <td>${sBeob.length}</td>
                    <td>${avg}</td>
                    <td>
                        <div class="progress-bar" style="width: 100px; height: 6px;">
                            <div class="progress-fill" style="width: ${coverage}%"></div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 4px 12px; font-size: 0.85rem;" onclick="document.getElementById('eval-student').value='${sid}'; updateEvaluation();">
                            Details
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div></div>';
        container.innerHTML = html;
    }

    function renderBoxplot(ratings) {
        if (ratings.length === 0) {
            return '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.8rem; color: var(--text-light);">Keine Daten</div>';
        }

        const sorted = [...ratings].sort((a, b) => a - b);
        const min = sorted[0];
        const max = sorted[sorted.length - 1];
        
        // Verbesserte Quartil-Berechnung (lineare Interpolation)
        function percentile(arr, p) {
            if (arr.length === 1) return arr[0];
            const index = (arr.length - 1) * p;
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index - lower;
            if (upper >= arr.length) return arr[lower];
            return arr[lower] * (1 - weight) + arr[upper] * weight;
        }
        
        const q1 = percentile(sorted, 0.25);
        const median = percentile(sorted, 0.5);
        const q3 = percentile(sorted, 0.75);

        // Scale to percentage (1-4 -> 0-100%)
        const scale = (v) => ((v - 1) / 3) * 100;

        const boxLeft = scale(q1);
        const boxRight = scale(q3);
        const boxWidth = Math.max(boxRight - boxLeft, 0);
        const medianPos = scale(median);
        const minPos = scale(min);
        const maxPos = scale(max);

        // Berechne Whisker-Breiten (können 0 sein)
        const leftWhiskerWidth = Math.max(boxLeft - minPos, 0);
        const rightWhiskerWidth = Math.max(maxPos - boxRight, 0);

        return `
            ${leftWhiskerWidth > 0 ? `<div class="boxplot-whisker-end" style="left: ${minPos}%;"></div>` : ''}
            ${leftWhiskerWidth > 0 ? `<div class="boxplot-whisker" style="left: ${minPos}%; width: ${leftWhiskerWidth}%;"></div>` : ''}
            <div class="boxplot-box" style="left: ${boxLeft}%; width: ${Math.max(boxWidth, 3)}%;"></div>
            <div class="boxplot-median" style="left: ${medianPos}%;"></div>
            ${rightWhiskerWidth > 0 ? `<div class="boxplot-whisker" style="left: ${boxRight}%; width: ${rightWhiskerWidth}%;"></div>` : ''}
            ${rightWhiskerWidth > 0 ? `<div class="boxplot-whisker-end" style="left: ${maxPos}%;"></div>` : ''}
        `;
    }

    function setZeugnisNote(key, note) {
        // Toggle: Wenn gleiche Note nochmal geklickt wird, deaktivieren
        if (state.zeugnisNoten[key] === note) {
            delete state.zeugnisNoten[key];
        } else {
            state.zeugnisNoten[key] = note;
        }
        saveState();
        updateEvaluation();
    }

    function showDetailModal(studentId, fachId, kriteriumId) {
        const student = state.schueler.find(s => s.id === studentId);
        const krit = KRITERIEN.find(k => k.id === kriteriumId);
        
        let beobachtungen = state.beobachtungen.filter(b => 
            b.schuelerId === studentId && b.kriteriumId === kriteriumId
        );
        if (fachId) {
            beobachtungen = beobachtungen.filter(b => b.fachId === fachId);
        }

        document.getElementById('modal-title').textContent = 
            `${student.vorname} ${student.nachname} - ${krit.id}`;

        let html = `<p style="margin-bottom: 16px; color: var(--text-light);">${krit.name}</p>`;
        
        if (beobachtungen.length === 0) {
            html += '<p>Keine Beobachtungen vorhanden.</p>';
        } else {
            html += '<table style="width: 100%;"><thead><tr><th>Datum</th><th>Indikator</th><th>Bewertung</th></tr></thead><tbody>';
            
            beobachtungen.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            beobachtungen.forEach(b => {
                const date = new Date(b.timestamp).toLocaleDateString('de-CH');
                const ratingLabels = ['', 'nicht genügend', 'genügend', 'gut', 'sehr gut'];
                html += `
                    <tr>
                        <td>${date}</td>
                        <td style="font-size: 0.9rem;">${b.indikator}</td>
                        <td><span class="chip">${b.rating} - ${ratingLabels[b.rating]}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
        }

        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('detail-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('detail-modal').classList.remove('active');
    }

    function showKriteriumInfo(kriteriumId) {
        const krit = KRITERIEN.find(k => k.id === kriteriumId);
        const indikatoren = INDIKATOREN[kriteriumId] || [];
        
        document.getElementById('modal-title').textContent = `${krit.id} – ${krit.name}`;
        
        let html = `
            <p style="margin-bottom: 16px; color: var(--text-light);">
                <strong>Bereich:</strong> ${krit.bereich}
            </p>
            <h4 style="margin-bottom: 12px;">Indikatoren:</h4>
            <ul style="margin: 0; padding-left: 20px;">
        `;
        
        indikatoren.forEach(ind => {
            html += `<li style="margin-bottom: 8px; line-height: 1.5;">${ind}</li>`;
        });
        
        html += '</ul>';
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('detail-modal').classList.add('active');
    }

    // ========================================
    // OBSERVATION MODAL
    // ========================================

    function openObservationModal() {
        const currentFach = getCurrentFach();
        if (!currentFach) {
            showToast('Keine aktuelle Lektion erkannt', 'error');
            return;
        }

        // Status zurücksetzen
        alertFachId = null;

        const questionsCount = state.semester.questionsPerRound || calculateMinQuestionsPerLesson();
        currentSession.fachId = currentFach.id;
        currentSession.questions = generateQuestions(currentFach.id, questionsCount);
        currentSession.currentIndex = 0;
        currentSession.completed = 0;

        if (currentSession.questions.length === 0) {
            showToast('Keine Fragen verfügbar', 'error');
            return;
        }

        document.getElementById('obs-modal-fach').textContent = `${currentFach.name} ${currentFach.klasse}`;
        document.getElementById('obs-question-total').textContent = currentSession.questions.length;
        
        showModalQuestion();
        document.getElementById('observation-modal').classList.add('active');
    }

    function showModalQuestion() {
        const q = currentSession.questions[currentSession.currentIndex];
        const schueler = state.schueler.find(s => s.id === q.schuelerId);
        const krit = KRITERIEN.find(k => k.id === q.kriteriumId);

        document.getElementById('obs-question-number').textContent = currentSession.currentIndex + 1;
        document.getElementById('obs-student').textContent = `${schueler.vorname} ${schueler.nachname}`;
        document.getElementById('obs-kriterium').textContent = `${krit.id} ${krit.bereich}`;
        document.getElementById('obs-indicator').textContent = q.indikator;

        const progress = (currentSession.currentIndex / currentSession.questions.length) * 100;
        document.getElementById('obs-session-progress').textContent = Math.round(progress) + '%';
        document.getElementById('obs-progress-fill').style.width = progress + '%';
    }

    function submitModalRating(rating) {
        const q = currentSession.questions[currentSession.currentIndex];

        if (rating > 0) {
            state.beobachtungen.push({
                id: Date.now().toString(),
                schuelerId: q.schuelerId,
                fachId: currentSession.fachId,
                kriteriumId: q.kriteriumId,
                indikator: q.indikator,
                rating,
                timestamp: new Date().toISOString()
            });
            currentSession.completed++;
            saveState();
        }

        currentSession.currentIndex++;

        if (currentSession.currentIndex >= currentSession.questions.length) {
            closeObservationModal();
            showObservationCompleteModal();
        } else {
            showModalQuestion();
        }

        updateStats();
    }

    function closeObservationModal() {
        document.getElementById('observation-modal').classList.remove('active');
        // Dashboard aktualisieren, damit "noch zu erledigen" wieder angezeigt wird
        updateDashboard();
    }

    function showObservationCompleteModal() {
        document.getElementById('obs-completed-count').textContent = currentSession.completed;
        document.getElementById('observation-complete-modal').classList.add('active');
    }

    function closeObservationCompleteModal() {
        document.getElementById('observation-complete-modal').classList.remove('active');
        updateDashboard();
    }

    function startNewObservationRound() {
        closeObservationCompleteModal();
        openObservationModal();
    }

    // ========================================
    // CONFIGURATION
    // ========================================

    function updateSemesterConfig() {
        document.getElementById('config-semester-start').value = state.semester.start;
        document.getElementById('config-semester-end').value = state.semester.end;
        document.getElementById('config-target').value = state.semester.targetObservations;
        document.getElementById('config-questions-per-round').value = state.semester.questionsPerRound || 13;
        updateMinQuestionsDisplay();
    }

    function calculateMinQuestionsPerLesson() {
        // Zähle Schüler-Fach-Kombinationen
        let totalCombinations = 0;
        state.faecher.forEach(fach => {
            if (state.faecherEnabled[fach.id]) {
                totalCombinations += fach.schuelerIds.length;
            }
        });

        // Zähle aktivierte Kriterien
        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id] !== false).length;

        // Gesamtanzahl nötige Beobachtungen
        const totalObservations = totalCombinations * enabledKriterien * state.semester.targetObservations;

        // Zähle Lektionen pro Woche aus Stundenplan
        let lessonsPerWeek = 0;
        state.stundenplan.forEach(lektion => {
            ['mo', 'di', 'mi', 'do', 'fr'].forEach(day => {
                if (lektion[day] && state.faecherEnabled[lektion[day]]) {
                    lessonsPerWeek++;
                }
            });
        });

        if (lessonsPerWeek === 0) return 13; // Fallback

        // Wochen im Semester berechnen
        const start = new Date(state.semester.start);
        const end = new Date(state.semester.end);
        const weeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));

        // Gesamtanzahl Lektionen
        const totalLessons = lessonsPerWeek * weeks;

        if (totalLessons === 0) return 13; // Fallback

        // Minimum pro Lektion (aufgerundet)
        return Math.ceil(totalObservations / totalLessons);
    }

    function updateMinQuestionsDisplay() {
        const min = calculateMinQuestionsPerLesson();
        document.getElementById('min-questions-display').textContent = min;
        
        // Falls noch keine questionsPerRound gesetzt ist, setze auf Minimum
        if (!state.semester.questionsPerRound) {
            state.semester.questionsPerRound = min;
            document.getElementById('config-questions-per-round').value = min;
        }
    }

    function saveSemesterConfig() {
        state.semester.start = document.getElementById('config-semester-start').value;
        state.semester.end = document.getElementById('config-semester-end').value;
        state.semester.targetObservations = parseInt(document.getElementById('config-target').value) || 3;
        state.semester.questionsPerRound = parseInt(document.getElementById('config-questions-per-round').value) || 13;
        saveState();
        updateStats();
        updateMinQuestionsDisplay();
        showToast('Semester-Einstellungen gespeichert', 'success');
    }

    function updateKriterienList() {
        const container = document.getElementById('kriterien-list');
        let html = '';

        KRITERIEN.forEach(krit => {
            const enabled = state.kriterienEnabled[krit.id] !== false;
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <strong>${krit.id}</strong> ${krit.name}
                        <div style="font-size: 0.85rem; color: var(--text-light);">${krit.bereich} - ${INDIKATOREN[krit.id].length} Indikatoren</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleKriterium('${krit.id}')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function toggleKriterium(kritId) {
        state.kriterienEnabled[kritId] = !state.kriterienEnabled[kritId];
        saveState();
        updateStats();
    }

    function updateFaecherList() {
        const container = document.getElementById('faecher-list');
        let html = '';

        state.faecher.forEach(fach => {
            const enabled = state.faecherEnabled[fach.id] !== false;
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <strong>${fach.name}</strong> ${fach.klasse}
                        <div style="font-size: 0.85rem; color: var(--text-light);">${fach.schuelerIds.length} Schüler</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="toggleFach('${fach.id}')">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function toggleFach(fachId) {
        state.faecherEnabled[fachId] = !state.faecherEnabled[fachId];
        saveState();
        updateFachSelects();
        updateStats();
    }

    function showSchuelerList() {
        const fachId = document.getElementById('config-schueler-fach').value;
        const container = document.getElementById('schueler-list-container');

        if (!fachId) {
            container.innerHTML = '';
            return;
        }

        const fach = state.faecher.find(f => f.id === fachId);
        let html = '<table style="width: 100%;"><thead><tr><th>#</th><th>Nachname</th><th>Vorname</th></tr></thead><tbody>';

        fach.schuelerIds.forEach((sid, i) => {
            const s = state.schueler.find(st => st.id === sid);
            if (s) {
                html += `<tr><td>${i + 1}</td><td>${s.nachname}</td><td>${s.vorname}</td></tr>`;
            }
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // ========================================
    // EXPORT / IMPORT
    // ========================================

    function exportData() {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `las-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        showToast('Daten exportiert', 'success');
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                state = imported;
                saveState();
                updateUI();
                showToast('Daten importiert', 'success');
            } catch (err) {
                showToast('Fehler beim Import: ' + err.message, 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function generateDemoData(count) {
        const enabledFaecher = state.faecher.filter(f => state.faecherEnabled[f.id]);
        const enabledKriterien = KRITERIEN.filter(k => state.kriterienEnabled[k.id]);

        for (let i = 0; i < count; i++) {
            const fach = enabledFaecher[Math.floor(Math.random() * enabledFaecher.length)];
            const schuelerId = fach.schuelerIds[Math.floor(Math.random() * fach.schuelerIds.length)];
            const krit = enabledKriterien[Math.floor(Math.random() * enabledKriterien.length)];
            const indikatoren = INDIKATOREN[krit.id];
            const indikator = indikatoren[Math.floor(Math.random() * indikatoren.length)];

            // Generate somewhat realistic rating (mostly 3, some 2 and 4, few 1)
            const rand = Math.random();
            let rating;
            if (rand < 0.05) rating = 1;
            else if (rand < 0.25) rating = 2;
            else if (rand < 0.75) rating = 3;
            else rating = 4;

            // Random date within semester
            const start = new Date(state.semester.start);
            const end = new Date(state.semester.end);
            const randomDate = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));

            state.beobachtungen.push({
                id: Date.now().toString() + i,
                schuelerId,
                fachId: fach.id,
                kriteriumId: krit.id,
                indikator,
                rating,
                timestamp: randomDate.toISOString()
            });
        }

        saveState();
        updateUI();
        showToast(`${count} Demo-Beobachtungen generiert`, 'success');
    }

    function clearAllData() {
        if (confirm('Wirklich alle Daten löschen? Dies kann nicht rückgängig gemacht werden!')) {
            localStorage.removeItem('las-state');
            location.reload();
        }
    }

    // ========================================
    // UTILITIES
    // ========================================

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', init);
</script>
```

</body>
</html>