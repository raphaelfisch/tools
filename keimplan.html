<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Keimplan Generator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Keimplan">
    <meta name="theme-color" content="#43a047">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2343a047' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='50'>üå±</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Fraunces:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg-primary: #f7f9f7;
            --bg-secondary: #fff;
            --bg-accent: #e8f5e9;
            --bg-accent-2: #fff8e1;
            --bg-accent-3: #e3f2fd;
            --text-primary: #1a2e1a;
            --text-secondary: #5a6e5a;
            --accent-green: #43a047;
            --accent-green-light: #66bb6a;
            --accent-orange: #fb8c00;
            --accent-orange-light: #ffa726;
            --accent-blue: #1e88e5;
            --border: #d5e5d5;
            --shadow: rgba(26, 46, 26, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem 0;
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
        }

        h1 span {
            color: var(--accent-green);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Steps Navigation - KLICKBAR */
        .steps {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .step:hover {
            border-color: var(--accent-green);
            background: var(--bg-accent);
        }

        .step.active {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: white;
        }

        .step.done {
            background: var(--bg-accent);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .step.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step.locked:hover {
            background: var(--bg-secondary);
            border-color: var(--border);
        }

        /* Step Numbers - KONTRAST FIX */
        .step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            /* Default: dunkle Zahl auf hellem Hintergrund */
            background: var(--border);
            color: var(--text-primary);
        }

        .step.active .step-num {
            background: white;
            color: var(--accent-green);
        }

        .step.done .step-num {
            background: var(--accent-green);
            color: white;
        }

        /* Card */
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px var(--shadow);
            border: 1px solid var(--border);
        }

        .card-title {
            font-family: 'Fraunces', serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title .icon {
            font-size: 1.3rem;
        }

        /* Step Sections - nur aktiver Step ist sichtbar */
        .step-section {
            display: none;
        }

        .step-section.active {
            display: block;
        }

        /* Camera */
        .camera-container {
            position: relative;
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
            margin-bottom: 1rem;
        }

        #video, #preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #preview { display: none; }

        .camera-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
            padding: 1.5rem;
        }

        .camera-overlay.hidden { display: none; }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 100px;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
        }

        .btn-primary {
            background: var(--accent-orange);
            color: white;
        }

        .btn-primary:hover {
            background: #e57c00;
        }

        .btn-secondary {
            background: var(--bg-accent);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #d0e8d0;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            margin-top: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--accent-green);
            background: var(--bg-accent);
        }

        .upload-area input { display: none; }

        /* Progress */
        .progress-container {
            margin-top: 1rem;
            display: none;
        }

        .progress-container.active { display: block; }

        .progress-bar {
            height: 6px;
            background: var(--bg-accent);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-green-light));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.4rem;
            text-align: center;
        }

        /* Config Groups */
        .config-group {
            background: var(--bg-accent);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .config-group.highlight {
            background: var(--bg-accent-2);
            border: 2px solid var(--accent-orange);
        }

        .config-group.blue {
            background: var(--bg-accent-3);
            border: 2px solid var(--accent-blue);
        }

        .config-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .config-label .badge {
            font-size: 0.7rem;
            background: var(--accent-orange);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 500;
        }

        .config-label .badge.blue {
            background: var(--accent-blue);
        }

        .time-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .time-input-group input[type="date"],
        .time-input-group input[type="time"] {
            padding: 0.6rem 0.8rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            background: white;
        }

        .time-input-group input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* Sp√ºlzeiten */
        .rinse-times-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .rinse-time-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.6rem;
            border-radius: 8px;
        }

        .rinse-time-row label {
            font-size: 0.85rem;
            min-width: 80px;
            color: var(--text-secondary);
        }

        .rinse-time-row input[type="time"] {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .rinse-count-selector {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        .rinse-count-btn {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: white;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .rinse-count-btn:hover {
            border-color: var(--accent-blue);
        }

        .rinse-count-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Timespan Config */
        .timespan-item {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }

        .timespan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .timespan-name {
            font-weight: 600;
        }

        .timespan-range {
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-accent);
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
        }

        .timespan-slider {
            width: 100%;
            margin: 0.5rem 0;
            -webkit-appearance: none;
            height: 8px;
            background: var(--bg-accent);
            border-radius: 4px;
            outline: none;
        }

        .timespan-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: var(--accent-green);
            border-radius: 50%;
            cursor: pointer;
        }

        .timespan-value {
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-green);
        }

        .quick-btns {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }

        .quick-btn {
            flex: 1;
            padding: 0.4rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .quick-btn:hover, .quick-btn.active {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        /* Extracted Info */
        .extracted-info {
            background: var(--bg-accent-2);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .extracted-info h4 {
            margin-bottom: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .info-item {
            background: white;
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
        }

        .info-item .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .info-item .value {
            font-weight: 700;
            color: var(--accent-green);
        }

        /* Schedule */
        .schedule-header {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-green-light));
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .schedule-header h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.2rem;
        }

        .schedule-header p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .schedule-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .schedule-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--bg-accent);
            border-radius: 2px;
        }

        .schedule-day {
            margin-bottom: 1.5rem;
        }

        .schedule-day-header {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--accent-green);
            margin-bottom: 0.75rem;
            position: relative;
        }

        .schedule-day-header::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 11px;
            height: 11px;
            background: var(--accent-green);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--accent-green);
        }

        .schedule-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-accent);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .schedule-item.highlight {
            background: var(--bg-accent-2);
            border-left: 3px solid var(--accent-orange);
        }

        .schedule-item.rinse {
            background: var(--bg-accent-3);
            border-left: 3px solid var(--accent-blue);
        }

        .schedule-time {
            min-width: 50px;
            font-weight: 700;
            color: var(--accent-orange);
            font-size: 0.9rem;
        }

        .schedule-item.rinse .schedule-time {
            color: var(--accent-blue);
        }

        .schedule-action {
            font-weight: 600;
        }

        .schedule-detail {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .export-section {
            margin-top: 1.25rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .hidden { display: none !important; }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-green-light));
            color: white;
            padding: 1rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            z-index: 1000;
        }

        .install-banner.show { display: flex; }

        .install-banner button {
            padding: 0.5rem 1rem;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        @media (display-mode: standalone) {
            .install-banner { display: none !important; }
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <!-- PWA Install Banner -->
    <div id="installBanner" class="install-banner">
        <div>
            <strong>üì≤ Als App installieren</strong><br>
            <small>Tippe auf "Teilen" ‚Üí "Zum Home-Bildschirm"</small>
        </div>
        <button onclick="closeInstallBanner()">OK</button>
    </div>

    <div class="container">
        <header>
            <h1>üå± Keim<span>plan</span> Generator</h1>
            <p class="subtitle">Scanne ‚Üí Konfiguriere ‚Üí Plan</p>
        </header>

        <!-- KLICKBARE STEPS -->
        <div class="steps">
            <div class="step active" id="step1" onclick="goToStep(1)">
                <span class="step-num">1</span>
                <span>Bild scannen</span>
            </div>
            <div class="step" id="step2" onclick="goToStep(2)">
                <span class="step-num">2</span>
                <span>Konfigurieren</span>
            </div>
            <div class="step" id="step3" onclick="goToStep(3)">
                <span class="step-num">3</span>
                <span>Zeitplan</span>
            </div>
        </div>

        <!-- STEP 1: Bild scannen -->
        <div id="section1" class="step-section active">
            <div class="card">
                <h2 class="card-title">
                    <span class="icon">üì∑</span>
                    Packung fotografieren
                </h2>

                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <img id="preview" alt="Vorschau">
                    <div id="cameraOverlay" class="camera-overlay">
                        <div>
                            <p style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</p>
                            <p>Fotografiere die R√ºckseite der Packung</p>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button id="btnStartCamera" class="btn btn-secondary" onclick="startCamera()">
                        üé• Kamera
                    </button>
                    <button id="btnCapture" class="btn btn-primary" onclick="capturePhoto()" disabled>
                        üì∏ Aufnehmen
                    </button>
                </div>

                <div class="btn-group" style="margin-top: 0.5rem;">
                    <button id="btnReset" class="btn btn-secondary hidden" onclick="resetCapture()">
                        üîÑ Neu
                    </button>
                    <button id="btnAnalyze" class="btn btn-success" onclick="analyzeImage()" disabled>
                        üîç Analysieren
                    </button>
                </div>

                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
                    <span style="font-size: 1.5rem;">üìÅ</span>
                    <p><strong>Bild hochladen</strong></p>
                </div>

                <div id="progressContainer" class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <p id="progressText" class="progress-text">Analysiere...</p>
                </div>
            </div>
        </div>

        <!-- STEP 2: Konfigurieren -->
        <div id="section2" class="step-section">
            <div class="card">
                <h2 class="card-title">
                    <span class="icon">‚öôÔ∏è</span>
                    Zeiten konfigurieren
                </h2>

                <div id="extractedInfo" class="extracted-info">
                    <h4>üìã Erkannte Angaben</h4>
                    <div id="infoGrid" class="info-grid"></div>
                </div>

                <div class="config-group highlight">
                    <div class="config-label">
                        üïê Startzeit
                        <span class="badge">Wann legst du los?</span>
                    </div>
                    <div class="time-input-group">
                        <input type="date" id="startDate">
                        <input type="time" id="startTime">
                    </div>
                </div>

                <div class="config-group blue">
                    <div class="config-label">
                        üöø Sp√ºlzeiten
                        <span class="badge blue">2x t√§glich</span>
                    </div>

                    <div id="rinseTimesContainer" class="rinse-times-container">
                        <div class="rinse-time-row">
                            <label>üåÖ Morgens</label>
                            <input type="time" id="rinseTime1" value="08:00">
                        </div>
                        <div class="rinse-time-row">
                            <label>üåô Abends</label>
                            <input type="time" id="rinseTime2" value="20:00">
                        </div>
                    </div>
                </div>

                <div id="timespanConfigs"></div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="generateSchedule()">
                        üìÖ Plan erstellen
                    </button>
                </div>
            </div>
        </div>

        <!-- STEP 3: Zeitplan -->
        <div id="section3" class="step-section">
            <div class="card">
                <div class="schedule-header">
                    <h3 id="scheduleName">Keimplan</h3>
                    <p id="scheduleSubtitle"></p>
                </div>

                <div id="scheduleTimeline" class="schedule-timeline"></div>

                <div class="export-section">
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="copySchedule()">
                            üìã Kopieren
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSchedule()">
                            üíæ Speichern
                        </button>
                        <button class="btn btn-secondary" onclick="addToCalendar()">
                            üìÜ Kalender
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let capturedImageData = null;
        let extractedData = {
            name: '',
            einweichen: { min: 6, max: 8, selected: 6 },
            temperatur: { min: 18, max: 22, selected: 20 },
            spuelen: { times: 2 },
            ernte: { min: 3, max: 5, selected: 3 },
            hinweise: ''
        };
        
        let rinseConfig = {
            count: 2,
            times: ['08:00', '20:00']
        };
        
        let generatedSchedule = [];
        let currentStep = 1;
        let unlockedStep = 1; // Nur Step 1 ist initial freigeschaltet

        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            document.getElementById('startDate').value = now.toISOString().split('T')[0];
            document.getElementById('startTime').value = now.toTimeString().slice(0, 5);
            
            updateConfigUI();
            updateStepStates();
            checkInstallBanner();
        });

        // Step Navigation - nur freigeschaltete Steps klickbar
        function goToStep(step) {
            if (step > unlockedStep) return; // Gesperrte Steps ignorieren
            
            currentStep = step;
            updateStepStates();

            // Sections anzeigen/verstecken
            document.querySelectorAll('.step-section').forEach((el, i) => {
                el.classList.toggle('active', i + 1 === step);
            });
        }

        function updateStepStates() {
            document.querySelectorAll('.step').forEach((el, i) => {
                const stepNum = i + 1;
                el.classList.remove('active', 'done', 'locked');
                
                if (stepNum < currentStep) {
                    el.classList.add('done');
                } else if (stepNum === currentStep) {
                    el.classList.add('active');
                } else if (stepNum > unlockedStep) {
                    el.classList.add('locked');
                }
            });
        }

        function unlockStep(step) {
            if (step > unlockedStep) {
                unlockedStep = step;
                updateStepStates();
            }
        }

        // PWA
        function checkInstallBanner() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isStandalone = window.navigator.standalone === true;
            const dismissed = localStorage.getItem('installBannerDismissed');
            
            if (isIOS && !isStandalone && !dismissed) {
                document.getElementById('installBanner').classList.add('show');
            }
        }

        function closeInstallBanner() {
            document.getElementById('installBanner').classList.remove('show');
            localStorage.setItem('installBannerDismissed', 'true');
        }

        // Sp√ºlzeiten werden direkt aus den Inputs gelesen

        // Camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('cameraOverlay').classList.add('hidden');
                document.getElementById('btnCapture').disabled = false;
                document.getElementById('btnStartCamera').disabled = true;
            } catch (err) {
                alert('Kamera nicht verf√ºgbar. Bitte lade ein Bild hoch.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            capturedImageData = canvas.toDataURL('image/jpeg', 0.9);
            document.getElementById('preview').src = capturedImageData;
            document.getElementById('video').style.display = 'none';
            document.getElementById('preview').style.display = 'block';
            
            document.getElementById('btnCapture').disabled = true;
            document.getElementById('btnReset').classList.remove('hidden');
            document.getElementById('btnAnalyze').disabled = false;
            unlockStep(2); // Step 2 freischalten
        }

        function resetCapture() {
            document.getElementById('video').style.display = 'block';
            document.getElementById('preview').style.display = 'none';
            capturedImageData = null;
            document.getElementById('btnCapture').disabled = false;
            document.getElementById('btnReset').classList.add('hidden');
            document.getElementById('btnAnalyze').disabled = true;
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                capturedImageData = e.target.result;
                document.getElementById('preview').src = capturedImageData;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('video').style.display = 'none';
                document.getElementById('cameraOverlay').classList.add('hidden');
                document.getElementById('btnReset').classList.remove('hidden');
                document.getElementById('btnAnalyze').disabled = false;
                unlockStep(2); // Step 2 freischalten
            };
            reader.readAsDataURL(file);
        }

        async function analyzeImage() {
            if (!capturedImageData) return;

            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.classList.add('active');
            document.getElementById('btnAnalyze').disabled = true;

            try {
                const result = await Tesseract.recognize(capturedImageData, 'deu+eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            progressFill.style.width = Math.round(m.progress * 100) + '%';
                            progressText.textContent = 'Erkenne Text... ' + Math.round(m.progress * 100) + '%';
                        } else if (m.status === 'loading language traineddata') {
                            progressText.textContent = 'Lade Sprachdaten...';
                        }
                    }
                });

                parseExtractedText(result.data.text);
                updateConfigUI();
                goToStep(2);

            } catch (error) {
                alert('Fehler: ' + error.message);
            } finally {
                progressContainer.classList.remove('active');
                document.getElementById('btnAnalyze').disabled = false;
            }
        }

        function parseExtractedText(text) {
            console.log('Erkannter Text:', text);
            
            const nameMatch = text.match(/(?:Red clover|Rotklee|Trifoglio|Tr√®fle|Alfalfa|Mungobohnen|Radieschen|Brokkoli)/i);
            if (nameMatch) extractedData.name = nameMatch[0];

            const soakMatch = text.match(/(\d+)\s*[-‚Äì]\s*(\d+)\s*h/i);
            if (soakMatch) {
                extractedData.einweichen.min = parseInt(soakMatch[1]);
                extractedData.einweichen.max = parseInt(soakMatch[2]);
                extractedData.einweichen.selected = extractedData.einweichen.min;
            }

            const tempMatch = text.match(/(\d+)\s*[-‚Äì]\s*(\d+)\s*¬∞?\s*C/i);
            if (tempMatch) {
                extractedData.temperatur.min = parseInt(tempMatch[1]);
                extractedData.temperatur.max = parseInt(tempMatch[2]);
            }

            const rinseMatch = text.match(/(\d+)\s*[x√ó]\s*(?:t√§glich|daily|jour|giorno)/i);
            if (rinseMatch) {
                extractedData.spuelen.times = parseInt(rinseMatch[1]);
            }

            const harvestMatch = text.match(/(\d+)\s*[-‚Äì]\s*(\d+)\s*(?:Tagen?|days?|jours?|giorni)/i);
            if (harvestMatch) {
                extractedData.ernte.min = parseInt(harvestMatch[1]);
                extractedData.ernte.max = parseInt(harvestMatch[2]);
                extractedData.ernte.selected = extractedData.ernte.min;
            }

            // Hinweise extrahieren
            const hinweisMatch = text.match(/(?:Vor dem Verzehr|vor Verzehr|before consumption)[:\s]*([^.]+\.)/i);
            if (hinweisMatch) {
                extractedData.hinweise = hinweisMatch[0].trim();
            }
        }

        function updateConfigUI() {
            const infoGrid = document.getElementById('infoGrid');
            infoGrid.innerHTML = `
                <div class="info-item">
                    <div class="label">Einweichen</div>
                    <div class="value">${extractedData.einweichen.min}-${extractedData.einweichen.max}h</div>
                </div>
                <div class="info-item">
                    <div class="label">Temperatur</div>
                    <div class="value">${extractedData.temperatur.min}-${extractedData.temperatur.max}¬∞C</div>
                </div>
                <div class="info-item">
                    <div class="label">Sp√ºlen</div>
                    <div class="value">2x t√§glich</div>
                </div>
                <div class="info-item">
                    <div class="label">Ernte</div>
                    <div class="value">${extractedData.ernte.min}-${extractedData.ernte.max} Tage</div>
                </div>
            `;

            document.getElementById('timespanConfigs').innerHTML = `
                ${createTimespanConfig('einweichen', 'üíß Einweichdauer', extractedData.einweichen, 'Stunden')}
                ${createTimespanConfig('ernte', 'üåø Keimdauer', extractedData.ernte, 'Tage')}
                
                <div class="timespan-item">
                    <div class="timespan-header">
                        <span class="timespan-name">üìù Hinweis vor Verzehr</span>
                    </div>
                    <textarea id="hinweisInput" 
                              style="width: 100%; min-height: 50px; padding: 0.5rem; border: 2px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.9rem; resize: vertical;"
                              placeholder="Von Packung erkannt oder manuell eingeben...">${extractedData.hinweise}</textarea>
                </div>
            `;
        }

        function createTimespanConfig(key, label, data, unit) {
            return `
                <div class="timespan-item">
                    <div class="timespan-header">
                        <span class="timespan-name">${label}</span>
                        <span class="timespan-range">${data.min}-${data.max} ${unit}</span>
                    </div>
                    <input type="range" class="timespan-slider" 
                           min="${data.min}" max="${data.max}" value="${data.selected}"
                           oninput="updateTimespan('${key}', this.value)">
                    <div class="timespan-value" id="${key}Value">${data.selected} ${unit}</div>
                    <div class="quick-btns">
                        <button class="quick-btn ${data.selected === data.min ? 'active' : ''}" onclick="setTimespan('${key}', ${data.min})">Min</button>
                        <button class="quick-btn" onclick="setTimespan('${key}', ${Math.round((data.min + data.max) / 2)})">Mittel</button>
                        <button class="quick-btn ${data.selected === data.max ? 'active' : ''}" onclick="setTimespan('${key}', ${data.max})">Max</button>
                    </div>
                </div>
            `;
        }

        function updateTimespan(key, value) {
            extractedData[key].selected = parseInt(value);
            const unit = key === 'einweichen' ? 'Stunden' : 'Tage';
            document.getElementById(key + 'Value').textContent = value + ' ' + unit;
        }

        function setTimespan(key, value) {
            extractedData[key].selected = value;
            updateConfigUI();
        }

        function generateSchedule() {
            const startDate = new Date(document.getElementById('startDate').value + 'T' + document.getElementById('startTime').value);
            generatedSchedule = [];

            const soakHours = extractedData.einweichen.selected;
            const harvestDays = extractedData.ernte.selected;
            const rinsePerDay = 2; // Fix 2x t√§glich
            
            // Sp√ºlzeiten aus Inputs lesen
            const rinseTimes = [
                document.getElementById('rinseTime1').value,
                document.getElementById('rinseTime2').value
            ].sort();

            // Einweichen Start
            generatedSchedule.push({
                date: new Date(startDate),
                action: 'Einweichen starten',
                detail: `Samen in Wasser f√ºr ${soakHours}h`,
                type: 'highlight'
            });

            // Einweichen Ende
            const soakEnd = new Date(startDate.getTime() + soakHours * 3600000);
            generatedSchedule.push({
                date: new Date(soakEnd),
                action: 'Einweichen beenden',
                detail: 'Abgiessen, sp√ºlen, ins Keimglas',
                type: 'highlight'
            });

            // Sp√ºlen ab Tag 1
            for (let day = 1; day <= harvestDays; day++) {
                rinseTimes.forEach((time, idx) => {
                    const [h, m] = time.split(':').map(Number);
                    const rinseDate = new Date(soakEnd);
                    rinseDate.setDate(rinseDate.getDate() + day);
                    rinseDate.setHours(h, m, 0, 0);

                    generatedSchedule.push({
                        date: rinseDate,
                        action: `Sp√ºlen (${idx + 1}/${rinsePerDay})`,
                        detail: 'Durchsp√ºlen und abtropfen',
                        type: 'rinse'
                    });
                });
            }

            // Ernte
            const lastRinse = rinseTimes[rinseTimes.length - 1];
            const [lh, lm] = lastRinse.split(':').map(Number);
            const harvestDate = new Date(soakEnd);
            harvestDate.setDate(harvestDate.getDate() + harvestDays);
            harvestDate.setHours(lh, lm + 30, 0, 0);
            
            const hinweis = document.getElementById('hinweisInput')?.value.trim() || '';
            
            generatedSchedule.push({
                date: harvestDate,
                action: 'üéâ Ernte m√∂glich!',
                detail: hinweis ? `Bereit! ${hinweis}` : 'Sprossen sind bereit.',
                type: 'highlight'
            });

            generatedSchedule.sort((a, b) => a.date - b.date);
            displaySchedule();
            unlockStep(3); // Step 3 freischalten
            goToStep(3);
        }

        function displaySchedule() {
            const name = extractedData.name || 'Sprossen';
            document.getElementById('scheduleName').textContent = name + ' Keimplan';
            
            const rinseTimes = [
                document.getElementById('rinseTime1').value,
                document.getElementById('rinseTime2').value
            ];
            document.getElementById('scheduleSubtitle').textContent = 
                `${extractedData.einweichen.selected}h ‚Ä¢ Sp√ºlen: ${rinseTimes.join(' & ')} ‚Ä¢ ${extractedData.ernte.selected} Tage`;

            const byDay = {};
            generatedSchedule.forEach(item => {
                const key = item.date.toDateString();
                if (!byDay[key]) byDay[key] = [];
                byDay[key].push(item);
            });

            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            let html = '';
            
            Object.entries(byDay).forEach(([dayKey, items]) => {
                const d = new Date(dayKey);
                const dayStr = `${days[d.getDay()]}, ${d.getDate()}.${d.getMonth() + 1}.`;
                
                html += `<div class="schedule-day">
                    <div class="schedule-day-header">${dayStr}</div>
                    ${items.map(item => `
                        <div class="schedule-item ${item.type}">
                            <div class="schedule-time">${item.date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</div>
                            <div>
                                <div class="schedule-action">${item.action}</div>
                                <div class="schedule-detail">${item.detail}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            });

            document.getElementById('scheduleTimeline').innerHTML = html;
        }

        function copySchedule() {
            let text = `üå± ${extractedData.name || 'Sprossen'} KEIMPLAN\n${'‚ïê'.repeat(25)}\n`;
            const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            let currentDay = '';
            
            generatedSchedule.forEach(item => {
                const d = item.date;
                const day = `${days[d.getDay()]}, ${d.getDate()}.${d.getMonth() + 1}.`;
                if (day !== currentDay) {
                    currentDay = day;
                    text += `\nüìÖ ${day}\n`;
                }
                text += `  ${d.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}  ${item.action}\n`;
            });

            navigator.clipboard.writeText(text).then(() => alert('Kopiert!'));
        }

        function downloadSchedule() {
            const blob = new Blob([JSON.stringify({
                name: extractedData.name,
                config: extractedData,
                schedule: generatedSchedule.map(i => ({
                    datetime: i.date.toISOString(),
                    action: i.action,
                    detail: i.detail
                }))
            }, null, 2)], { type: 'application/json' });
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `keimplan_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        }

        function addToCalendar() {
            // Hilfsfunktion f√ºr lokales Datumsformat (YYYYMMDDTHHMMSS)
            function formatLocalDate(date) {
                const pad = (n) => n.toString().padStart(2, '0');
                return date.getFullYear().toString() +
                    pad(date.getMonth() + 1) +
                    pad(date.getDate()) + 'T' +
                    pad(date.getHours()) +
                    pad(date.getMinutes()) +
                    pad(date.getSeconds());
            }
            
            // Aktuelle Zeit f√ºr DTSTAMP
            const now = formatLocalDate(new Date()) + 'Z';
            
            let ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Keimplan Generator//DE',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH'
            ];
            
            generatedSchedule.forEach((item, index) => {
                const startTime = formatLocalDate(item.date);
                const endDate = new Date(item.date.getTime() + 15 * 60000); // +15 Min
                const endTime = formatLocalDate(endDate);
                const uid = `keimplan-${Date.now()}-${index}@keimplan.app`;
                
                // Text f√ºr ICS escapen (Kommas, Semikolons, Newlines)
                const summary = item.action.replace(/[,;]/g, '\\$&');
                const description = item.detail.replace(/[,;]/g, '\\$&').replace(/\n/g, '\\n');
                
                ics.push(
                    'BEGIN:VEVENT',
                    `UID:${uid}`,
                    `DTSTAMP:${now}`,
                    `DTSTART:${startTime}`,
                    `DTEND:${endTime}`,
                    `SUMMARY:üå± ${summary}`,
                    `DESCRIPTION:${description}`,
                    'END:VEVENT'
                );
            });
            
            ics.push('END:VCALENDAR');
            
            const icsContent = ics.join('\r\n');
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'keimplan.ics';
            a.click();
            URL.revokeObjectURL(a.href);
        }
    </script>
</body>
</html>
